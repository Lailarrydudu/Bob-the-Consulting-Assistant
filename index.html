<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulting Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Import Georgia (Body) and Roboto Slab (Buttons) */
        @import url('https://fonts.googleapis.com/css2?family=Georgia:wght@400;700&family=Roboto+Slab:wght=700&display=swap');
        
        body {
            /* Main body and response content remains Georgia */
            font-family: 'Georgia', sans-serif;
            background-color: #111827; /* Tailwind gray-900 equivalent */
        }
        
        /* * Main Title: Smaller font, centered, bold. 
         * We'll use this for the H1 tag generated by Markdown's '#' 
         */
        .ai-response-content h1 {
            font-size: 1.8rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 1rem;
        }
        
        /* * Key Sections: Smaller font than the title, bold, no bullet point. 
         * We'll use this for the H2 tag generated by Markdown's '##' 
         */
        .ai-response-content h2 {
            font-size: 1.3rem;
            font-weight: 700;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            color: #bef264 !important;
        }
        
        /* * Sub-sections within a section. 
         * We'll use this for the H3 tag generated by Markdown's '###' 
         */
        .ai-response-content h3 {
            font-size: 1.1rem; /* Slightly smaller for better hierarchy */
            font-weight: 700;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            color: #facc15 !important;
        }
        
        /* * Points in Sections: Bold, smaller than sections, larger than content. 
         * Markdown wraps these in a `<strong>` tag. 
         */
        .ai-response-content strong {
            font-size: 1rem;
            font-weight: 700;
            display: block; 
            margin-bottom: 0.25rem; 
            color: #facc15 !important;
        }
        
        /* Ensure bulleted lists are styled correctly and have a top margin */
        .ai-response-content ul {
            list-style-type: disc;
            padding-left: 2rem;
            margin-top: 0.5rem; /* Reduced margin since the strong tag now has margin-bottom */
        }
        
        /* Add a bottom margin to each list item for more spacing */
        .ai-response-content li {
            margin-bottom: 1.0rem;
        }
        
        /* Basic table styling for clarity */
        .ai-response-content table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            font-size: 0.9rem;
        }
        
        .ai-response-content th, .ai-response-content td {
            border: 1px solid #d1d5db; /* Lighter border for contrast on dark background */
            padding: 0.75rem;
            text-align: left;
            width: 33%; 
        }
        
        .ai-response-content th {
            /* Darker table header background */
            background-color: #374151; /* Tailwind gray-700 equivalent */
            font-weight: 700;
            color: #f3f4f6;
        }
        
        .ai-response-content td {
            background-color: #1f2937; /* Tailwind gray-800 equivalent */
        }
        .main-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: #f3f4f6; /* Tailwind gray-100 equivalent */
        }
        
        .sub-title {
            font-size: 1.125rem;
            color: #d1d5db; /* Tailwind gray-300 equivalent */
            margin-top: 0.25rem;
        }
        
        /* === Custom Button Style (Main Dropdowns) === */
        .prompt-btn, .dropdown-btn {
            /* --- MODIFIED FONT FAMILY, SIZE, AND WEIGHT --- */
            font-family: 'Roboto Slab', serif; 
            font-size: 0.8125rem; 
            font-weight: 700; 
            /* ----------------------------------------------- */
            
            /* Base styles */
            padding-left: 0.75rem;
            padding-right: 0.75rem;
            padding-top: 0.5rem; 
            padding-bottom: 0.5rem; 
            color: #065f46; /* Text-emerald-800 */
            background-color: #ecfdf5; /* Bg-emerald-50 (light emerald) */
            border-radius: 0.75rem; /* Rounded-xl */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06); /* Shadow-lg */
            
            /* Border */
            border-width: 2px; 
            border-color: #34d399; /* Tailwind emerald-400 for better visibility */
            
            /* Sizing and alignment */
            width: 11rem; /* Fixed width for consistent size (w-44) */
            height: 3rem; /* Fixed height for consistent size (h-12) */
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            white-space: normal;
                        
            /* Hover and transition effects */
            transition: all 0.2s ease-in-out;
            
            /* Ensure dropdown buttons inherit base style but can be overridden */
            cursor: pointer;
        }

        .prompt-btn:hover, .dropdown-btn:hover {
            background-color: #d1fae5; /* Hover:bg-emerald-100 */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1); /* Hover:shadow-xl */
            transform: translateY(-2px); /* Subtle lift effect */
        }
        
        /* === Custom Button Style (Half-Height Utility Buttons) === */
        /* Implements the half-height and reduced font size for My Prompts, Generate Takeaways, and Clear Chat */
        .utility-btn {
            font-family: 'Roboto Slab', serif; 
            font-size: 0.75rem; /* Smaller font for half height */
            font-weight: 700;
            
            /* Fixed height to be exactly half of 3rem, and padding adjustments */
            height: 1.5rem; 
            padding-top: 0.25rem; 
            padding-bottom: 0.25rem; 
            
            /* Standard styles for consistency */
            border-radius: 0.5rem; /* Slightly less rounded */
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1); 
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            
            /* Ensure text is vertically centered */
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            white-space: nowrap; /* Prevent button text from wrapping in the small space */
        }
        
        .utility-btn:hover {
            transform: translateY(-1px); /* Subtle lift effect */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }

        .initial-greeting {
            font-size: 0.9rem; /* Reduced font size */
            padding-top: 0.5rem !important; /* Adjust padding if needed, or remove for default */
        }
        
        /* Added active state for a physical "press" effect */
        .prompt-btn:active, .dropdown-btn:active {
            border-color: #10b981; /* Tailwind emerald-600 */
            border-width: 3px; 
            transform: translateY(0); 
            box-shadow: none; 
        }
        /* === Custom Button Style (Sub-Menu Buttons) === */
        .sub-menu-btn {
            /* Define styles for individual, stacked buttons */
            background-color: #303030; /* Charcoal Grey */
            color: #f3f4f6; /* Tailwind gray-100 */
            width: 100%;
            text-align: left;
            padding: 0.5rem 1rem; /* py-2 px-4 */
            font-size: 0.875rem; /* text-sm */
            transition: all 0.15s ease-in-out;
            font-family: 'Georgia', sans-serif;
            cursor: pointer;
            
            /* Key changes for individual button look */
            border: 1px solid #d1d5db; /* Light Grey (Tailwind gray-300) */
            border-radius: 0.5rem; /* rounded-lg */
            margin-bottom: 0.25rem; /* space between buttons */
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
        }
        
        .sub-menu-btn:hover {
            background-color: #4a4a4a; /* Slightly lighter Charcoal hover */
            transform: scale(1.01);
        }
        /* Ensure the last button doesn't have extra margin at the bottom */
        .sub-menu-btn:last-child {
            margin-bottom: 0;
        }
        /* Custom styles for the dynamic textarea */
        #userInput {
            /* Set initial row size and ensure dynamic growth */
            line-height: 1.5; 
            overflow-y: hidden; /* Hide scrollbar unless max height is reached */
            box-sizing: border-box; /* Include padding and border in the element's total width and height */
            resize: none; /* Prevent manual resizing */
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4 bg-gray-900">
    <div class="bg-gray-800 text-gray-100 rounded-2xl shadow-xl w-full max-w-2xl p-6 md:p-8">
        <div class="flex items-center space-x-4 mb-6">
            <div class="p-3 bg-emerald-100 rounded-full">
                <svg xmlns="http://www.w3.org/2000/svg" fill="#10b981" viewBox="0 0 24 24" stroke-width="1.5" stroke="#10b981" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442c.499.04.701.663.321.988l-4.225 3.658a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.6l-4.725-2.885a.563.563 0 00-.582 0l-4.725 2.885a.562.562 0 01-.84-.6l1.285-5.385a.562.562 0 00-.182-.557L3.991 10.49a.562.562 0 01.32-.988l5.518-.442a.563.563 0 00.475-.345l2.125-5.111z" />
                </svg>
            </div>
            <div>
                <h1 class="main-title">Bob, Your Consulting Assistant</h1>
                <p class="sub-title">You ask. Bob answers.</p>
            </div>
        </div>
        
        <div class="mb-6">
            <label for="apiKeyInput" class="block text-sm font-medium text-gray-100 mb-1">Enter your Gemini API Key:</label>
            <input type="password" id="apiKeyInput" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-emerald-500 bg-gray-700 text-white" placeholder="Paste your API key here...">
        </div>
        
        <div class="flex justify-between mb-4 items-start">
            
            <div class="grid grid-cols-2 gap-4">
                
                <div class="flex flex-col gap-4">
                    <div class="relative">
                        <button id="initialSetupDropdownBtn" class="dropdown-btn flex items-center justify-center">
                            Initial Setup
                            <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div id="initialSetupMenu" class="absolute hidden top-full mt-2 w-56 bg-gray-800 rounded-lg shadow-2xl z-10 border border-emerald-500 p-2">
                            </div>
                    </div>
                    <div class="relative">
                        <button id="solutionDesignDropdownBtn" class="dropdown-btn flex items-center justify-center">
                            Solution Design
                            <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div id="solutionDesignMenu" class="absolute hidden top-full mt-2 w-56 bg-gray-800 rounded-lg shadow-2xl z-10 border border-emerald-500 p-2">
                            </div>
                    </div>
                </div>
                
                <div class="flex flex-col gap-4">
                    <div class="relative">
                        <button id="analysisDropdownBtn" class="dropdown-btn flex items-center justify-center">
                            Analysis
                            <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div id="analysisMenu" class="absolute hidden top-full mt-2 w-56 bg-gray-800 rounded-lg shadow-2xl z-10 border border-emerald-500 p-2">
                            </div>
                    </div>
                    <div class="relative">
                        <button id="executionDropdownBtn" class="dropdown-btn flex items-center justify-center">
                            Execution
                            <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div id="executionMenu" class="absolute hidden top-full mt-2 w-56 bg-gray-800 rounded-lg shadow-2xl z-10 border border-emerald-500 p-2">
                            </div>
                    </div>
                </div>
            </div> 

            <div class="flex flex-col justify-between w-44" style="height: 6.5rem;">
                
                <div class="relative w-full">
                    <button id="myPromptsDropdownBtn" class="utility-btn bg-blue-500 text-white hover:bg-blue-600 transition duration-200 w-full">
                        My Prompts
                        <svg class="w-3 h-3 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="myPromptsMenu" class="absolute hidden top-full mt-2 w-56 bg-gray-800 rounded-lg shadow-2xl z-10 border border-emerald-500 p-2">
                        </div>
                </div>

                <button id="summarizeThreadBtn" class="utility-btn bg-purple-600 text-white hover:bg-purple-700 transition duration-200 w-full">
                    Generate Takeaways
                </button>
                
                <button id="clearChatBtn" class="utility-btn bg-red-500 text-white hover:bg-red-600 transition duration-200 w-full">
                    Clear Chat
                </button>
            </div>
        </div>
        
        <div id="chatArea" class="space-y-4 max-h-96 overflow-y-auto mb-6 mt-8">
            
            <div class="flex justify-start">
                <div class="bg-gray-700 text-white p-3 rounded-tr-xl rounded-bl-xl rounded-br-xl max-w-lg shadow-lg initial-greeting">
                    <p>Hi there! I'm Bob. How can I assist you today?</p>
                </div>
            </div>

        </div>
        
        <div class="flex items-center space-x-2">
            <textarea id="userInput" placeholder="Ask a question... (Enter to Send, Shift + Enter for Newline)" rows="1" class="flex-grow px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-emerald-500 bg-gray-700 text-white resize-none overflow-y-hidden"></textarea>
            <button id="sendButton" class="px-6 py-2 bg-emerald-600 text-white font-semibold rounded-lg shadow-md hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 disabled:bg-emerald-300 disabled:cursor-not-allowed" >Send</button>
        </div>
    </div>
    
    <script>
        (function() {
            const apiKeyInput = document.getElementById('apiKeyInput');
            const sendButton = document.getElementById('sendButton');
            const userInput = document.getElementById('userInput');
            const chatArea = document.getElementById('chatArea');
            const clearChatBtn = document.getElementById('clearChatBtn');
            // DROPDOWN ELEMENTS
            const initialSetupDropdownBtn = document.getElementById('initialSetupDropdownBtn');
            const initialSetupMenu = document.getElementById('initialSetupMenu');
            const analysisDropdownBtn = document.getElementById('analysisDropdownBtn');
            const analysisMenu = document.getElementById('analysisMenu');
            const solutionDesignDropdownBtn = document.getElementById('solutionDesignDropdownBtn');
            const solutionDesignMenu = document.getElementById('solutionDesignMenu');
            const executionDropdownBtn = document.getElementById('executionDropdownBtn');
            const executionMenu = document.getElementById('executionMenu');
            // NEW PROMPT ELEMENTS
            const myPromptsDropdownBtn = document.getElementById('myPromptsDropdownBtn'); // NEW
            const myPromptsMenu = document.getElementById('myPromptsMenu'); // NEW
            // ADDED: NEW BUTTON CONSTANT
            const summarizeThreadBtn = document.getElementById('summarizeThreadBtn'); 
            let MIN_HEIGHT = 0; // Calculated minimum height (1 line)
            
            // --- PROMPT DEFINITIONS ---
            const PROMPT_MAP = {
                // Initial Setup (Phase I)
                'Industry Trends Snapshot': `Generate a **rapid, high-level Industry Trends Snapshot** for [input SPECIFIED INDUSTRY]. 

The output MUST strictly follow this high-readability structure:

# [Industry] Trends Snapshot
[concise, clear introductory explanation]

## Key Trend 1: [Trend Name]
* [concise, clear bullet point 1]
* [concise, clear bullet point 2]
* [concise, clear bullet point 3]

## Key Trend 2: [Trend Name]
* [concise, clear bullet point 1]
* [concise, clear bullet point 2]
* [concise, clear bullet point 3]
... (3 to 5 trends total)

## Summary Table
| Trend | Primary Impact |
|---|---|
| [Trend 1 Name] | * [Impact bullet 1] <br> * [Impact bullet 2] |
| [Trend 2 Name] | * [Impact bullet 1] <br> * [Impact bullet 2] |
| [Trend 3 Name] | * [Impact bullet 1] <br> * [Impact bullet 2] |
The table must be the last element of the response before the suggestions block.`,
                'Initial Project Charter Draft': `Generate an Initial Project Charter Draft for [input SPECIFIC PROJECT TYPE, e.g., 'implementing a new cloud-based CRM system for the sales department']. The output MUST strictly follow this professional structure:
# Project Charter: [Project Title]
[Short introductory summary of the project goal]

## Project Details
| Field | Value |
|---|---|
| Project Sponsor | [Placeholder Name/Title] |
| Project Manager | [Placeholder Name/Title] |
| Target Completion | [Date/Quarter] |

## Scope Overview
[1-2 paragraphs defining what is included (in scope) and what is explicitly excluded (out of scope).]

## Key Objectives
* [Measurable objective 1 (SMART)]
* [Measurable objective 2 (SMART)]
* [Measurable objective 3 (SMART)]

## Success Metrics (Key Performance Indicators)
* [Metric 1: Definition of success]
* [Metric 2: Definition of success]
* [Metric 3: Definition of success]

## High-Level Timeline (Phases)
* Phase 1: Initiation and Planning ([Duration])
* Phase 2: Execution and Development ([Duration])
* Phase 3: Deployment and Stabilization ([Duration])
The timeline must be the last element of the response before the suggestions block.`,
                'Problem Statement Draft': `Draft a Preliminary Problem Statement for [input SPECIFIC ISSUE, e.g., 'Customer retention has dropped by 10% in the last quarter']. The output MUST strictly follow the Current State, Desired State, Impact structure using Markdown headings and paragraphs:
# Preliminary Problem Statement
[A single introductory sentence about why this problem is critical.]

## 1. Current State (The Symptom)
[A concise paragraph describing the current measurable negative business symptom, its magnitude, and where it is occurring.]

## 2. Desired State (The Goal)
[A concise paragraph describing the measurable target outcome and the benefit of achieving it.]

## 3. Impact of Solving (The Value)
[A concise paragraph describing the strategic or financial value derived by the business upon successful achievement of the desired state.]
The "Impact of Solving" section must be the last element of the response before the suggestions block.`,
                // Analysis (Phase II)
                'Market Analysis': `Conduct a market analysis for [input SPECIFIC MARKET / INDUSTRY]. Focus on key trends, the competitive landscape, and the future outlook. The output MUST strictly follow this high-readability structure:
# [Analysis Title]
[concise, clear introductory explanation]

## Key Trends
* [concise, clear bullet point 1]
* [concise, clear bullet point 2]
* [concise, clear bullet point 3]

## Competitive Landscape
* **Key Player 1**: [Brief description of strategy/market share]
* **Key Player 2**: [Brief description of strategy/market share]
* **Key Player 3**: [Brief description of strategy/market share]

## Future Outlook and Threats
* [Threat/Opportunity 1]
* [Threat/Opportunity 2]
* [Threat/Opportunity 3]
The "Future Outlook and Threats" section must be the last element of the response before the suggestions block.`,
                'SWOT Analysis': `Perform a comprehensive SWOT analysis for [input SPECIFIC COMPANY OR PROJECT] focused on [input SPECIFIC BUSINESS AREA, e.g., 'their recent expansion into the European market']. The output MUST strictly follow this structure:
# SWOT Analysis: [Target]
[Short introductory sentence]

## Strengths (Internal/Positive)
* [Specific Strength 1]
* [Specific Strength 2]
* [Specific Strength 3]

## Weaknesses (Internal/Negative)
* [Specific Weakness 1]
* [Specific Weakness 2]
* [Specific Weakness 3]

## Opportunities (External/Positive)
* [Specific Opportunity 1]
* [Specific Opportunity 2]
* [Specific Opportunity 3]

## Threats (External/Negative)
* [Specific Threat 1]
* [Specific Threat 2]
* [Specific Threat 3]

## Strategic Implications Matrix
| Factor | Implication (1-2 sentences) |
|---|---|
| S-O (Max/Max) | [Strategy combining Strength and Opportunity] |
| W-O (Min/Max) | [Strategy mitigating Weakness to capture Opportunity] |
| S-T (Max/Min) | [Strategy using Strength to avoid Threat] |
| W-T (Min/Min) | [Strategy minimizing Weakness and avoiding Threat] |
The "Strategic Implications Matrix" must be the last element of the response before the suggestions block.`,
                'PESTEL Analysis': `Conduct a PESTEL analysis for [input SPECIFIC INDUSTRY OR REGION]. The output MUST strictly follow this high-readability structure:
# PESTEL Analysis: [Target]
[Short introductory sentence]

## Political Factors
* [Factor 1]
* [Factor 2]
* [Factor 3]

## Economic Factors
* [Factor 1]
* [Factor 2]
* [Factor 3]

## Sociocultural Factors
* [Factor 1]
* [Factor 2]
* [Factor 3]

## Technological Factors
* [Factor 1]
* [Factor 2]
* [Factor 3]

## Environmental Factors
* [Factor 1]
* [Factor 2]
* [Factor 3]

## Legal Factors
* [Factor 1]
* [Factor 2]
* [Factor 3]

## Key Implications Summary
| PESTEL Factor | Key Risk/Opportunity |
|---|---|
| Political | [Summary sentence] |
| Economic | [Summary sentence] |
| Sociocultural | [Summary sentence] |
| Technological | [Summary sentence] |
| Environmental | [Summary sentence] |
| Legal | [Summary sentence] |
The "Key Implications Summary" must be the last element of the response before the suggestions block.`,
                // Solution Design (Phase III)
                'Stakeholder Mapping': `Generate a comprehensive Stakeholder Map for a project involving [input SPECIFIC PROJECT, e.g., 'a company-wide digital transformation']. Identify key stakeholders, their power, interest, and management strategy. The output MUST strictly follow this table structure:
# Stakeholder Mapping: [Project Name]
[Short introductory sentence about the mapping goal]

## Stakeholder Matrix
| Stakeholder | Role / Department | Power (High/Low) | Interest (High/Low) | Management Strategy (Keep Informed / Manage Closely) |
|---|---|---|---|---|
| CEO | Executive Leadership | High | High | Manage Closely |
| IT Department | Technology Support | High | Low | Keep Satisfied |
| Sales Team | End-User Group | Low | High | Keep Informed |
| ... (at least 5 key stakeholders) | | | | |

## Communication Plan Draft
* **High Power / High Interest (Manage Closely):** [Communication frequency/method]
* **High Power / Low Interest (Keep Satisfied):** [Communication frequency/method]
* **Low Power / High Interest (Keep Informed):** [Communication frequency/method]
* **Low Power / Low Interest (Minimum Effort):** [Communication frequency/method]
The "Communication Plan Draft" must be the last element of the response before the suggestions block.`,
                'High-Level Requirements Document (HLRD)': `Draft a High-Level Requirements Document (HLRD) for a new system/solution designed to [input SPECIFIC BUSINESS GOAL, e.g., 'automate inventory tracking']. The output MUST strictly follow this structure:
# High-Level Requirements Document: [Solution Name]
[Short introductory summary of the proposed solution and its primary objective.]

## 1. Functional Requirements (What the System MUST Do)
* **FR 1.0:** [Core action/functionality, e.g., 'The system must allow users to scan barcodes for inventory check-in.']
* **FR 2.0:** [Core action/functionality]
* **FR 3.0:** [Core action/functionality]

## 2. Non-Functional Requirements (How the System MUST Be)
* **Performance:** [Requirement, e.g., 'The system must handle 50 concurrent users without latency exceeding 2 seconds.']
* **Security:** [Requirement, e.g., 'All user data must be encrypted in transit and at rest.']
* **Usability:** [Requirement, e.g., 'The user interface must be intuitive and require minimal training.']
The "Non-Functional Requirements" section must be the last element of the response before the suggestions block.`,
                'Risk Assessment Matrix': `Generate a comprehensive Risk Assessment Matrix for a project involving [input SPECIFIC PROJECT, e.g., 'the rollout of a new corporate policy']. The output MUST strictly follow this table structure:
# Risk Assessment Matrix: [Project Name]
[Short introductory sentence about the risk assessment]

## Risk Matrix
| Risk ID | Risk Description | Probability (High/Med/Low) | Impact (High/Med/Low) | Mitigation Strategy (1-2 sentences) | Owner |
|---|---|---|---|---|---|
| R01 | [Specific Risk, e.g., 'Key project team member leaving unexpectedly.'] | Medium | High | [Strategy to reduce probability or impact] | [Name/Role] |
| R02 | [Specific Risk] | | | | |
| R03 | [Specific Risk] | | | | |
| ... (at least 5 key risks) | | | | | |

## Top 3 Priority Risks
* [Risk ID, Description, and brief rationale for priority]
* [Risk ID, Description, and brief rationale for priority]
* [Risk ID, Description, and brief rationale for priority]
The "Top 3 Priority Risks" section must be the last element of the response before the suggestions block.`,
                // Execution (Phase IV)
                'Work Breakdown Structure (WBS)': `Generate a high-level Work Breakdown Structure (WBS) for [input SPECIFIC PROJECT, e.g., 'launching a new product line']. The output MUST strictly follow this hierarchical structure, using bold text for level 1:
# Work Breakdown Structure: [Project Name]
[Short introductory sentence defining the WBS structure.]

## **Level 1: Project Phase**
* **Level 2: Major Deliverable**
    * Level 3: Sub-Task
    * Level 3: Sub-Task
* **Level 2: Major Deliverable**
    * Level 3: Sub-Task

## Example Output Structure (3 Levels Deep):
* **1.0 Planning & Initiation**
    * **1.1 Define Scope**
        * 1.1.1 Hold kickoff meeting
        * 1.1.2 Finalize charter
    * **1.2 Resource Allocation**
        * 1.2.1 Assign roles
        * 1.2.2 Secure budget
* **2.0 Development & Testing**
    * **2.1 Core System Build**
        * 2.1.1 Code module A
        * 2.1.2 Code module B
* **3.0 Deployment & Closeout**
    * **3.1 User Training**
The example must be the last element of the response before the suggestions block.`,
                'Status Report Draft': `Draft a Weekly Project Status Report for [input SPECIFIC PROJECT NAME]. The report MUST strictly follow this concise, action-oriented structure:
# Weekly Status Report: [Project Name]
[Date Range]

## 1. Overall Status: [Green/Yellow/Red]
[A single, concise sentence explaining the status.]

## 2. Key Accomplishments (Last Week)
* [Accomplishment 1]
* [Accomplishment 2]
* [Accomplishment 3]

## 3. Planned Activities (Next Week)
* [Activity 1]
* [Activity 2]
* [Activity 3]

## 4. Key Risks & Issues (Needs Help)
| Item | Severity (High/Med/Low) | Mitigation/Resolution Status | Owner |
|---|---|---|---|
| [Specific Issue/Risk] | [Severity] | [Action needed or taken] | [Owner Name/Role] |
| [Specific Issue/Risk] | [Severity] | [Action needed or taken] | [Owner Name/Role] |
The "Key Risks & Issues" table must be the last element of the response before the suggestions block.`,
                'Change Request Draft (CR)': `Draft a Preliminary Change Request (CR) for a proposed modification to [input SPECIFIC PROJECT/SYSTEM]. The proposed change is [input BRIEF DESCRIPTION OF CHANGE, e.g., 'to add a new reporting dashboard for finance']. The output MUST strictly follow this structure:
# Change Request (CR) Draft: [CR Title]
[Short introductory summary of the change.]

## 1. Problem Statement / Justification
[1-2 paragraphs detailing why the change is necessary and the business problem it solves.]

## 2. Proposed Change Details
* **Description:** [Detailed description of what will be modified or added.]
* **Impacted Areas:** [List of systems, teams, or processes affected.]

## 3. Estimated Impact (Resources)
| Factor | Estimate | Justification |
|---|---|---|
| Effort (Mandays) | [Number] | [Rationale] |
| Cost (USD) | [Amount] | [Rationale] |
| Schedule Impact | [Days/Weeks Added] | [Rationale] |

## 4. Acceptance Criteria
* [Criteria 1: The system must successfully do X.]
* [Criteria 2: The system must successfully do Y.]
The "Acceptance Criteria" section must be the last element of the response before the suggestions block.`,
            };
            
            // --- DROPDOWN POPULATION ---
            function populateDropdowns() {
                const menuMap = {
                    initialSetupMenu: ['Industry Trends Snapshot', 'Initial Project Charter Draft', 'Problem Statement Draft'],
                    analysisMenu: ['Market Analysis', 'SWOT Analysis', 'PESTEL Analysis'],
                    solutionDesignMenu: ['Stakeholder Mapping', 'High-Level Requirements Document (HLRD)', 'Risk Assessment Matrix'],
                    executionMenu: ['Work Breakdown Structure (WBS)', 'Status Report Draft', 'Change Request Draft (CR)'],
                    myPromptsMenu: [/* This is intentionally empty for the user to populate */]
                };
                
                for (const menuId in menuMap) {
                    const menu = document.getElementById(menuId);
                    if (menu) {
                        menu.innerHTML = ''; // Clear previous contents
                        menuMap[menuId].forEach(promptName => {
                            const button = document.createElement('button');
                            button.textContent = promptName;
                            button.className = 'sub-menu-btn'; // Use the custom sub-menu button class
                            button.setAttribute('data-prompt-name', promptName);
                            button.addEventListener('click', (e) => {
                                e.stopPropagation(); // Stop click from propagating to document
                                const promptTemplate = PROMPT_MAP[promptName];
                                
                                // Insert the placeholder text into the input field
                                userInput.value = promptTemplate;
                                
                                // Manually resize the textarea to fit the new content
                                autoResizeTextarea(userInput);
                                
                                // Hide all menus after selection
                                closeAllMenus();
                            });
                            menu.appendChild(button);
                        });
                    }
                }
            }
            // --- END DROPDOWN POPULATION ---


            // --- UTILITY FUNCTIONS ---
            function addMessageToChat(content, sender, isHidden = false) {
                // ... (rest of addMessageToChat remains the same)
                const messageDiv = document.createElement('div');
                messageDiv.className = `flex ${sender === 'user' ? 'justify-end user-message' : 'justify-start ai-message'}`;
                
                const contentDiv = document.createElement('div');
                contentDiv.className = `${sender === 'user' ? 'bg-emerald-600 text-white user-input' : 'bg-gray-700 text-gray-100 ai-response-content'} rounded-xl p-3 max-w-sm shadow-md`;
                
                if (sender === 'user') {
                    contentDiv.textContent = content;
                } else {
                    // Use the placeholder for the response content (will be streamed later)
                    contentDiv.innerHTML = isHidden ? '<div id="responsePlaceholder"></div>' : '<div class="typing-indicator"></div>';
                }
                
                messageDiv.appendChild(contentDiv);
                chatArea.appendChild(messageDiv);
                
                // Scroll to the bottom
                chatArea.scrollTop = chatArea.scrollHeight;
                
                // Return the placeholder for the AI response
                return sender === 'ai' ? contentDiv.querySelector('#responsePlaceholder') : null;
            }

            function closeAllMenus() {
                const menus = [initialSetupMenu, analysisMenu, solutionDesignMenu, executionMenu, myPromptsMenu]; 
                menus.forEach(menu => menu.classList.add('hidden'));
            }

            function toggleMenu(menuElement, buttonElement) {
                const isHidden = menuElement.classList.contains('hidden');
                
                // Close all other menus first
                closeAllMenus();
                
                // Toggle the current menu
                if (isHidden) {
                    menuElement.classList.remove('hidden');
                } else {
                    menuElement.classList.add('hidden');
                }
            }

            // Function for the dynamic resizing of the textarea
            function autoResizeTextarea(element) {
                if (MIN_HEIGHT === 0) {
                    // Calculate and store MIN_HEIGHT (height of 1 row) on first run
                    element.rows = 1; // Start with one row to measure
                    MIN_HEIGHT = element.scrollHeight;
                }
                
                // Reset the rows to 1 (or min-height) before calculating the new height
                element.style.height = 'auto';
                
                // Set the new height based on scrollHeight, ensuring it's never less than MIN_HEIGHT
                element.style.height = (element.scrollHeight > MIN_HEIGHT ? element.scrollHeight : MIN_HEIGHT) + 'px';
            }
            
            // --- LOADING AND STATE MANAGEMENT ---
            function setLoadingState(isLoading) {
                const finishLoadingState = () => {
                    sendButton.disabled = false;
                    sendButton.textContent = 'Send';
                    apiKeyInput.disabled = false;
                    userInput.disabled = false;
                    
                    // ADDED: Re-enable Summarize Button
                    summarizeThreadBtn.disabled = false;
                    summarizeThreadBtn.textContent = 'Generate Takeaways'; 
                    
                    initialSetupDropdownBtn.disabled = false;
                    analysisDropdownBtn.disabled = false;
                    solutionDesignDropdownBtn.disabled = false;
                    executionDropdownBtn.disabled = false;
                    myPromptsDropdownBtn.disabled = false; 
                    clearChatBtn.disabled = false; 
                };

                if (isLoading) {
                    sendButton.disabled = true;
                    sendButton.textContent = 'Thinking...';
                    apiKeyInput.disabled = true;
                    userInput.disabled = true;
                    
                    // ADDED: Disable Summarize Button
                    summarizeThreadBtn.disabled = true; 
                    
                    initialSetupDropdownBtn.disabled = true;
                    analysisDropdownBtn.disabled = true;
                    solutionDesignDropdownBtn.disabled = true;
                    executionDropdownBtn.disabled = true;
                    myPromptsDropdownBtn.disabled = true;
                    clearChatBtn.disabled = true;
                } else {
                    // This function should be called when streaming completes or an error occurs
                    finishLoadingState();
                }
            }
            
            // --- API COMMUNICATION ---
            async function sendPrompt(prompt) {
                const apiKey = apiKeyInput.value.trim();
                
                if (!apiKey) {
                    alert("Please enter your Gemini API Key first.");
                    setLoadingState(false);
                    return;
                }

                // Add user message to chat area
                const userMessageDiv = addMessageToChat(prompt, 'user');
                // Add AI placeholder message to chat area and get the element reference
                const aiPlaceholder = addMessageToChat('', 'ai', true);
                
                setLoadingState(true);

                // Initialize the Gemini client (replace with your actual API endpoint logic)
                // Since this is a self-contained HTML file, we'll simulate the API call structure.
                
                try {
                    // === PLACEHOLDER FOR ACTUAL API CALL ===
                    // In a real implementation, you would use a backend or a CORS-enabled endpoint here.
                    // Example Fetch structure (Commented out, as it requires a real endpoint):
                    /*
                    const response = await fetch('YOUR_BACKEND_API_ENDPOINT', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-API-Key': apiKey 
                        },
                        body: JSON.stringify({
                            prompt: prompt,
                            // Optionally send chat history for context (if not included in the meta-prompt already)
                            history: [] 
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`API Error: ${response.statusText}`);
                    }
                    
                    // Simulate streaming the response
                    const reader = response.body.getReader();
                    let responseText = '';
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        const chunk = new TextDecoder().decode(value);
                        responseText += chunk;
                        
                        // Update the placeholder with streamed content
                        aiPlaceholder.innerHTML = marked.parse(responseText);
                        chatArea.scrollTop = chatArea.scrollHeight;
                    }
                    */

                    // --- MOCKING API RESPONSE FOR FUNCTIONALITY TESTING ---
                    const mockResponse = "### Generating Summary...\n\nDue to the security restrictions of this environment, the actual API call cannot be executed. However, if this were running on your server, Bob would now perform the following:\n\n1.  **Read History**: Retrieve the entire conversation.\n2.  **Send Prompt**: Send the history along with the meta-prompt for summary generation to the Gemini API.\n3.  **Stream Result**: Stream the following content:\n\n# Engagement Summary\n\n## Top 5 Key Findings/Insights\n\n* **Finding 1**: The current thread established a clear Problem Statement focusing on customer retention.\n* **Finding 2**: A comprehensive PESTEL analysis was performed on the [Industry/Region].\n* **Finding 3**: Risk R03 (System Integration) was identified as a High-Impact, Medium-Probability threat.\n* **Finding 4**: The proposed solution is a cloud-based CRM system.\n* **Finding 5**: Stakeholder Mapping successfully identified the CEO and Sales Team as High-Priority.\n\n## Next 3 Recommended Actions\n\n1.  **Finalize HLRD**: Complete the outstanding Non-Functional Requirements section for the CRM.\n2.  **Mitigation Plan**: Immediately assign an owner and timeline for mitigating Risk R01 (Key Staff Departure).\n3.  **WBS Detailing**: Decompose the 'Development & Testing' WBS phase into detailed tasks.\n\n## Open Questions\n\n* Is the current budget sufficient for the estimated cost of the change request (CR)?\n* Has a specific target date been set for the 'Deployment and Stabilization' phase?";
                    
                    // Simulate a delay for the "Thinking..." state
                    await new Promise(resolve => setTimeout(resolve, 1500));
                    
                    // Write the mock response
                    aiPlaceholder.innerHTML = marked.parse(mockResponse);
                    
                    // --- END MOCKING ---
                    
                } catch (error) {
                    aiPlaceholder.innerHTML = `<span class="text-red-400">Error: Failed to get response. Please check your API key or network connection. Details: ${error.message}</span>`;
                }
                
                setLoadingState(false);
                chatArea.scrollTop = chatArea.scrollHeight;
            }
            
            // --- NEW: FUNCTION TO RETRIEVE HISTORY ---
            function retrieveFullHistory() {
                const chatHistoryContainer = document.getElementById('chatArea');
                // Select all message containers, skipping the initial welcome message
                const messages = Array.from(chatHistoryContainer.children).slice(1);
                
                let fullHistory = "CONSULTING CONVERSATION HISTORY (for summary generation):\n---\n";

                messages.forEach(messageDiv => {
                    // Only process user or AI messages
                    if (messageDiv.classList.contains('user-message') || messageDiv.classList.contains('ai-message')) {
                        const sender = messageDiv.classList.contains('user-message') ? "USER" : "AI";
                        const contentElement = messageDiv.querySelector('.ai-response-content, .user-input');
                        
                        if (contentElement) {
                             // Use innerText to preserve line breaks and list structure from rendered content
                            const content = contentElement.innerText.trim();
                            
                            // Prevent including the "Generate Takeaways" click itself in the history sent to the API
                            if (content && content !== "Generate Takeaways") {
                                fullHistory += `${sender}:\n${content}\n--\n`;
                            }
                        }
                    }
                });
                
                fullHistory += "---\nEND OF HISTORY.\n";
                return fullHistory;
            }
            // --- END NEW FUNCTION ---
            
            // --- EVENT LISTENERS ---
            
            // ADDED: NEW EVENT LISTENER FOR SUMMARIZE BUTTON
            summarizeThreadBtn.addEventListener('click', async () => {
                // 1. Check if chat has enough content (excluding the initial welcome message, which is the only child at index 0)
                if (document.getElementById('chatArea').children.length <= 1) {
                    alert("Chat is empty. Start a conversation first!");
                    return;
                }
                
                // 2. Get the history and craft the meta-prompt
                const chatHistory = retrieveFullHistory();
                
                // The meta-prompt ensures the model returns a structured, consulting-focused summary.
                const metaPrompt = 
                    "Review the complete consulting thread provided below. Based *only* on the information in the thread, format a final, actionable summary. Title the response 'Engagement Summary' using an H1 tag. Include: 1. **Top 5 Key Findings/Insights** (in bullet points). 2. **Next 3 Recommended Actions** (in a numbered list). 3. **Open Questions** for the client (if applicable). Use clear, professional, markdown formatting.\n\n" + chatHistory;
                
                // 3. Call the main sendPrompt function directly with the programmatic prompt
                try {
                    await sendPrompt(metaPrompt);
                } catch (error) {
                    console.error("Error during summary generation:", error);
                    // The error handling inside sendPrompt will call setLoadingState(false)
                }
            });


            sendButton.addEventListener('click', () => {
                const prompt = userInput.value.trim();
                if (prompt && !sendButton.disabled) {
                    sendPrompt(prompt);
                    userInput.value = ''; // Clear input field
                    autoResizeTextarea(userInput); // Reset textarea size
                }
            });

            userInput.addEventListener('keypress', (e) => {
                // Check if Enter key is pressed without the Shift key
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault(); // Prevent newline in textarea
                    sendButton.click(); // Trigger the send button logic
                }
            });

            userInput.addEventListener('input', () => {
                autoResizeTextarea(userInput);
            });
            
            clearChatBtn.addEventListener('click', () => {
                if (confirm('Are you sure you want to clear the entire chat history?')) {
                    chatArea.innerHTML = `
                        <div class="flex justify-start">
                            <div class="bg-emerald-100 text-emerald-700 rounded-xl p-3 max-w-sm shadow-md">
                                Hi there! I'm Bob. How can I assist you today?
                            </div>
                        </div>
                    `;
                }
            });

            // Dropdown button listeners
            initialSetupDropdownBtn.addEventListener('click', (e) => {
                e.stopPropagation(); 
                toggleMenu(initialSetupMenu, initialSetupDropdownBtn);
            });
            analysisDropdownBtn.addEventListener('click', (e) => {
                e.stopPropagation(); 
                toggleMenu(analysisMenu, analysisDropdownBtn);
            });
            solutionDesignDropdownBtn.addEventListener('click', (e) => {
                e.stopPropagation(); 
                toggleMenu(solutionDesignMenu, solutionDesignDropdownBtn);
            });
            executionDropdownBtn.addEventListener('click', (e) => {
                e.stopPropagation(); 
                toggleMenu(executionMenu, executionDropdownBtn);
            });
            // NEW: Listener for My Prompts
            myPromptsDropdownBtn.addEventListener('click', (e) => { 
                e.stopPropagation(); 
                toggleMenu(myPromptsMenu, myPromptsDropdownBtn);
            });
            
            // Listener to close menus when clicking anywhere else on the document (UPDATED)
            document.addEventListener('click', (e) => {
                const menus = [initialSetupMenu, analysisMenu, solutionDesignMenu, executionMenu, myPromptsMenu]; 
                
                let clickedInsideMenu = false;
                for (const menu of menus) {
                    if (menu.contains(e.target)) {
                        clickedInsideMenu = true;
                        break;
                    }
                }
                if (!clickedInsideMenu) {
                    // If the click was not inside any menu, hide all menus
                    menus.forEach(menu => menu.classList.add('hidden'));
                }
            });

            // Initial setup calls
            populateDropdowns();
            autoResizeTextarea(userInput); // Initialize textarea height
        })(); // End of IIFE
    </script>
</body>
</html>
