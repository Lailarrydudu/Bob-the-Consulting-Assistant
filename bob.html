<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulting Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PDF.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Georgia:wght@400;700&family=Roboto+Slab:wght=700&display=swap');
        
        body {
            font-family: 'Georgia', sans-serif;
            background-color: #111827; /* Gray 900 */
            color: #f3f4f6;
            height: 100vh;
            overflow: hidden; /* Prevent body scroll, handle inside containers */
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        /* Typography for AI Responses */
        .ai-response-content h1 { font-size: 1.5rem; font-weight: 700; margin-bottom: 0.75rem; color: #bef264; }
        .ai-response-content h2 { font-size: 1.25rem; font-weight: 700; margin-top: 1rem; margin-bottom: 0.5rem; color: #bef264; }
        .ai-response-content h3 { font-size: 1.1rem; font-weight: 700; margin-top: 0.75rem; color: #facc15; }
        .ai-response-content ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 0.75rem; }
        .ai-response-content li { margin-bottom: 0.25rem; }
        .ai-response-content strong { color: #facc15; }
        
        /* Table Styling */
        .ai-response-content table { width: 100%; border-collapse: collapse; margin-top: 0.5rem; font-size: 0.9rem; }
        .ai-response-content th, .ai-response-content td { border: 1px solid #4b5563; padding: 0.5rem; text-align: left; }
        .ai-response-content th { background-color: #374151; color: #f3f4f6; }
        .ai-response-content td { background-color: #1f2937; }

        /* Sidebar Buttons */
        .sidebar-btn {
            font-family: 'Roboto Slab', serif;
            width: 100%;
            text-align: left;
            padding: 0.75rem 1rem;
            background-color: #1f2937; /* Gray 800 */
            border: 1px solid #374151;
            border-radius: 0.5rem;
            color: #e5e7eb;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .sidebar-btn:hover { background-color: #374151; border-color: #10b981; }
        
        /* Submenu styling in sidebar */
        .sidebar-menu {
            background-color: #111827;
            border: 1px solid #374151;
            border-radius: 0.5rem;
            margin-top: 0.25rem;
            overflow: hidden;
        }
        .sub-menu-btn {
            display: block;
            width: 100%;
            text-align: left;
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
            color: #9ca3af;
            transition: color 0.2s, background-color 0.2s;
        }
        .sub-menu-btn:hover { color: #10b981; background-color: #1f2937; }

        /* Utility Buttons (Right Side) - Updated */
        .utility-btn {
            width: 100%;
            height: 42px; /* Fixed height for uniformity */
            padding: 0 1rem;
            background-color: #4b5563;
            color: white;
            border-radius: 0.5rem;
            font-weight: bold;
            font-size: 0.85rem;
            margin-bottom: 0.75rem;
            transition: all 0.2s;
            /* Centering Logic */
            display: flex; 
            justify-content: center; 
            align-items: center;
            position: relative; 
        }
        .utility-btn:hover { background-color: #6b7280; }
        
        /* Force the arrow icon to the far right so text stays centered */
        .utility-btn svg {
            position: absolute;
            right: 12px;
        }

        /* User Message Actions (Copy/Edit) */
        .message-wrapper:hover .user-action-container {
            opacity: 1;
        }
        
        .user-action-container {
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
            display: flex;
            gap: 0.5rem;
            align-items: center;
            margin-right: 0.75rem;
        }
        
        .action-icon-btn {
            padding: 6px;
            border-radius: 50%;
            color: #9ca3af; /* Gray-400 */
            background-color: #1f2937; /* Dark background */
            border: 1px solid #374151;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .action-icon-btn:hover {
            color: #f3f4f6;
            background-color: #374151;
            border-color: #10b981; /* Emerald border */
        }
        
        /* Input Area Styling */
        #userInput {
            line-height: 1.5;
            resize: none; 
            max-height: 150px;
        }
    /* === CITATION STYLES === */
        .citation-link {
            display: inline-block;
            vertical-align: middle;
            margin-left: 2px;
            background-color: #374151;
            border-radius: 50%;
            padding: 2px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .citation-link:hover { background-color: #4b5563; }
        .citation-link svg { width: 14px; height: 14px; color: #9ca3af; }

        .sources-section {
            margin-top: 1rem;
            border-top: 1px solid #374151;
            padding-top: 0.75rem;
        }

        .sources-toggle-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background-color: transparent;
            border: 1px solid #6b7280;
            color: #d1d5db;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            transition: all 0.2s;
        }
        .sources-toggle-btn:hover { background-color: #374151; border-color: #9ca3af; }

        .sources-list {
            margin-top: 0.75rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .source-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
            color: #93c5fd;
            text-decoration: none;
            padding: 0.25rem;
            border-radius: 0.25rem;
        }
        .source-item:hover { background-color: #1f2937; text-decoration: underline; }
        .source-favicon { width: 16px; height: 16px; background-color: #fff; border-radius: 2px; }
    </style>
</head>
<body class="flex h-screen w-full bg-gray-900">

    <!-- LEFT SIDEBAR (Phases) -->
    <aside class="w-64 bg-gray-800 border-r border-gray-700 flex flex-col flex-shrink-0 z-20">
       <!-- Logo Area -->
        <div class="p-6 border-b border-gray-700 flex items-center gap-3">
            <div class="p-1.5 bg-white rounded-full border-2 border-green-700 flex-shrink-0">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" width="28" height="28">
                    <circle cx="50" cy="50" r="8" fill="none" stroke="#4a5d3e" stroke-width="4"/>
                    <g stroke="#4a5d3e" stroke-width="3" fill="none">
                        <line x1="50" y1="50" x2="50" y2="20"/><circle cx="50" cy="20" r="6"/>
                        <line x1="50" y1="50" x2="75" y2="30"/><circle cx="75" cy="30" r="6"/>
                        <line x1="50" y1="50" x2="75" y2="70"/><circle cx="75" cy="70" r="6"/>
                        <line x1="50" y1="50" x2="50" y2="80"/><circle cx="50" cy="80" r="6"/>
                        <line x1="50" y1="50" x2="25" y2="70"/><circle cx="25" cy="70" r="6"/>
                        <line x1="50" y1="50" x2="25" y2="30"/><circle cx="25" cy="30" r="6"/>
                    </g>
                </svg>
            </div>
            <h1 class="font-bold text-lg text-white tracking-wide">Bob Assistant</h1>
        </div>

        <!-- PROJECT CONTROLS (Always Visible) -->
        <div class="p-4 border-b border-gray-700 space-y-2">
            <button id="newProjectBtn" class="w-full py-2 px-3 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg font-bold text-sm transition flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                New Project
            </button>
            <button id="loadProjectBtn" class="w-full py-2 px-3 bg-gray-700 hover:bg-gray-600 text-gray-200 rounded-lg font-bold text-sm transition flex items-center justify-center gap-2 border border-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.75V12A2.25 2.25 0 014.5 9.75h15A2.25 2.25 0 0121.75 12v.75m-8.69-6.44l-2.12-2.12a1.5 1.5 0 00-1.061-.44H4.5A2.25 2.25 0 002.25 6v12a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9a2.25 2.25 0 00-2.25-2.25h-5.379a1.5 1.5 0 01-1.06-.44z" /></svg>
                Load Project
            </button>
        </div>

        <!-- PHASE MENUS (Hidden by default) -->
        <div id="phaseMenuContainer" class="hidden flex-1 overflow-y-auto p-4 space-y-4 opacity-50 transition-opacity duration-500">
            
            <div class="text-xs text-gray-500 font-bold uppercase tracking-widest mb-2">Project Phases</div>

            <!-- Phase 1 -->
            <div>
                <button id="initialSetupDropdownBtn" class="sidebar-btn">
                    Initial Setup
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>
                <div id="initialSetupMenu" class="sidebar-menu hidden"></div>
            </div>

            <!-- Phase 2 -->
            <div>
                <button id="analysisDropdownBtn" class="sidebar-btn">
                    Analysis
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>
                <div id="analysisMenu" class="sidebar-menu hidden"></div>
            </div>

            <!-- Phase 3 -->
            <div>
                <button id="solutionDesignDropdownBtn" class="sidebar-btn">
                    Solution Design
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>
                <div id="solutionDesignMenu" class="sidebar-menu hidden"></div>
            </div>

            <!-- Phase 4 -->
            <div>
                <button id="executionDropdownBtn" class="sidebar-btn">
                    Execution
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>
                <div id="executionMenu" class="sidebar-menu hidden"></div>
            </div>
            
            <!-- Current Project Indicator -->
            <div id="currentProjectBadge" class="mt-6 p-3 bg-gray-900 rounded border border-gray-700 text-center hidden">
                <div class="text-xs text-gray-500">Active Project</div>
                <div id="currentProjectNameDisplay" class="text-sm font-bold text-emerald-400 truncate"></div>
            </div>

        </div>
    </aside>

    <!-- CENTER CHAT AREA -->
    <main class="flex-1 flex flex-col relative bg-gray-900">
        
        <!-- Chat History Container (The "Grey Box") -->
        <div id="chatArea" class="flex-1 overflow-y-auto p-8 space-y-6">
            <!-- Messages will be injected here -->
        </div>

        <!-- HERO TEXT (Initially Visible, Hides on Chat) -->
        <div id="heroText" class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none z-0">
            <h2 class="text-4xl font-bold text-gray-200 tracking-tight drop-shadow-lg">Should we start building?</h2>
            <p class="text-gray-500 mt-2">Select a project from the left or type below.</p>
        </div>

        <!-- Input Area (Fixed Bottom) -->
        <div class="p-6 bg-gray-900 z-10">
            <div class="max-w-4xl mx-auto relative flex items-end gap-2 bg-[#2f2f2f] p-2 rounded-[2rem] border border-gray-700 shadow-xl focus-within:border-emerald-500 focus-within:ring-1 focus-within:ring-emerald-500 transition-all">
                
                <!-- Hidden File Input -->
                <input type="file" id="hiddenFileInput" style="display: none;" accept=".txt,.md,.csv,.json,.js,.html,.css,.xml,.pdf">
                
                <!-- Attachment Button -->
                <button id="attachBtn" class="p-3 text-gray-400 hover:text-white transition-colors rounded-full hover:bg-gray-700 flex-shrink-0" title="Attach file">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M18.375 12.739l-7.693 7.693a4.5 4.5 0 01-6.364-6.364l10.94-10.94A3 3 0 1119.5 7.372L8.552 18.32m.009-.01l-.01.01m5.699-9.941l-7.81 7.81a1.5 1.5 0 002.112 2.13" />
                    </svg>
                </button>

                <!-- Text Area -->
                <textarea id="userInput" 
                    placeholder="Ask a question..." 
                    rows="1" 
                    class="w-full bg-transparent text-gray-100 placeholder-gray-500 border-none focus:ring-0 resize-none overflow-y-hidden py-3 text-base leading-relaxed max-h-32"
                    style="min-height: 48px;"></textarea>

                <!-- Send Button -->
                <button id="sendButton" class="p-3 bg-emerald-600 text-white rounded-full hover:bg-emerald-500 transition-transform transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed shadow-lg flex-shrink-0 mb-0.5">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 10.5L12 3m0 0l7.5 7.5M12 3v18" />
                    </svg>
                </button>
            </div>
            <p class="text-center text-xs text-gray-500 mt-2">Bob can make mistakes. Verify important information.</p>
        </div>
    </main>

    <!-- RIGHT SIDEBAR (Utilities) -->
    <aside class="w-64 bg-gray-800 border-l border-gray-700 flex flex-col flex-shrink-0 z-20 p-4">
        
        <!-- WRAPPER FOR TOGGLING VISIBILITY -->
        <div id="toolsMenuContainer" class="hidden w-full h-full flex flex-col">
            
            <h3 class="text-gray-400 text-xs font-bold uppercase tracking-wider mb-4 text-center">Tools</h3>
            
            <!-- My Prompts -->
            <div class="relative mb-0"> 
                <button id="myPromptsDropdownBtn" class="utility-btn">
                    My Prompts
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>
                <div id="myPromptsMenu" class="absolute hidden top-full left-0 w-full bg-gray-700 rounded-lg shadow-xl z-30 border border-gray-600 p-2 mt-1"></div>
            </div>

            <!-- Takeaways -->
            <button id="generateTakeawaysBtn" class="utility-btn">Generate Takeaways</button>

            <!-- Workflow -->
            <div class="relative mb-0">
                <button id="workflowBtn" class="utility-btn">
                    Run Workflow
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>
                <div id="workflowMenu" class="absolute hidden top-full right-0 w-64 bg-gray-700 rounded-lg shadow-xl z-30 border border-gray-600 p-2 mt-1">
                    <button class="workflow-option w-full text-left px-3 py-2 text-sm text-gray-200 hover:bg-gray-600 rounded" data-workflow="market-entry-strategy">Market Entry Strategy</button>
                    <button class="workflow-option w-full text-left px-3 py-2 text-sm text-gray-200 hover:bg-gray-600 rounded" data-workflow="business-health-check">Business Health Check</button>
                    <button class="workflow-option w-full text-left px-3 py-2 text-sm text-gray-200 hover:bg-gray-600 rounded" data-workflow="competitive-analysis">Competitive Analysis</button>
                </div>
            </div>

            <!-- Export -->
            <button id="exportBtn" class="utility-btn">Export Chat</button>

            <div class="flex-grow"></div> <!-- Spacer -->

            <!-- Clear Chat -->
            <button id="clearChatBtn" class="w-full px-4 py-2 border border-red-500 text-red-400 rounded-lg hover:bg-red-900/20 transition text-sm font-bold flex justify-center items-center">
                Clear Chat
            </button>
        </div>
        
        <!-- Placeholder when no project selected -->
        <div id="noProjectToolState" class="flex-1 flex items-center justify-center text-center text-gray-600 text-sm p-4">
            Select a project to access tools
        </div>

    </aside>
    <script>
        (function() {
            // ELEMENT REFERENCES
            const sendButton = document.getElementById('sendButton');
            const userInput = document.getElementById('userInput');
            const chatArea = document.getElementById('chatArea');
            const heroText = document.getElementById('heroText'); // The "Should we start..." text
            const clearChatBtn = document.getElementById('clearChatBtn');
            const generateTakeawaysBtn = document.getElementById('generateTakeawaysBtn');
            const attachBtn = document.getElementById('attachBtn');
            const hiddenFileInput = document.getElementById('hiddenFileInput');

            // DROPDOWN ELEMENTS
            const initialSetupDropdownBtn = document.getElementById('initialSetupDropdownBtn');
            const initialSetupMenu = document.getElementById('initialSetupMenu');
            const analysisDropdownBtn = document.getElementById('analysisDropdownBtn');
            const analysisMenu = document.getElementById('analysisMenu');
            const solutionDesignDropdownBtn = document.getElementById('solutionDesignDropdownBtn');
            const solutionDesignMenu = document.getElementById('solutionDesignMenu');
            const executionDropdownBtn = document.getElementById('executionDropdownBtn');
            const executionMenu = document.getElementById('executionMenu');
            const myPromptsDropdownBtn = document.getElementById('myPromptsDropdownBtn');
            const myPromptsMenu = document.getElementById('myPromptsMenu');
            const workflowBtn = document.getElementById('workflowBtn');
            const workflowMenu = document.getElementById('workflowMenu');
            const exportBtn = document.getElementById('exportBtn');

            let MIN_HEIGHT = 0; 
            const chatHistory = [];
            let awaitingPlanResponse = false;
            let attachedFileContent = null;
            let attachedFileName = null;

            // ============================================
            // 0. PROJECT MANAGEMENT SYSTEM
            // ============================================
            let currentProjectId = null;
            const phaseMenuContainer = document.getElementById('phaseMenuContainer');
            const toolsMenuContainer = document.getElementById('toolsMenuContainer');
            const noProjectToolState = document.getElementById('noProjectToolState');
            const currentProjectBadge = document.getElementById('currentProjectBadge');
            const currentProjectNameDisplay = document.getElementById('currentProjectNameDisplay');

            // Load Project List from LocalStorage
            function getProjects() {
                return JSON.parse(localStorage.getItem('bob_projects_index') || '[]');
            }

            // Save Chat to Current Project
            function saveCurrentProjectChat() {
                if (!currentProjectId) return;
                localStorage.setItem(`bob_project_${currentProjectId}_chat`, JSON.stringify(chatHistory));
            }

            // Switch to a specific project
            function activateProject(id, name) {
                currentProjectId = id;
                
                // 1. Update UI Visibility
                phaseMenuContainer.classList.remove('hidden', 'opacity-50');
                phaseMenuContainer.classList.add('opacity-100');
                toolsMenuContainer.classList.remove('hidden');
                noProjectToolState.classList.add('hidden');
                
                // 2. Update Hero Text
                heroText.style.display = 'none';
                
                // 3. Update Badge
                currentProjectBadge.classList.remove('hidden');
                currentProjectNameDisplay.textContent = name;

                // 4. Load Chat History
                chatArea.innerHTML = ''; // Clear screen
                chatHistory.length = 0; // Clear array
                
                const savedChat = JSON.parse(localStorage.getItem(`bob_project_${id}_chat`) || '[]');
                
                if (savedChat.length > 0) {
                    savedChat.forEach(msg => {
                        // Re-render bubbles without re-saving (since they are already saved)
                        chatHistory.push(msg); // Add to memory
                        
                        // Manually create bubble to avoid double-save loop
                        // We use a simplified version of logic here just for rendering
                        const wrapper = document.createElement('div');
                        wrapper.classList.add('flex', 'message-wrapper', 'mb-4', msg.role === 'user' ? 'justify-end' : 'justify-start');
                        const bubble = document.createElement('div');
                        bubble.classList.add('rounded-xl', 'p-4', 'max-w-2xl', 'shadow-md', msg.role === 'user' ? 'bg-emerald-600' : 'bg-gray-800', 'text-gray-100');
                        
                        if (msg.role === 'model') {
                             const { html } = processCitations(msg.parts[0].text);
                             bubble.innerHTML = `<div class="ai-response-content mb-2">${marked.parse(html)}</div>`;
                        } else {
                             bubble.textContent = msg.parts[0].text;
                        }
                        wrapper.appendChild(bubble);
                        chatArea.appendChild(wrapper);
                    });
                    // Scroll to bottom
                    setTimeout(() => chatArea.scrollTop = chatArea.scrollHeight, 100);
                } else {
                    // New Project: Show Hero Text
                     heroText.style.display = 'flex';
                }
            }

            // EVENT: New Project
            document.getElementById('newProjectBtn').onclick = () => {
                const name = prompt("Enter Project Name (e.g., 'Q3 Sales Strategy'):");
                if (!name) return;

                const id = Date.now().toString();
                const projects = getProjects();
                projects.push({ id, name, date: new Date().toISOString() });
                localStorage.setItem('bob_projects_index', JSON.stringify(projects));
                
                activateProject(id, name);
            };

            // EVENT: Load Project
            document.getElementById('loadProjectBtn').onclick = () => {
                const projects = getProjects();
                if (projects.length === 0) return alert("No saved projects found.");

                // Simple prompt selection (can be upgraded to modal later)
                let list = "Select a project by number:\n";
                projects.forEach((p, i) => list += `${i + 1}. ${p.name}\n`);
                
                const choice = prompt(list);
                if (choice && projects[choice - 1]) {
                    activateProject(projects[choice - 1].id, projects[choice - 1].name);
                }
            };

            // ============================================
            // 1. PROMPT MAP (OPTIMIZED FOR CONSULTING ACCURACY)
            // ============================================
            const PROMPT_MAP = {
                
                // ========================
                // PHASE 1: INITIAL SETUP
                // ========================
                
                'Guided Diagnostic (Interviewer Mode)': `Act as a Senior Partner Consultant conducting a root-cause diagnostic interview. I have a business problem: [input BRIEF PROBLEM DESCRIPTION].

Your goal is to uncover the underlying issues, not just the symptoms. Do NOT provide a solution yet. Instead, generate a structured interview protocol.

The output MUST follow this structure:

# Guided Diagnostic: [Problem Name]
## Objective
[Concise statement of the diagnostic goal]

## Diagnostic Questions
1. **[Topic A - Root Cause]:** [Probing question using the "5 Whys" technique]
2. **[Topic B - Constraints]:** [Question regarding budget, timeline, or resources]
3. **[Topic C - Success Metrics]:** [Question defining what "good" looks like quantitatively]
4. **[Topic D - Stakeholders]:** [Question about decision-makers and blockers]

## Next Steps
Please answer these questions so I can formulate a hypothesis.`,

                'Industry Trends Snapshot': `Act as a Market Researcher. Use Google Search to find **real-time, quantified data** regarding [input SPECIFIED INDUSTRY]. 
                
IMPORTANT: You MUST cite your sources using inline markdown links [Source Name](URL). Do not hallucinate data.

The output MUST strictly follow this high-readability structure:

# [Industry] Trends Snapshot
[Concise executive summary of the current industry landscape]

## Key Trend 1: [Trend Name]
* [Specific data point/statistic with citation]
* [Impact on business models]
* [Future projection]

## Key Trend 2: [Trend Name]
* [Specific data point/statistic with citation]
* [Impact on business models]
* [Future projection]
... (3 to 5 trends total)

## Summary Table
| Trend | Primary Impact |
|---|---|
| [Trend 1 Name] | * [Impact bullet 1] <br> * [Impact bullet 2] |
| [Trend 2 Name] | * [Impact bullet 1] <br> * [Impact bullet 2] |
| [Trend 3 Name] | * [Impact bullet 1] <br> * [Impact bullet 2] |

The table must be the last element of the response before the suggestions block.`,
              
                'Initial Project Charter Draft': `Act as a Project Manager. Generate a formal Project Charter for [input SPECIFIC PROJECT TYPE, e.g., 'implementing a new cloud-based CRM system']. 

Ensure the objectives are SMART (Specific, Measurable, Achievable, Relevant, Time-bound).

The output MUST strictly follow this professional structure:

# Project Charter: [Project Title]
[Short executive summary of the project's strategic value]

## Project Details
| Field | Value |
|---|---|
| Project Sponsor | [Recommended Title] |
| Project Manager | [Recommended Title] |
| Target Completion | [Estimated Quarter/Year] |

## Scope Overview
[1-2 paragraphs clearly defining what is included (In-Scope) and explicitly what is excluded (Out-of-Scope) to prevent scope creep.]

## Key Objectives
* [SMART Objective 1]
* [SMART Objective 2]
* [SMART Objective 3]

## Success Metrics (Key Performance Indicators)
* [Metric 1: Quantitative definition of success]
* [Metric 2: Quantitative definition of success]
* [Metric 3: Quantitative definition of success]

## High-Level Timeline (Phases)
* Phase 1: Initiation and Planning ([Estimated Duration])
* Phase 2: Execution and Development ([Estimated Duration])
* Phase 3: Deployment and Stabilization ([Estimated Duration])

The timeline must be the last element of the response before the suggestions block.`,
              
                'Problem Statement Draft': `Act as a Strategy Consultant. Draft a precise Problem Statement for [input SPECIFIC ISSUE]. Use the SCQA (Situation, Complication, Question, Answer) logic implicitly to frame this.

The output MUST strictly follow the Current State, Desired State, Impact structure:

# Preliminary Problem Statement
[A single, punchy sentence stating the core business issue.]

## 1. Current State (The Symptom)
[A concise paragraph describing the current measurable negative symptoms, the magnitude of the gap, and where it is occurring. Use placeholders for data if unknown.]

## 2. Desired State (The Goal)
[A concise paragraph describing the measurable target outcome and the strategic benefit of achieving it.]

## 3. Impact of Solving (The Value)
[A concise paragraph describing the financial (Revenue/Cost) or strategic value derived by the business upon successful resolution.]

The "Impact of Solving" section must be the last element of the response before the suggestions block.`,
              
                // ========================
                // PHASE 2: ANALYSIS
                // ========================

                'MECE Logic Check': `Act as a Logic Auditor. Perform a MECE (Mutually Exclusive, Collectively Exhaustive) audit on the following analysis or problem statement: [input PASTE ANALYSIS OR PROBLEM HERE].

Your goal is to find logical flaws, overlaps, or missing data points.

The output MUST follow this structure:

# MECE Logic Audit
[Assessment: Is this breakdown logic tight or leaky?]

## Logic Gaps (Missing Elements)
* [Gap 1 - What category did we forget?]
* [Gap 2 - What category did we forget?]

## Overlaps (Redundancies)
* [Overlap 1 - Where are we double counting?]

## Proposed MECE Framework
Reorganize the analysis into distinct, non-overlapping buckets:
1. **[Bucket 1]**
   * [Point A]
   * [Point B]
2. **[Bucket 2]**
   * [Point C]
   * [Point D]`,

                'Market Analysis': `Act as a Market Analyst. Conduct a rigorous analysis for [input SPECIFIC MARKET / INDUSTRY]. 

**REQUIREMENTS:**
1. Use Google Search to find **current data** (TAM/SAM/SOM, CAGR).
2. Cite sources inline using [Source Name](URL).

The output MUST strictly follow this structure:

# [Analysis Title]
[Executive summary of the market health and maturity]

## Key Trends
* [Trend 1: Data-backed trend with citation]
* [Trend 2: Data-backed trend with citation]
...

## Competitive Landscape
| Competitor | Market Share/Focus | Key Strengths/Weaknesses |
|---|---|---|
| [Name 1] | [Focus] | * [Strength 1] <br> * [Weakness 1] |
| [Name 2] | [Focus] | * [Strength 1] <br> * [Weakness 1] |

## Future Outlook
* [Projected Growth Rate (CAGR) with citation]
* [Disruptive technologies or regulations]
...

The table must be the last element before the suggestions block.`,
              
                'SWOT Analysis': `Act as a Strategic Planner. Perform a SWOT analysis for [input SPECIFIC COMPANY / PROJECT]. 

**REQUIREMENTS:**
1. Use Google Search to ensure "Opportunities" and "Threats" are based on real external market conditions.
2. Cite sources for external factors using [Source Name](URL).

The output MUST strictly follow this structure:

# SWOT Analysis for [Company/Project]
[A concise paragraph explaining the strategic position.]

## Analysis Matrix
| Strengths (Internal) | Weaknesses (Internal) | Opportunities (External) | Threats (External) |
|---|---|---|---|
| * [Core Competency 1] <br> * [Core Competency 2] | * [Internal Gap 1] <br> * [Internal Gap 2] | * [Market Trend 1 (Cited)] <br> * [Market Trend 2 (Cited)] | * [Competitor Move 1 (Cited)] <br> * [Regulation 1 (Cited)] |
| * [Core Competency 3] | * [Internal Gap 3] | * [Market Trend 3 (Cited)] | * [Macro Factor 1 (Cited)] |

The table must be the last element of the response before the suggestions block.`,
              
                'Competitor Benchmarking': `Act as a Competitive Intelligence Analyst. Perform a detailed benchmarking analysis for [input COMPANY A] against [input COMPETITOR B] and [input COMPETITOR C]. 

**REQUIREMENTS:**
1. Use Google Search to find real feature sets, pricing, and reviews.
2. Cite sources using [Source Name](URL).

The output MUST strictly follow this structure:

# Competitor Benchmarking Report
[A brief introduction defining the competitive scope and primary differentiators.]

## Benchmarking Table
| Competitor | Market Share/Focus | Product Features | Pricing Model | Online Presence/Sentiment |
|---|---|---|---|---|
| **[Competitor B]** | [Est. Share] | * [Key Feature 1] <br> * [Key Feature 2] | [Pricing Strategy] | [Sentiment/Rating] |
| **[Competitor C]** | [Est. Share] | * [Key Feature 1] <br> * [Key Feature 2] | [Pricing Strategy] | [Sentiment/Rating] |

The table must be the last element of the response before the suggestions block.`,
              
                '5 Forces Analysis': `Act as an Industry Analyst. Conduct a Porter's 5 Forces Analysis for [input SPECIFIC INDUSTRY]. 

**REQUIREMENTS:**
1. Assess the "Power" (High/Medium/Low) of each force based on current market dynamics.
2. Use Google Search to find supporting evidence. Cite sources using [Source Name](URL).

The output MUST strictly follow this structure:

# Porter's Five Forces Analysis: [Industry]
[A concise paragraph summarizing the overall industry attractiveness and profitability.]

## Industry Structure Summary
| Force | Threat Level | Key Drivers/Evidence |
|---|---|---|
| **Threat of New Entrants** | [High/Med/Low] | * [Barriers to entry details (Cited)] <br> * [Capital requirements] |
| **Bargaining Power of Buyers** | [High/Med/Low] | * [Buyer concentration] <br> * [Switching costs] |
| **Bargaining Power of Suppliers** | [High/Med/Low] | * [Supplier concentration] <br> * [Input criticality] |
| **Threat of Substitutes** | [High/Med/Low] | * [Price/performance trade-off] <br> * [Technology shifts] |
| **Competitive Rivalry** | [High/Med/Low] | * [Industry growth rate] <br> * [differentiation] |

The table must be the last element of the response before the suggestions block.`,
              
                'PESTLE Analysis': `Act as a Macro-Economic Analyst. Perform a PESTLE analysis for [input SPECIFIC COMPANY / INDUSTRY]. 

**REQUIREMENTS:**
1. Focus on external macro-factors impacting the business.
2. Use Google Search for Regulations (Legal) and Economic trends. Cite sources using [Source Name](URL).

The output MUST strictly follow this structure:

# PESTLE Analysis for [Company/Industry]
[A brief introduction explaining the most critical macro-factors.]

The remaining analysis MUST be presented in a specific two-column table format:

| Factor | Key Findings |
|---|---|
| **Political** | * [Trade policy/Stability (Cited)] <br> * [Taxation policy] |
| **Economic** | * [Inflation/Rates (Cited)] <br> * [Growth trends] |
| **Social** | * [Demographics] <br> * [Lifestyle changes] |
| **Technological** | * [Innovation/R&D] <br> * [Disruption] |
| **Legal** | * [Employment law] <br> * [Industry regulations (Cited)] |
| **Environmental** | * [Carbon footprint] <br> * [Sustainability targets] |

The table must be the last element of the response before the suggestions block.`,

                'Hofstede Analysis': `Act as a Cross-Cultural Consultant. Perform a Hofstede's Cultural Dimensions analysis for [input SPECIFIC COUNTRY/CULTURE] focusing on its implications for [input SPECIFIC BUSINESS SCENARIO]. 
                
**REQUIREMENTS:**
1. Use Google Search to find the actual Hofstede scores for the country if available.
2. Interpret what those scores mean for business management.

The output MUST strictly follow this structure:

# Hofstede's Cultural Analysis: [Country]
[A concise introductory paragraph explaining the cultural context.]

## Cultural Dimensions Summary
| Dimension | Score/Rating | Business Implication |
|---|---|---|
| **Power Distance (PDI)** | [Score/Rating] | * [Implication for hierarchy] <br> * [Implication for leadership] |
| **Individualism (IDV)** | [Score/Rating] | * [Implication for teamwork] <br> * [Implication for incentives] |
| **Masculinity (MAS)** | [Score/Rating] | * [Implication for competition] <br> * [Implication for work-life balance] |
| **Uncertainty Avoidance (UAI)** | [Score/Rating] | * [Implication for risk-taking] <br> * [Implication for rules] |
| **Long-Term Orientation (LTO)** | [Score/Rating] | * [Implication for planning] <br> * [Implication for investment] |
| **Indulgence (IVR)** | [Score/Rating] | * [Implication for atmosphere] <br> * [Implication for strictness] |

The table must be the last element of the response before the suggestions block.`,
                
                // ========================
                // PHASE 3: SOLUTION DESIGN
                // ========================

                "Devil's Advocate Review": `Act as a "Red Team" Lead. I want you to stress-test my current strategy/solution. Switch personas to a skeptical, critical opponent.
                
The output MUST follow this structure:

# Strategic Stress Test
[Introductory critique of the proposed plan - be direct]

## Critical Flaws & Assumptions
| Assumption | Probability of Failure | Impact |
|---|---|---|
| [Assumption 1] | [High/Med/Low] | [High/Med/Low] |
| [Assumption 2] | [High/Med/Low] | [High/Med/Low] |

## The "Pre-Mortem" (Worst Case)
* [Detailed scenario description if the plan fails strictly]

## Cognitive Bias Check
* [Identify biases: Sunk Cost, Confirmation Bias, Groupthink, etc.]`,

                'Business Plan Outline': `Act as a Business Strategy Consultant. Draft a comprehensive business plan outline for a [input YOUR BUSINESS IDEA]. Focus on viability and monetization.

The output MUST strictly follow this structure:

# Business Plan Outline: [Your Business Idea]
[A concise introductory summary paragraph.]

## Executive Summary
* [Core Value Proposition]
* [Target Market Segment]
* [Financial Highlights (Revenue Model)]

## Company Description
* [Mission & Vision]
* [Legal Structure]
* [Key Personnel/Team gaps]

## Market Analysis
* [Industry Trends & Growth]
* [Competitive Advantage (Moat)]
* [Market Size (TAM/SAM/SOM)]

## Organization and Management
* [Organizational Structure]
* [Key Management Team Roles]

## Service or Product Line
* [Product/Service Description]
* [Development Status (MVP vs Scale)]
* [Intellectual Property/Assets]

## Marketing and Sales Strategy
* [Acquisition Channels]
* [Sales Cycle Strategy]
* [Key Strategic Partnerships]

## Financial Projections
* [Startup Costs Summary]
* [3-Year Revenue Forecast Highlight]
* [Funding Request/Burn Rate]

## Appendix
* [Supporting Documents]

The Appendix section must be the last element of the response before the suggestions block.`,
              
                'Market Entry Strategy': `Act as a Global Expansion Consultant. Develop a comprehensive market entry strategy for [input PRODUCT / SERVICE] entering the [input SPECIFIC COUNTRY / MARKET]. 

**REQUIREMENTS:**
1. Analyze entry modes (Greenfield, JV, Acquisition, Export).
2. Use Google Search to identify local regulations and competitors.

The output MUST strictly follow this structure:

# Market Entry Strategy: [Product] in [Market]
[A brief paragraph summarizing the primary recommended approach.]

## Target Audience
* [Demographics/Psychographics]
* [Local Needs/Pain Points]

## Distribution Strategy
* [Primary Channel]
* [Logistics and Fulfillment]

## Pricing Model
* [Recommended Strategy (e.g., Penetration, Skimming, Cost-Plus)]
* [Local Currency Considerations]

## Market Entry Options Summary
| Method | Key Advantages | Key Disadvantages |
|---|---|---|
| [Method 1 (e.g., Export)] | * [Advantage 1] <br> * [Advantage 2] | * [Disadvantage 1] <br> * [Disadvantage 2] |
| [Method 2 (e.g., Joint Venture)] | * [Advantage 1] <br> * [Advantage 2] | * [Disadvantage 1] <br> * [Disadvantage 2] |
| [Method 3 (e.g., Direct Investment)] | * [Advantage 1] <br> * [Advantage 2] | * [Disadvantage 1] <br> * [Disadvantage 2] |

The table must be the last element of the response before the suggestions block.`,

                'Go-to-market Strategy': `Act as a Chief Marketing Officer (CMO). Develop a comprehensive Go-to-Market (GTM) Strategy for [input PRODUCT / SERVICE] targeting [input SPECIFIC AUDIENCE]. Focus on CAC (Cost of Acquisition) and LTV (Lifetime Value) drivers.

The output MUST strictly follow this structure:

# Go-to-Market Strategy: [Product]
[A brief introductory paragraph summarizing the strategic approach and main goal.]

## Target Customer Profile (ICP)
* [Target Demographic/Firmographic]
* [Primary Pain Point Addressed]
* [Unique Value Proposition (UVP)]

## Channel and Tactics Plan
| Channel Category | Key Tactics/Activities | Owner/Timeline |
|---|---|---|
| **Marketing (Top of Funnel)** | * [Tactic 1] <br> * [Tactic 2] | [Owner/Timeline] |
| **Sales (Middle/Bottom)** | * [Tactic 1] <br> * [Tactic 2] | [Owner/Timeline] |
| **Product/Success (Retention)** | * [Tactic 1] <br> * [Tactic 2] | [Owner/Timeline] |

## Pricing & Packaging
* [Recommended Pricing Model]
* [Launch Offer / Incentive]

## Launch Metrics (KPIs)
* [Metric 1: Definition of success]
* [Metric 2: Definition of success]
* [Metric 3: Definition of success]

The "Launch Metrics" section must be the last element of the response before the suggestions block.`,

                'Ansoff Matrix': `Act as a Growth Strategist. Apply the Ansoff Matrix (Product/Market Expansion Grid) to recommend growth strategies for [input COMPANY NAME / PRODUCT IDEA ]. 

The output MUST strictly follow this structure:

# Ansoff Matrix Growth Recommendations
[A concise introduction defining the company's current core product and market.]

## Growth Strategy Matrix
| Strategy | Product/Market Status | Key Action/Risk |
|---|---|---|
| **Market Penetration** | Existing Product / Existing Market | * [Action 1] <br> * [Action 2] |
| **Product Development** | New Product / Existing Market | * [Action 1] <br> * [Action 2] |
| **Market Development** | Existing Product / New Market | * [Action 1] <br> * [Action 2] |
| **Diversification** | New Product / New Market | * [Action 1] <br> * [Action 2] |

The table must be the last element of the response before the suggestions block.`,
              
                'Risk Analysis': `Act as a Risk Manager. Conduct a risk analysis for [input SPECIFIC BUSINESS VENTURE / PROJECT]. Identify potential risks, assess their likelihood and impact, and propose mitigation strategies. 

The output MUST strictly follow this structure:

# High-Level Risk Analysis: [Venture/Project Name]
[A brief introductory statement on the scope of the risk assessment.]

## Risk Mitigation Table
| Risk Area | Likelihood (H/M/L) | Impact (H/M/L) | Mitigation Strategy |
|---|---|---|---|
| **[Risk Category 1]** | [Level] | [Level] | * [Strategy 1] <br> * [Strategy 2] |
| **[Risk Category 2]** | [Level] | [Level] | * [Strategy 1] <br> * [Strategy 2] |
| **[Risk Category 3]** | [Level] | [Level] | * [Strategy 1] <br> * [Strategy 2] |

The table must be the last element of the response before the suggestions block.`,
              
                // ========================
                // PHASE 4: EXECUTION
                // ========================

                'Monday Morning Protocol': `Act as an Implementation Manager. Convert our high-level strategy into a concrete "Monday Morning" Action Plan.

The output MUST strictly follow this structure:

# Monday Morning Action Protocol
[Statement of immediate intent]

## Immediate Actions (Next 7 Days)
| Role/Owner | Specific Task (The "What") | Deadline (The "When") | Definition of Done |
|---|---|---|---|
| [Role 1] | [Task] | [Date/Day] | [Outcome] |
| [Role 2] | [Task] | [Date/Day] | [Outcome] |

## 30-60-90 Day Outlook
* **30 Days:** [Milestone]
* **60 Days:** [Milestone]
* **90 Days:** [Milestone]`,

                'KPI Dashboard Mockup': `Act as a Data Scientist. Design a **KPI Dashboard Mockup** structure for tracking the success of [input SPECIFIC BUSINESS GOAL / PROJECT]. 

**REQUIREMENTS:**
1. Distinguish between "Leading Indicators" (Predictive) and "Lagging Indicators" (Outcome).

The output MUST strictly follow this structure:

# Key Performance Indicator (KPI) Dashboard Mockup
[A concise statement defining the overall goal of the dashboard.]

## Defined Metrics
| KPI Name | Type (Leading/Lagging) | Definition/Formula | Target Value | Reporting Frequency |
|---|---|---|---|---|
| **[KPI 1: Financial]** | [Type] | [Formula] | [Target] | [Monthly] |
| **[KPI 2: Customer]** | [Type] | [Formula] | [Target] | [Weekly] |
| **[KPI 3: Operational]** | [Type] | [Formula] | [Target] | [Daily] |
| **[KPI 4: Quality]** | [Type] | [Formula] | [Target] | [Daily] |

The table must be the last element of the response before the suggestions block.`,
              
                'Implementation Plan Outline': `Act as a Program Manager. Generate a high-level **Implementation Plan Outline** for [input PROJECT / STRATEGY]. Structure the plan into clear phases.

The output MUST strictly follow this structure:

# High-Level Implementation Plan: [Project Title]
[A brief introductory paragraph summarizing the plan's execution approach.]

## Implementation Phases
| Phase | Key Milestones | Required Resources | Estimated Duration |
|---|---|---|---|
| **Phase 1: Setup** | * [Milestone 1] <br> * [Milestone 2] | [Team/Budget/Tools] | [Duration] |
| **Phase 2: Development** | * [Milestone 1] <br> * [Milestone 2] | [Team/Budget/Tools] | [Duration] |
| **Phase 3: Deployment** | * [Milestone 1] <br> * [Milestone 2] | [Team/Budget/Tools] | [Duration] |
| **Phase 4: Stabilization** | * [Milestone 1] <br> * [Milestone 2] | [Team/Budget/Tools] | [Duration] |

The table must be the last element of the response before the suggestions block.`,
            };

            // ============================================
            // 4. UI HELPERS (Menus, Resizing, Hero)
            // ============================================

            function toggleMenu(menuElement) {
                // Close all other menus first
                [initialSetupMenu, analysisMenu, solutionDesignMenu, executionMenu, myPromptsMenu, workflowMenu].forEach(m => {
                    if (m !== menuElement) m.classList.add('hidden');
                });
                menuElement.classList.toggle('hidden');
            }

            // Close menus on click outside
            document.addEventListener('click', (e) => {
                const isBtn = e.target.closest('button');
                const isMenu = e.target.closest('.sidebar-menu') || e.target.closest('#myPromptsMenu') || e.target.closest('#workflowMenu');
                
                // Allow clicking inside menus or on their buttons
                if (isBtn && (isBtn.id.includes('Dropdown') || isBtn.id === 'workflowBtn')) return;
                if (isMenu) return;

                // Close all
                [initialSetupMenu, analysisMenu, solutionDesignMenu, executionMenu, myPromptsMenu, workflowMenu].forEach(m => m.classList.add('hidden'));
            });

            // Attach listeners to dropdwns
            initialSetupDropdownBtn.onclick = () => toggleMenu(initialSetupMenu);
            analysisDropdownBtn.onclick = () => toggleMenu(analysisMenu);
            solutionDesignDropdownBtn.onclick = () => toggleMenu(solutionDesignMenu);
            executionDropdownBtn.onclick = () => toggleMenu(executionMenu);
            myPromptsDropdownBtn.onclick = () => toggleMenu(myPromptsMenu);
            workflowBtn.onclick = () => toggleMenu(workflowMenu);

            // Auto-resize input
            userInput.style.height = 'auto';
            MIN_HEIGHT = userInput.scrollHeight;
            function autoResizeTextarea(textarea) {
                textarea.style.height = 'auto';
                let newHeight = textarea.scrollHeight;
                if (newHeight < MIN_HEIGHT) newHeight = MIN_HEIGHT;
                if (newHeight > 150) {
                    newHeight = 150;
                    textarea.style.overflowY = 'auto';
                } else {
                    textarea.style.overflowY = 'hidden';
                }
                textarea.style.height = `${newHeight}px`;
            }
            userInput.addEventListener('input', () => autoResizeTextarea(userInput));

            // Populate Menus from Prompt Map
            const populateMenu = (menuId, items) => {
                const menu = document.getElementById(menuId);
                menu.innerHTML = '';
                items.forEach(item => {
                    const btn = document.createElement('button');
                    btn.className = 'sub-menu-btn';
                    btn.textContent = item;
                    btn.onclick = () => {
                        // Use the FULL prompt from the map
                        userInput.value = PROMPT_MAP[item] || item;
                        autoResizeTextarea(userInput);
                        userInput.focus();
                        toggleMenu(menu); // Close menu after click
                    };
                    menu.appendChild(btn);
                });
            };

            // 1. Initial Setup + The "Interviewer"
            populateMenu('initialSetupMenu', [
                'Guided Diagnostic (Interviewer Mode)', // NEW
                'Industry Trends Snapshot', 
                'Initial Project Charter Draft', 
                'Problem Statement Draft'
            ]);

            // 2. Analysis + The "MECE Validator"
            populateMenu('analysisMenu', [
                'MECE Logic Check', // NEW
                'Market Analysis', 
                'SWOT Analysis', 
                'Competitor Benchmarking', 
                '5 Forces Analysis', 
                'PESTLE Analysis', 
                'Hofstede Analysis'
            ]);

            // 3. Solution + "Devil's Advocate"
            populateMenu('solutionDesignMenu', [
                "Devil's Advocate Review", // NEW
                'Business Plan Outline', 
                'Market Entry Strategy', 
                'Go-to-market Strategy', 
                'Ansoff Matrix', 
                'Risk Analysis'
            ]);

            // 4. Execution + "Monday Morning Protocol"
            populateMenu('executionMenu', [
                'Monday Morning Protocol', // NEW
                'KPI Dashboard Mockup', 
                'Implementation Plan Outline'
            ]);

            // ============================================
            // 2. CORE LOGIC (Send, File, API)
            // ============================================

            // FILE UPLOAD
            attachBtn.addEventListener('click', () => hiddenFileInput.click());
            hiddenFileInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const onFileLoaded = (content, name) => {
                    attachedFileContent = content;
                    attachedFileName = name;
                    attachBtn.classList.remove('text-gray-400', 'text-yellow-400');
                    attachBtn.classList.add('text-emerald-500');
                    attachBtn.title = `Attached: ${name}`;
                    userInput.focus();
                };

                if (file.type === 'application/pdf') {
                    try {
                        attachBtn.classList.add('text-yellow-400');
                        const arrayBuffer = await file.arrayBuffer();
                        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                        let fullText = "";
                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const textContent = await page.getTextContent();
                            const pageText = textContent.items.map(item => item.str).join(' ');
                            fullText += `\n--- PDF Page ${i} ---\n${pageText}`;
                        }
                        onFileLoaded(fullText, file.name);
                    } catch (error) {
                        console.error(error);
                        alert("Error reading PDF.");
                        hiddenFileInput.value = ""; attachBtn.classList.remove('text-yellow-400');
                    }
                } else {
                    const reader = new FileReader();
                    reader.onload = (e) => onFileLoaded(e.target.result, file.name);
                    reader.readAsText(file);
                }
            });

            // ============================================
            // 3. AUTONOMOUS RESEARCH AGENT (THE LOOP)
            // ============================================
            
            async function startAutonomousResearch(topic) {
                createMessageBubble(` **Autonomous Agent Activated**\n\nObjective: Deep dive research on "${topic}"\n\n*Step 1: Generative Planning...*`, 'model');
                
                try {
                    // 2. PLAN
                    const planPrompt = `I need to research "${topic}" thoroughly. 
                    Generate 3 specific, diverse Google Search queries.
                    Return ONLY a raw JSON array of strings. 
                    Example: ["market size of X", "competitors of X", "trends in X"]`;

                    const planResponse = await getSilentResponse(planPrompt);
                    let queries = [];
                    try {
                        let cleanJson = planResponse.replace(/```json/g, '').replace(/```/g, '').trim();
                        queries = JSON.parse(cleanJson);
                    } catch (e) {
                        console.error("Plan parse error", e);
                        queries = [`${topic} market size`, `${topic} trends`, `${topic} competitors`];
                    }

                    // 3. EXECUTE LOOP
                    let researchNotes = "";
                    
                    for (let i = 0; i < queries.length; i++) {
                        const query = queries[i];
                        createMessageBubble(` **Researching (${i+1}/${queries.length}):** "${query}"...`, 'model');
                        
                        const searchPrompt = `Use Google Search to find detailed data on: "${query}". 
                        Extract key facts, numbers, and dates.
                        
                        CRITICAL: You MUST cite the URL for every fact found using this format: [Ref](Link).
                        Example: "Revenue is $10M [Ref](https://forbes.com)."`;
                        
                        const result = await getSilentResponse(searchPrompt);
                        researchNotes += `\n\n### Findings for "${query}":\n${result}`;
                        
                        await new Promise(r => setTimeout(r, 1000));
                    }

                    // 4. SYNTHESIS
                    createMessageBubble(` **Synthesizing Data into Final Report...**`, 'model');
                    
                    const finalReportPrompt = `You are a Senior Strategy Consultant. 
                    Write a **Strategic Deep Dive Report** based ONLY on these notes.
                    
                    **CRITICAL FORMATTING RULES:**
                    1. Use Markdown.
                    2. **PRESERVE THE URLs:** When you state a fact from the notes, you MUST include the citation link [Ref](Link) exactly as it appears in the notes.
                    3. Do NOT write [Ref] without the (Link). The link is required for the pin icon to appear.
                    
                    **NOTES:**
                    ${researchNotes}
                    
                    **REPORT STRUCTURE:**
                    # Strategic Deep Dive: ${topic}
                    ## Executive Summary
                    ## Key Findings (Data & Trends)
                    ## Competitive Landscape
                    ## Strategic Implications`;

                    const finalReport = await getSilentResponse(finalReportPrompt);
                    
                    createMessageBubble(finalReport, 'model');
                    saveCurrentProjectChat(); 

                } catch (error) {
                    createMessageBubble(` **Agent Failure:** ${error.message}`, 'model');
                }
            }

            // Helper: Send a message to API with STRICT Citation Rules
            async function getSilentResponse(prompt) {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        systemInstruction: { 
                            parts: [{ text: `You are a Research Agent. 
                            CRITICAL: Always use Google Search for facts. 
                            ALWAYS cite sources inline using [Ref](Link).` }] 
                        },
                        messages: [{ role: "user", parts: [{ text: prompt }] }] 
                    })
                });
                const data = await response.json();
                if (data.error) throw new Error(data.error.message);
                return data?.candidates?.[0]?.content?.parts?.[0]?.text || "";
            }
            
            // Trigger Detection
            function isResearchRequest(message) {
                const keywords = ['research', 'deep dive', 'investigate', 'analyze landscape'];
                return keywords.some(k => message.toLowerCase().includes(k));
            }
            
            // SEND MESSAGE
            async function sendMessage() {
                let prompt = userInput.value.trim();
                let hasFile = attachedFileContent !== null;
                
                if (!prompt && !hasFile) return;

                // 1. UI: Hide Hero Text
                heroText.style.display = 'none';

                // 2. Construct Payload
                let fullPayloadPrompt = prompt;
                if (hasFile) {
                    const filePrompt = `\n\n[USER ATTACHED FILE: ${attachedFileName}]\n\`\`\`\n${attachedFileContent}\n\`\`\`\n`;
                    if (prompt === "") {
                        prompt = `Analyze the attached file: ${attachedFileName}`;
                        fullPayloadPrompt = prompt + filePrompt;
                    } else {
                        fullPayloadPrompt = prompt + filePrompt;
                    }
                }

                // 3. Update UI Bubbles (User Side)
                if (hasFile) {
                    createMessageBubble(` **Uploaded:** ${attachedFileName}`, 'user');
                    // Reset File Variables immediately
                    attachedFileContent = null;
                    attachedFileName = null;
                    hiddenFileInput.value = "";
                    attachBtn.classList.remove('text-emerald-500', 'text-yellow-400');
                    attachBtn.classList.add('text-gray-400');
                }

                const userVisibleText = userInput.value.trim();
                if (userVisibleText) {
                    createMessageBubble(userVisibleText, 'user');
                }
                
                chatHistory.push({ role: "user", parts: [{ text: fullPayloadPrompt }] });

                // 4. Reset Input State
                userInput.value = '';
                autoResizeTextarea(userInput);
                userInput.disabled = true;
                sendButton.disabled = true;

                // --- NEW TRIGGER: Check for Research Agent ---
                if (isResearchRequest(prompt)) {
                    // Extract the topic (remove the word "research")
                    const topic = prompt.replace(/(deep dive|research|investigate|study|analyze|explore|find information about|gather data on)/gi, '').trim();
                    
                    // Run the loop
                    await startAutonomousResearch(topic);
                    
                    // Cleanup & Exit
                    userInput.disabled = false;
                    sendButton.disabled = false;
                    userInput.focus();
                    return; 
                }
                // ---------------------------------------------

                // 5. Loading Indicator (Standard Chat Only)
                const loadingBubble = document.createElement('div');
                loadingBubble.classList.add('flex', 'justify-start');
                loadingBubble.innerHTML = `<div class="bg-gray-700 text-gray-300 rounded-xl rounded-bl-none p-3 max-w-sm shadow-md"><div class="flex items-center">Thinking...</div></div>`;
                chatArea.appendChild(loadingBubble);
                chatArea.scrollTop = chatArea.scrollHeight;

                // 6. API Call
                try {
                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            systemInstruction: { 
                                parts: [{ text: `You are Bob, a professional consulting assistant. 
                                
                                RULES FOR CITATIONS:
                                1. Use the Google Search Tool for facts/data.
                                2. Cite sources using inline markdown: [Source Name](URL).
                                
                                RULES FOR CHARTS:
                                If the user asks to visualize data, compare numbers, or create a graph:
                                1. Generate a standard textual analysis first.
                                2. At the very end, output the chart data in a JSON block wrapped in <chart> and </chart> tags.
                                3. The JSON must follow Chart.js format: { "type": "bar" (or line/pie/doughnut), "data": { "labels": [], "datasets": [{ "label": "Title", "data": [] }] } }.
                                
                                Example:
                                Analysis of sales...
                                <chart>
                                { "type": "bar", "data": { "labels": ["Q1", "Q2"], "datasets": [{ "label": "Revenue", "data": [100, 200] }] } }
                                </chart>

                                Format the rest of your response using professional Markdown.` }] 
                            },
                            messages: chatHistory
                        })
                    });

                    const result = await response.json();
                    
                    // Remove loading bubble
                    if(chatArea.contains(loadingBubble)) chatArea.removeChild(loadingBubble);

                    // 7. Error Handling & Response Display
                    if (result.error) {
                        console.error("API Error:", result.error);
                        createMessageBubble(` **System Error:** ${result.error.message || "Unknown API Error"}`, "model");
                    } else {
                        const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (text) {
                            chatHistory.push({ role: "model", parts: [{ text: text }] });
                            createMessageBubble(text, "model");
                        } else {
                            createMessageBubble(" Bob returned an empty response. Try asking a specific question.", "model");
                        }
                    }
                } catch (error) {
                    if(chatArea.contains(loadingBubble)) chatArea.removeChild(loadingBubble);
                    createMessageBubble(` **Connection Error:** ${error.message}`, "model");
                }

                // 8. RE-ENABLE CONTROLS
                userInput.disabled = false;
                sendButton.disabled = false;
                userInput.focus();
                
                // CRITICAL FIX: Save the chat to the project memory
                saveCurrentProjectChat();
            }

            // Keyboard and Button Listeners for Send
            sendButton.addEventListener('click', sendMessage);
            userInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // ============================================
            // 3. UTILITIES (Bubbles, Prompts, Clear, Etc)
            // ============================================

            // --- CITATION HELPER FUNCTIONS ---
            function processCitations(rawText) {
                // Regex to find STANDARD Markdown links: [Name](URL)
                // We look for http in the URL to ensure it's a real link
                const regex = /\[([^\]]+)\]\((http[^)]+)\)/g;
                let sources = [];
                let match;
    

            function createSourcesFooter(sources) {
                if (!sources || sources.length === 0) return '';
                
                const listItems = sources.map((s, i) => {
                    // SAFETY CHECK: Try to parse hostname, fallback if invalid URL
                    let faviconUrl = '';
                    try {
                        const urlObj = new URL(s.url);
                        faviconUrl = `https://www.google.com/s2/favicons?domain=${urlObj.hostname}`;
                    } catch (e) {
                        // If URL is invalid (e.g. missing https), use a generic icon
                        faviconUrl = 'https://www.google.com/s2/favicons?domain=google.com'; 
                    }

                    return `
                    <a href="${s.url}" target="_blank" class="source-item">
                        <span class="text-gray-500 font-mono text-xs">[${i+1}]</span>
                        <img src="${faviconUrl}" class="source-favicon" onerror="this.style.display='none'">
                        ${s.name}
                    </a>
                    `;
                }).join('');

                const listId = `sources-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;

                return `
                    <div class="sources-section">
                        <button class="sources-toggle-btn" onclick="document.getElementById('${listId}').classList.toggle('hidden')">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244" /></svg>
                            Sources
                        </button>
                        <div id="${listId}" class="sources-list hidden">${listItems}</div>
                    </div>
                `;
            }
            // ----------------------------------

            function createMessageBubble(text, sender) {
                const wrapper = document.createElement('div');
                wrapper.classList.add('flex', 'message-wrapper', 'mb-4', sender === 'user' ? 'justify-end' : 'justify-start');
                
                const bubble = document.createElement('div');
                bubble.classList.add(
                    'rounded-xl', 'p-4', 'max-w-2xl', 'shadow-md',
                    sender === 'user' ? 'bg-emerald-600' : 'bg-gray-800',
                    'text-gray-100'
                );
                bubble.style.overflow = 'hidden'; 

                // --- LOGIC FOR AI MESSAGES (Model) ---
                if (sender === 'model') {
                    let chartConfig = null;
                    let rawChartContent = null;
                    
                    // STRATEGY 1: Explicit Tags (Best Case)
                    // Looks for <chart> ... </chart> or <<<CHART>>>
                    const tagRegex = /(?:<<<CHART>>>|<chart>|<<>>)([\s\S]*?)(?:<<<END_CHART>>>|<\/chart>|<<>>)/i;
                    let match = text.match(tagRegex);
                    
                    if (match) {
                        rawChartContent = match[1];
                    } 
                    // STRATEGY 2: Markdown Code Blocks (Common AI behavior)
                    else {
                        const codeRegex = /```json\s*({[\s\S]*?"type"[\s\S]*?"data"[\s\S]*?})\s*```/i;
                        match = text.match(codeRegex);
                        if (match) rawChartContent = match[1];
                    }

                    // STRATEGY 3: "Aggressive Hunter" (Fallback for raw JSON)
                    // If no tags found, we look for the specific Chart.js signature: "type": "something"
                    if (!rawChartContent) {
                        const typeMarker = text.search(/"type"\s*:\s*"(bar|line|pie|doughnut|radar|polarArea)"/i);
                        if (typeMarker !== -1) {
                            // Found the marker. Now find the bounding braces { }
                            const startBrace = text.lastIndexOf('{', typeMarker);
                            const endBrace = text.lastIndexOf('}');
                            
                            if (startBrace !== -1 && endBrace !== -1 && endBrace > startBrace) {
                                rawChartContent = text.substring(startBrace, endBrace + 1);
                            }
                        }
                    }

                    // PARSE ATTEMPT
                    if (rawChartContent) {
                        try {
                            // Cleanup: Remove any lingering markdown ticks or whitespace
                            let cleanJson = rawChartContent.trim();
                            cleanJson = cleanJson.replace(/^```json/, '').replace(/```$/, '');
                            
                            chartConfig = JSON.parse(cleanJson);
                            
                            // Remove the raw JSON text from the bubble so it looks clean
                            // We construct a new regex based on the found content to remove it safely
                            text = text.replace(rawChartContent, '');
                            
                            // Also remove empty tags if they were left behind
                            text = text.replace(/<chart>\s*<\/chart>/i, '').replace(/<<<CHART>>>\s*<<<END_CHART>>>/i, '');
                            
                        } catch (e) {
                            console.error("Chart rendering attempt failed:", e);
                            // If parsing fails, we leave the text as is so the user at least sees the data
                        }
                    }

                    // 2. Process Text (Citations + Markdown)
                    const { html: textWithIcons, sources } = processCitations(text);
                    const contentDiv = document.createElement('div');
                    contentDiv.classList.add('ai-response-content', 'mb-2');
                    contentDiv.innerHTML = marked.parse(textWithIcons);
                    bubble.appendChild(contentDiv);

                    // 3. Render Chart (If config was successfully parsed)
                    if (chartConfig) {
                        const chartContainer = document.createElement('div');
                        chartContainer.style.marginTop = '1rem';
                        chartContainer.style.backgroundColor = '#1f2937';
                        chartContainer.style.padding = '10px';
                        chartContainer.style.borderRadius = '8px';
                        
                        const canvas = document.createElement('canvas');
                        chartContainer.appendChild(canvas);
                        bubble.appendChild(chartContainer);

                        new Chart(canvas, {
                            type: chartConfig.type,
                            data: chartConfig.data,
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: { labels: { color: 'white' } }
                                },
                                scales: {
                                    x: { 
                                        display: chartConfig.type !== 'pie' && chartConfig.type !== 'doughnut',
                                        ticks: { color: 'white' }, 
                                        grid: { color: '#374151' } 
                                    },
                                    y: { 
                                        display: chartConfig.type !== 'pie' && chartConfig.type !== 'doughnut',
                                        ticks: { color: 'white' }, 
                                        grid: { color: '#374151' } 
                                    }
                                }
                            }
                        });
                    }

                    // 4. Add Sources Footer
                    if (sources.length > 0) {
                        const footerDiv = document.createElement('div');
                        footerDiv.innerHTML = createSourcesFooter(sources);
                        bubble.appendChild(footerDiv);
                    }

                    // 5. Copy Button
                    const copyBtn = document.createElement('button');
                    copyBtn.className = 'text-xs text-gray-400 hover:text-white mt-2 block ml-auto';
                    copyBtn.textContent = 'Copy';
                    copyBtn.onclick = () => {
                        navigator.clipboard.writeText(text);
                        copyBtn.textContent = 'Copied!';
                        setTimeout(() => copyBtn.textContent = 'Copy', 1500);
                    };
                    bubble.appendChild(copyBtn);
                    
                    wrapper.appendChild(bubble);
                } 
                
                // --- LOGIC FOR USER MESSAGES (Edit & Copy) ---
                else {
                    bubble.textContent = text;

                    const actionsDiv = document.createElement('div');
                    actionsDiv.className = 'user-action-container';

                    // Edit
                    const editBtn = document.createElement('button');
                    editBtn.className = 'action-icon-btn';
                    editBtn.title = "Edit prompt";
                    editBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L6.832 19.82a4.5 4.5 0 01-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 011.13-1.897L16.863 4.487zm0 0L19.5 7.125" /></svg>`;
                    editBtn.onclick = () => {
                        userInput.value = text;
                        autoResizeTextarea(userInput);
                        userInput.focus();
                    };

                    // Copy
                    const copyBtnUser = document.createElement('button');
                    copyBtnUser.className = 'action-icon-btn';
                    copyBtnUser.title = "Copy text";
                    copyBtnUser.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v2.25A2.25 2.25 0 0113.5 22.5h-8.25a2.25 2.25 0 01-2.25-2.25v-8.25a2.25 2.25 0 012.25-2.25H5.25a2.25 2.25 0 012.25-2.25h1.5a.75.75 0 010 1.5H6a.75.75 0 00-.75.75v8.25c0 .414.336.75.75.75H13.5a.75.75 0 00.75-.75V11.25H18a.75.75 0 01.75.75v4.5a.75.75 0 00.75.75h1.5A2.25 2.25 0 0122.5 17.25v2.25a.75.75 0 001.5 0V17.25A2.25 2.25 0 0021.75 15h-1.5a.75.75 0 01-.75-.75V9.75a2.25 2.25 0 00-2.25-2.25H15z" /><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 7.125h-10.5a2.25 2.25 0 00-2.25 2.25v10.5" /></svg>`;
                    copyBtnUser.onclick = () => {
                        navigator.clipboard.writeText(text);
                        copyBtnUser.style.color = '#34d399';
                        setTimeout(() => copyBtnUser.style.color = '', 500);
                    };

                    actionsDiv.appendChild(editBtn);
                    actionsDiv.appendChild(copyBtnUser);
                    wrapper.appendChild(actionsDiv);
                    wrapper.appendChild(bubble);
                }

                chatArea.appendChild(wrapper);
                chatArea.scrollTop = chatArea.scrollHeight;
            }

            // Clear Chat
            clearChatBtn.onclick = () => {
                chatArea.innerHTML = '';
                chatHistory.length = 0;
                heroText.style.display = 'flex'; // Bring back the hero text
            };

            // My Prompts Logic
            function loadCustomPrompts() {
                myPromptsMenu.innerHTML = '';
                const saveBtn = document.createElement('button');
                saveBtn.className = 'sub-menu-btn text-emerald-400 font-bold';
                saveBtn.textContent = '+ Save Current Input';
                saveBtn.onclick = () => {
                    const txt = userInput.value.trim();
                    if(!txt) return alert("Type something to save.");
                    const name = prompt("Prompt Name:");
                    if(name) {
                        localStorage.setItem('customPrompt:'+name, txt);
                        loadCustomPrompts();
                    }
                };
                myPromptsMenu.appendChild(saveBtn);

                Object.keys(localStorage).forEach(key => {
                    if(key.startsWith('customPrompt:')) {
                        const name = key.replace('customPrompt:', '');
                        const btn = document.createElement('button');
                        btn.className = 'sub-menu-btn';
                        btn.textContent = name;
                        btn.onclick = () => {
                            userInput.value = localStorage.getItem(key);
                            autoResizeTextarea(userInput);
                            toggleMenu(myPromptsMenu);
                        };
                        myPromptsMenu.appendChild(btn);
                    }
                });
            }
            loadCustomPrompts();

            // ============================================
            // 5. GENERATE TAKEAWAYS (PDF Report)
            // ============================================
            generateTakeawaysBtn.addEventListener('click', async function() {
                if (chatHistory.length <= 1) {
                    return alert('No conversation to analyze yet. Please start a project first.');
                }

                // 1. UI Feedback
                const originalText = generateTakeawaysBtn.textContent;
                generateTakeawaysBtn.textContent = 'Generating Report...';
                generateTakeawaysBtn.disabled = true;
                
                // 2. Construct the Analysis Prompt
                const analysisPrompt = `Based on our conversation so far, write a formal **Executive Takeaways Report**.
                
                The output must use clean Markdown headers and bullet points. Follow this structure:
                # Executive Summary
                [High-level overview of the project status]
                
                # Key Insights
                [Bullet points of critical findings]
                
                # Strategic Recommendations
                [Actionable advice based on the analysis]
                
                # Immediate Next Steps
                [What needs to happen next week]
                
                Do not include conversational filler like "Here is your report." Just give the document content.`;

                const tempHistory = [...chatHistory, { role: "user", parts: [{ text: analysisPrompt }] }];

                try {
                    // 3. Call API
                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            systemInstruction: { parts: [{ text: "You are a Senior Partner Consultant writing a formal deliverable." }] },
                            messages: tempHistory
                        })
                    });

                    const result = await response.json();
                    const reportContent = result?.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (!reportContent) throw new Error("No analysis returned from Bob.");

                    // 4. Create Hidden Container for PDF
                    const reportContainer = document.createElement('div');
                    reportContainer.style.width = '800px';
                    reportContainer.style.padding = '40px';
                    reportContainer.style.fontFamily = 'Georgia, serif';
                    reportContainer.style.color = '#111827';
                    
                    const projName = currentProjectNameDisplay.textContent || "Consulting Session";
                    const date = new Date().toLocaleDateString();

                    // 5. Build HTML
                    let cleanContent = marked.parse(reportContent);
                    // Remove charts from the PDF text to keep it clean
                    cleanContent = cleanContent.replace(/(?:<<<CHART>>>|<chart>|<<>>)([\s\S]*?)(?:<<<END_CHART>>>|<\/chart>|<<>>)/gi, '');

                    reportContainer.innerHTML = `
                        <div style="text-align: center; margin-bottom: 50px; padding-bottom: 20px; border-bottom: 2px solid #059669;">
                            <h1 style="font-size: 32px; margin-bottom: 10px; color: #065f46;">Executive Takeaways Report</h1>
                            <h2 style="font-size: 18px; color: #4b5563; margin-top: 0;">Project: ${projName}</h2>
                            <p style="color: #9ca3af; font-size: 14px; margin-top: 5px;">Generated on ${date}</p>
                        </div>
                        <div style="font-size: 14px; line-height: 1.6;">
                            ${cleanContent}
                        </div>
                        <div style="margin-top: 50px; border-top: 1px solid #e5e7eb; padding-top: 20px; text-align: center; font-size: 10px; color: #9ca3af;">
                            Generated by Bob the Consulting Assistant
                        </div>
                    `;

                    // 6. Generate & Download
                    const opt = {
                        margin:       [0.5, 0.5],
                        filename:     `${projName.replace(/\s+/g, '_')}_Takeaways.pdf`,
                        image:        { type: 'jpeg', quality: 0.98 },
                        html2canvas:  { scale: 2 },
                        jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' }
                    };

                    html2pdf().set(opt).from(reportContainer).save().then(() => {
                        generateTakeawaysBtn.textContent = originalText;
                        generateTakeawaysBtn.disabled = false;
                        createMessageBubble(" **Report Generated:** The Executive Takeaways PDF has been downloaded.", "model");
                    });

                } catch (error) {
                    console.error("Report Error:", error);
                    alert("Failed to generate report.");
                    generateTakeawaysBtn.textContent = originalText;
                    generateTakeawaysBtn.disabled = false;
                }
            });

            // Export Chat as Professional PDF
            exportBtn.onclick = () => {
                if (chatHistory.length === 0) return alert("No conversation to export.");

                // 1. Create a temporary container for the report
                const reportContainer = document.createElement('div');
                reportContainer.style.width = '800px'; // Standard A4 width scale
                reportContainer.style.padding = '40px';
                reportContainer.style.fontFamily = 'Georgia, serif';
                reportContainer.style.color = '#111827';
                
                // 2. Get Project Name
                const projName = currentProjectNameDisplay.textContent || "Strategy Session";
                const date = new Date().toLocaleDateString();

                // 3. Build Cover Page
                let htmlContent = `
                    <div style="text-align: center; margin-bottom: 60px; padding-bottom: 20px; border-bottom: 2px solid #10b981;">
                        <h1 style="font-size: 32px; margin-bottom: 10px; color: #065f46;">Strategic Analysis Report</h1>
                        <h2 style="font-size: 24px; color: #374151; margin-top: 0;">${projName}</h2>
                        <p style="color: #6b7280; margin-top: 10px;">Generated on ${date}</p>
                    </div>
                `;

                // 4. Format Content
                chatHistory.forEach(msg => {
                    const role = msg.role === 'user' ? 'Client Input' : 'Strategic Analysis';
                    const color = msg.role === 'user' ? '#059669' : '#1f2937'; // Green title for user, Dark for AI
                    
                    // Parse markdown for the PDF
                    // We strip citations/charts for the print version to keep it clean text, 
                    // or keep simple markdown.
                    let content = marked.parse(msg.parts[0].text);
                    
                    // Remove complex chart JSON from PDF output to avoid clutter
                    content = content.replace(/(?:<<<CHART>>>|<chart>|<<>>)([\s\S]*?)(?:<<<END_CHART>>>|<\/chart>|<<>>)/gi, '<em>[Chart Data Visualized in Dashboard]</em>');

                    htmlContent += `
                        <div style="margin-bottom: 30px;">
                            <h4 style="color: ${color}; font-family: 'Roboto Slab', serif; border-bottom: 1px solid #e5e7eb; padding-bottom: 5px; margin-bottom: 10px; text-transform: uppercase; font-size: 12px; letter-spacing: 1px;">${role}</h4>
                            <div style="font-size: 14px; line-height: 1.6;">${content}</div>
                        </div>
                    `;
                });

                // 5. Footer
                htmlContent += `
                    <div style="margin-top: 50px; border-top: 1px solid #e5e7eb; padding-top: 20px; text-align: center; font-size: 10px; color: #9ca3af;">
                        Generated by Bob the Consulting Assistant
                    </div>
                `;

                reportContainer.innerHTML = htmlContent;

                // 6. Generate PDF
                const opt = {
                    margin:       [0.5, 0.5],
                    filename:     `${projName.replace(/\s+/g, '_')}_Report.pdf`,
                    image:        { type: 'jpeg', quality: 0.98 },
                    html2canvas:  { scale: 2 },
                    jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' }
                };

                // Use the library (it creates the PDF from the container)
                html2pdf().set(opt).from(reportContainer).save();
            };

        })();
    </script>
</body>
</html>
