<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulting Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PDF.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Georgia:wght@400;700&family=Roboto+Slab:wght=700&display=swap');
        
        body {
            font-family: 'Georgia', sans-serif;
            background-color: #111827; /* Gray 900 */
            color: #f3f4f6;
            height: 100vh;
            overflow: hidden; /* Prevent body scroll, handle inside containers */
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        /* Typography for AI Responses */
        .ai-response-content h1 { font-size: 1.5rem; font-weight: 700; margin-bottom: 0.75rem; color: #bef264; }
        .ai-response-content h2 { font-size: 1.25rem; font-weight: 700; margin-top: 1rem; margin-bottom: 0.5rem; color: #bef264; }
        .ai-response-content h3 { font-size: 1.1rem; font-weight: 700; margin-top: 0.75rem; color: #facc15; }
        .ai-response-content ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 0.75rem; }
        .ai-response-content li { margin-bottom: 0.25rem; }
        .ai-response-content strong { color: #facc15; }
        
        /* Table Styling */
        .ai-response-content table { width: 100%; border-collapse: collapse; margin-top: 0.5rem; font-size: 0.9rem; }
        .ai-response-content th, .ai-response-content td { border: 1px solid #4b5563; padding: 0.5rem; text-align: left; }
        .ai-response-content th { background-color: #374151; color: #f3f4f6; }
        .ai-response-content td { background-color: #1f2937; }

        /* Sidebar Buttons */
        .sidebar-btn {
            font-family: 'Roboto Slab', serif;
            width: 100%;
            text-align: left;
            padding: 0.75rem 1rem;
            background-color: #1f2937; /* Gray 800 */
            border: 1px solid #374151;
            border-radius: 0.5rem;
            color: #e5e7eb;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .sidebar-btn:hover { background-color: #374151; border-color: #10b981; }
        
        /* Submenu styling in sidebar */
        .sidebar-menu {
            background-color: #111827;
            border: 1px solid #374151;
            border-radius: 0.5rem;
            margin-top: 0.25rem;
            overflow: hidden;
        }
        .sub-menu-btn {
            display: block;
            width: 100%;
            text-align: left;
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
            color: #9ca3af;
            transition: color 0.2s, background-color 0.2s;
        }
        .sub-menu-btn:hover { color: #10b981; background-color: #1f2937; }

        /* Utility Buttons (Right Side) - Updated */
        .utility-btn {
            width: 100%;
            height: 42px; /* Fixed height for uniformity */
            padding: 0 1rem;
            background-color: #4b5563;
            color: white;
            border-radius: 0.5rem;
            font-weight: bold;
            font-size: 0.85rem;
            margin-bottom: 0.75rem;
            transition: all 0.2s;
            /* Centering Logic */
            display: flex; 
            justify-content: center; 
            align-items: center;
            position: relative; 
        }
        .utility-btn:hover { background-color: #6b7280; }
        
        /* Force the arrow icon to the far right so text stays centered */
        .utility-btn svg {
            position: absolute;
            right: 12px;
        }

        /* User Message Actions (Copy/Edit) */
        .message-wrapper:hover .user-action-container {
            opacity: 1;
        }
        
        .user-action-container {
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
            display: flex;
            gap: 0.5rem;
            align-items: center;
            margin-right: 0.75rem;
        }
        
        .action-icon-btn {
            padding: 6px;
            border-radius: 50%;
            color: #9ca3af; /* Gray-400 */
            background-color: #1f2937; /* Dark background */
            border: 1px solid #374151;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .action-icon-btn:hover {
            color: #f3f4f6;
            background-color: #374151;
            border-color: #10b981; /* Emerald border */
        }
        
        /* Input Area Styling */
        #userInput {
            line-height: 1.5;
            resize: none; 
            max-height: 150px;
        }
    /* === CITATION STYLES === */
        .citation-link {
            display: inline-block;
            vertical-align: middle;
            margin-left: 2px;
            background-color: #374151;
            border-radius: 50%;
            padding: 2px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .citation-link:hover { background-color: #4b5563; }
        .citation-link svg { width: 14px; height: 14px; color: #9ca3af; }

        .sources-section {
            margin-top: 1rem;
            border-top: 1px solid #374151;
            padding-top: 0.75rem;
        }

        .sources-toggle-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background-color: transparent;
            border: 1px solid #6b7280;
            color: #d1d5db;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            transition: all 0.2s;
        }
        .sources-toggle-btn:hover { background-color: #374151; border-color: #9ca3af; }

        .sources-list {
            margin-top: 0.75rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .source-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
            color: #93c5fd;
            text-decoration: none;
            padding: 0.25rem;
            border-radius: 0.25rem;
        }
        .source-item:hover { background-color: #1f2937; text-decoration: underline; }
        .source-favicon { width: 16px; height: 16px; background-color: #fff; border-radius: 2px; }
    </style>
</head>
<body class="flex h-screen w-full bg-gray-900">

    <!-- LEFT SIDEBAR (Phases) -->
    <aside class="w-64 bg-gray-800 border-r border-gray-700 flex flex-col flex-shrink-0 z-20">
       <!-- Logo Area -->
        <div class="p-6 border-b border-gray-700 flex items-center gap-3">
            <div class="p-1.5 bg-white rounded-full border-2 border-green-700 flex-shrink-0">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" width="28" height="28">
                    <circle cx="50" cy="50" r="8" fill="none" stroke="#4a5d3e" stroke-width="4"/>
                    <g stroke="#4a5d3e" stroke-width="3" fill="none">
                        <line x1="50" y1="50" x2="50" y2="20"/><circle cx="50" cy="20" r="6"/>
                        <line x1="50" y1="50" x2="75" y2="30"/><circle cx="75" cy="30" r="6"/>
                        <line x1="50" y1="50" x2="75" y2="70"/><circle cx="75" cy="70" r="6"/>
                        <line x1="50" y1="50" x2="50" y2="80"/><circle cx="50" cy="80" r="6"/>
                        <line x1="50" y1="50" x2="25" y2="70"/><circle cx="25" cy="70" r="6"/>
                        <line x1="50" y1="50" x2="25" y2="30"/><circle cx="25" cy="30" r="6"/>
                    </g>
                </svg>
            </div>
            <h1 class="font-bold text-lg text-white tracking-wide">Bob Assistant</h1>
        </div>

        <!-- PROJECT CONTROLS (Always Visible) -->
        <div class="p-4 border-b border-gray-700 space-y-2">
            <button id="newProjectBtn" class="w-full py-2 px-3 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg font-bold text-sm transition flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                New Project
            </button>
            <button id="loadProjectBtn" class="w-full py-2 px-3 bg-gray-700 hover:bg-gray-600 text-gray-200 rounded-lg font-bold text-sm transition flex items-center justify-center gap-2 border border-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.75V12A2.25 2.25 0 014.5 9.75h15A2.25 2.25 0 0121.75 12v.75m-8.69-6.44l-2.12-2.12a1.5 1.5 0 00-1.061-.44H4.5A2.25 2.25 0 002.25 6v12a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9a2.25 2.25 0 00-2.25-2.25h-5.379a1.5 1.5 0 01-1.06-.44z" /></svg>
                Load Project
            </button>
        </div>

        <!-- PHASE MENUS (Hidden by default) -->
        <div id="phaseMenuContainer" class="hidden flex-1 overflow-y-auto p-4 space-y-4 opacity-50 transition-opacity duration-500">
            
            <div class="text-xs text-gray-500 font-bold uppercase tracking-widest mb-2">Project Phases</div>

            <!-- Phase 1 -->
            <div>
                <button id="initialSetupDropdownBtn" class="sidebar-btn">
                    Initial Setup
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>
                <div id="initialSetupMenu" class="sidebar-menu hidden"></div>
            </div>

            <!-- Phase 2 -->
            <div>
                <button id="analysisDropdownBtn" class="sidebar-btn">
                    Analysis
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>
                <div id="analysisMenu" class="sidebar-menu hidden"></div>
            </div>

            <!-- Phase 3 -->
            <div>
                <button id="solutionDesignDropdownBtn" class="sidebar-btn">
                    Solution Design
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>
                <div id="solutionDesignMenu" class="sidebar-menu hidden"></div>
            </div>

            <!-- Phase 4 -->
            <div>
                <button id="executionDropdownBtn" class="sidebar-btn">
                    Execution
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>
                <div id="executionMenu" class="sidebar-menu hidden"></div>
            </div>
            
            <!-- Current Project Indicator -->
            <div id="currentProjectBadge" class="mt-6 p-3 bg-gray-900 rounded border border-gray-700 text-center hidden">
                <div class="text-xs text-gray-500">Active Project</div>
                <div id="currentProjectNameDisplay" class="text-sm font-bold text-emerald-400 truncate"></div>
            </div>

        </div>
    </aside>

    <!-- CENTER CHAT AREA -->
    <main class="flex-1 flex flex-col relative bg-gray-900">
        
        <!-- Chat History Container (The "Grey Box") -->
        <div id="chatArea" class="flex-1 overflow-y-auto p-8 space-y-6">
            <!-- Messages will be injected here -->
        </div>

        <!-- HERO TEXT (Initially Visible, Hides on Chat) -->
        <div id="heroText" class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none z-0">
            <h2 class="text-4xl font-bold text-gray-200 tracking-tight drop-shadow-lg">Should we start building?</h2>
            <p class="text-gray-500 mt-2">Select a phase from the left or type below.</p>
        </div>

        <!-- Input Area (Fixed Bottom) -->
        <div class="p-6 bg-gray-900 z-10">
            <div class="max-w-4xl mx-auto relative flex items-end gap-2 bg-[#2f2f2f] p-2 rounded-[2rem] border border-gray-700 shadow-xl focus-within:border-emerald-500 focus-within:ring-1 focus-within:ring-emerald-500 transition-all">
                
                <!-- Hidden File Input -->
                <input type="file" id="hiddenFileInput" style="display: none;" accept=".txt,.md,.csv,.json,.js,.html,.css,.xml,.pdf">
                
                <!-- Attachment Button -->
                <button id="attachBtn" class="p-3 text-gray-400 hover:text-white transition-colors rounded-full hover:bg-gray-700 flex-shrink-0" title="Attach file">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M18.375 12.739l-7.693 7.693a4.5 4.5 0 01-6.364-6.364l10.94-10.94A3 3 0 1119.5 7.372L8.552 18.32m.009-.01l-.01.01m5.699-9.941l-7.81 7.81a1.5 1.5 0 002.112 2.13" />
                    </svg>
                </button>

                <!-- Text Area -->
                <textarea id="userInput" 
                    placeholder="Ask a question..." 
                    rows="1" 
                    class="w-full bg-transparent text-gray-100 placeholder-gray-500 border-none focus:ring-0 resize-none overflow-y-hidden py-3 text-base leading-relaxed max-h-32"
                    style="min-height: 48px;"></textarea>

                <!-- Send Button -->
                <button id="sendButton" class="p-3 bg-emerald-600 text-white rounded-full hover:bg-emerald-500 transition-transform transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed shadow-lg flex-shrink-0 mb-0.5">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 10.5L12 3m0 0l7.5 7.5M12 3v18" />
                    </svg>
                </button>
            </div>
            <p class="text-center text-xs text-gray-500 mt-2">Bob can make mistakes. Verify important information.</p>
        </div>
    </main>

    <!-- RIGHT SIDEBAR (Utilities) -->
    <aside class="w-64 bg-gray-800 border-l border-gray-700 flex flex-col flex-shrink-0 z-20 p-4">
        
        <!-- WRAPPER FOR TOGGLING VISIBILITY -->
        <div id="toolsMenuContainer" class="hidden w-full h-full flex flex-col">
            
            <h3 class="text-gray-400 text-xs font-bold uppercase tracking-wider mb-4 text-center">Tools</h3>
            
            <!-- My Prompts -->
            <div class="relative mb-0"> 
                <button id="myPromptsDropdownBtn" class="utility-btn">
                    My Prompts
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>
                <div id="myPromptsMenu" class="absolute hidden top-full left-0 w-full bg-gray-700 rounded-lg shadow-xl z-30 border border-gray-600 p-2 mt-1"></div>
            </div>

            <!-- Takeaways -->
            <button id="generateTakeawaysBtn" class="utility-btn">Generate Takeaways</button>

            <!-- Workflow -->
            <div class="relative mb-0">
                <button id="workflowBtn" class="utility-btn">
                    Run Workflow
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>
                <div id="workflowMenu" class="absolute hidden top-full right-0 w-64 bg-gray-700 rounded-lg shadow-xl z-30 border border-gray-600 p-2 mt-1">
                    <button class="workflow-option w-full text-left px-3 py-2 text-sm text-gray-200 hover:bg-gray-600 rounded" data-workflow="market-entry-strategy">Market Entry Strategy</button>
                    <button class="workflow-option w-full text-left px-3 py-2 text-sm text-gray-200 hover:bg-gray-600 rounded" data-workflow="business-health-check">Business Health Check</button>
                    <button class="workflow-option w-full text-left px-3 py-2 text-sm text-gray-200 hover:bg-gray-600 rounded" data-workflow="competitive-analysis">Competitive Analysis</button>
                </div>
            </div>

            <!-- Export -->
            <button id="exportBtn" class="utility-btn">Export Chat</button>

            <div class="flex-grow"></div> <!-- Spacer -->

            <!-- Clear Chat -->
            <button id="clearChatBtn" class="w-full px-4 py-2 border border-red-500 text-red-400 rounded-lg hover:bg-red-900/20 transition text-sm font-bold flex justify-center items-center">
                Clear Chat
            </button>
        </div>
        
        <!-- Placeholder when no project selected -->
        <div id="noProjectToolState" class="flex-1 flex items-center justify-center text-center text-gray-600 text-sm p-4">
            Select a project to access tools
        </div>

    </aside>
    <script>
        (function() {
            // ELEMENT REFERENCES
            const sendButton = document.getElementById('sendButton');
            const userInput = document.getElementById('userInput');
            const chatArea = document.getElementById('chatArea');
            const heroText = document.getElementById('heroText'); // The "Should we start..." text
            const clearChatBtn = document.getElementById('clearChatBtn');
            const generateTakeawaysBtn = document.getElementById('generateTakeawaysBtn');
            const attachBtn = document.getElementById('attachBtn');
            const hiddenFileInput = document.getElementById('hiddenFileInput');

            // DROPDOWN ELEMENTS
            const initialSetupDropdownBtn = document.getElementById('initialSetupDropdownBtn');
            const initialSetupMenu = document.getElementById('initialSetupMenu');
            const analysisDropdownBtn = document.getElementById('analysisDropdownBtn');
            const analysisMenu = document.getElementById('analysisMenu');
            const solutionDesignDropdownBtn = document.getElementById('solutionDesignDropdownBtn');
            const solutionDesignMenu = document.getElementById('solutionDesignMenu');
            const executionDropdownBtn = document.getElementById('executionDropdownBtn');
            const executionMenu = document.getElementById('executionMenu');
            const myPromptsDropdownBtn = document.getElementById('myPromptsDropdownBtn');
            const myPromptsMenu = document.getElementById('myPromptsMenu');
            const workflowBtn = document.getElementById('workflowBtn');
            const workflowMenu = document.getElementById('workflowMenu');
            const exportBtn = document.getElementById('exportBtn');

            let MIN_HEIGHT = 0; 
            const chatHistory = [];
            let awaitingPlanResponse = false;
            let attachedFileContent = null;
            let attachedFileName = null;

            // ============================================
            // 0. PROJECT MANAGEMENT SYSTEM
            // ============================================
            let currentProjectId = null;
            const phaseMenuContainer = document.getElementById('phaseMenuContainer');
            const toolsMenuContainer = document.getElementById('toolsMenuContainer');
            const noProjectToolState = document.getElementById('noProjectToolState');
            const currentProjectBadge = document.getElementById('currentProjectBadge');
            const currentProjectNameDisplay = document.getElementById('currentProjectNameDisplay');

            // Load Project List from LocalStorage
            function getProjects() {
                return JSON.parse(localStorage.getItem('bob_projects_index') || '[]');
            }

            // Save Chat to Current Project
            function saveCurrentProjectChat() {
                if (!currentProjectId) return;
                localStorage.setItem(`bob_project_${currentProjectId}_chat`, JSON.stringify(chatHistory));
            }

            // Switch to a specific project
            function activateProject(id, name) {
                currentProjectId = id;
                
                // 1. Update UI Visibility
                phaseMenuContainer.classList.remove('hidden', 'opacity-50');
                phaseMenuContainer.classList.add('opacity-100');
                toolsMenuContainer.classList.remove('hidden');
                noProjectToolState.classList.add('hidden');
                
                // 2. Update Hero Text
                heroText.style.display = 'none';
                
                // 3. Update Badge
                currentProjectBadge.classList.remove('hidden');
                currentProjectNameDisplay.textContent = name;

                // 4. Load Chat History
                chatArea.innerHTML = ''; // Clear screen
                chatHistory.length = 0; // Clear array
                
                const savedChat = JSON.parse(localStorage.getItem(`bob_project_${id}_chat`) || '[]');
                
                if (savedChat.length > 0) {
                    savedChat.forEach(msg => {
                        // Re-render bubbles without re-saving (since they are already saved)
                        chatHistory.push(msg); // Add to memory
                        
                        // Manually create bubble to avoid double-save loop
                        // We use a simplified version of logic here just for rendering
                        const wrapper = document.createElement('div');
                        wrapper.classList.add('flex', 'message-wrapper', 'mb-4', msg.role === 'user' ? 'justify-end' : 'justify-start');
                        const bubble = document.createElement('div');
                        bubble.classList.add('rounded-xl', 'p-4', 'max-w-2xl', 'shadow-md', msg.role === 'user' ? 'bg-emerald-600' : 'bg-gray-800', 'text-gray-100');
                        
                        if (msg.role === 'model') {
                             const { html } = processCitations(msg.parts[0].text);
                             bubble.innerHTML = `<div class="ai-response-content mb-2">${marked.parse(html)}</div>`;
                        } else {
                             bubble.textContent = msg.parts[0].text;
                        }
                        wrapper.appendChild(bubble);
                        chatArea.appendChild(wrapper);
                    });
                    // Scroll to bottom
                    setTimeout(() => chatArea.scrollTop = chatArea.scrollHeight, 100);
                } else {
                    // New Project: Show Hero Text
                     heroText.style.display = 'flex';
                }
            }

            // EVENT: New Project
            document.getElementById('newProjectBtn').onclick = () => {
                const name = prompt("Enter Project Name (e.g., 'Q3 Sales Strategy'):");
                if (!name) return;

                const id = Date.now().toString();
                const projects = getProjects();
                projects.push({ id, name, date: new Date().toISOString() });
                localStorage.setItem('bob_projects_index', JSON.stringify(projects));
                
                activateProject(id, name);
            };

            // EVENT: Load Project
            document.getElementById('loadProjectBtn').onclick = () => {
                const projects = getProjects();
                if (projects.length === 0) return alert("No saved projects found.");

                // Simple prompt selection (can be upgraded to modal later)
                let list = "Select a project by number:\n";
                projects.forEach((p, i) => list += `${i + 1}. ${p.name}\n`);
                
                const choice = prompt(list);
                if (choice && projects[choice - 1]) {
                    activateProject(projects[choice - 1].id, projects[choice - 1].name);
                }
            };

            // ============================================
            // 1. PROMPT MAP (STRUCTURED & CATEGORIZED)
            // ============================================
            const PROMPT_MAP = {
                
                // ========================
                // PHASE 1: INITIAL SETUP
                // ========================
                
                'Guided Diagnostic (Interviewer Mode)': `Act as a Senior Partner Consultant conducting a diagnostic interview. I have a business problem: [input BRIEF PROBLEM DESCRIPTION].

Do NOT provide a solution yet. Instead, generate a structured interview protocol to diagnose the root cause.

The output MUST follow this structure:

# Guided Diagnostic: [Problem Name]
## Objective
[Concise statement of what we need to uncover]

## Diagnostic Questions (Please answer these)
1. **[Topic A]:** [Specific probing question about root cause]
2. **[Topic B]:** [Specific probing question about constraints]
3. **[Topic C]:** [Specific probing question about success metrics]
4. **[Topic D]:** [Specific probing question about stakeholders]

## Next Steps
Once you answer these, I will analyze the root causes.`,

                'Industry Trends Snapshot': `Generate a **rapid, high-level Industry Trends Snapshot** for [input SPECIFIED INDUSTRY]. 

The output MUST strictly follow this high-readability structure:

# [Industry] Trends Snapshot
[concise, clear introductory explanation]

## Key Trend 1: [Trend Name]
* [concise, clear bullet point 1]
* [concise, clear bullet point 2]
* [concise, clear bullet point 3]

## Key Trend 2: [Trend Name]
* [concise, clear bullet point 1]
* [concise, clear bullet point 2]
* [concise, clear bullet point 3]
... (3 to 5 trends total)

## Summary Table
| Trend | Primary Impact |
|---|---|
| [Trend 1 Name] | * [Impact bullet 1] <br> * [Impact bullet 2] |
| [Trend 2 Name] | * [Impact bullet 1] <br> * [Impact bullet 2] |
| [Trend 3 Name] | * [Impact bullet 1] <br> * [Impact bullet 2] |

The table must be the last element of the response before the suggestions block.`,
              
                'Initial Project Charter Draft': `Generate an Initial Project Charter Draft for [input SPECIFIC PROJECT TYPE, e.g., 'implementing a new cloud-based CRM system for the sales department']. 

The output MUST strictly follow this professional structure:

# Project Charter: [Project Title]
[Short introductory summary of the project goal]

## Project Details
| Field | Value |
|---|---|
| Project Sponsor | [Placeholder Name/Title] |
| Project Manager | [Placeholder Name/Title] |
| Target Completion | [Date/Quarter] |

## Scope Overview
[1-2 paragraphs defining what is included (in scope) and what is explicitly excluded (out of scope).]

## Key Objectives
* [Measurable objective 1 (SMART)]
* [Measurable objective 2 (SMART)]
* [Measurable objective 3 (SMART)]

## Success Metrics (Key Performance Indicators)
* [Metric 1: Definition of success]
* [Metric 2: Definition of success]
* [Metric 3: Definition of success]

## High-Level Timeline (Phases)
* Phase 1: Initiation and Planning ([Duration])
* Phase 2: Execution and Development ([Duration])
* Phase 3: Deployment and Stabilization ([Duration])

The timeline must be the last element of the response before the suggestions block.`,
              
                'Problem Statement Draft': `Draft a Preliminary Problem Statement for [input SPECIFIC ISSUE, e.g., 'Customer retention has dropped by 10% in the last quarter']. 

The output MUST strictly follow the Current State, Desired State, Impact structure using Markdown headings and paragraphs:

# Preliminary Problem Statement
[A single introductory sentence about why this problem is critical.]

## 1. Current State (The Symptom)
[A concise paragraph describing the current measurable negative business symptom, its magnitude, and where it is occurring.]

## 2. Desired State (The Goal)
[A concise paragraph describing the measurable target outcome and the benefit of achieving it.]

## 3. Impact of Solving (The Value)
[A concise paragraph describing the strategic or financial value derived by the business upon successful achievement of the desired state.]

The "Impact of Solving" section must be the last element of the response before the suggestions block.`,
              
                // ========================
                // PHASE 2: ANALYSIS
                // ========================

                'MECE Logic Check': `Perform a MECE (Mutually Exclusive, Collectively Exhaustive) audit on the following analysis or problem statement: [input PASTE ANALYSIS OR PROBLEM HERE].

The output MUST follow this structure:

# MECE Logic Audit
[Brief assessment of the current logic's tightness]

## Logic Gaps (Missing Elements)
* [Gap 1 - What did we forget?]
* [Gap 2 - What did we forget?]

## Overlaps (Redundancies)
* [Overlap 1 - Where are we double counting?]

## Proposed MECE Framework
Reorganize the analysis into distinct, non-overlapping buckets:
1. **[Bucket 1]**
   * [Point A]
   * [Point B]
2. **[Bucket 2]**
   * [Point C]
   * [Point D]`,

                'Market Analysis': `Conduct a market analysis for [input SPECIFIC MARKET / INDUSTRY]. Focus on key trends, the competitive landscape, and the future outlook. 

The output MUST strictly follow this high-readability structure:

# [Analysis Title]
[concise, clear introductory explanation]

## Key Trends
* [concise, clear bullet point 1]
* [concise, clear bullet point 2]
...

## Competitive Landscape
| Competitor | Market Share/Focus | Key Strengths/Weaknesses |
|---|---|---|
| [Name 1] | [Focus] | * [Strength 1] <br> * [Weakness 1] |
| [Name 2] | [Focus] | * [Strength 1] <br> * [Weakness 1] |

## Future Outlook
* [concise, clear bullet point 1]
* [concise, clear bullet point 2]
...

The table must be the last element before the suggestions block.`,
              
                'SWOT Analysis': `Perform a SWOT analysis for [input SPECIFIC COMPANY / PROJECT]. The analysis should be grounded in recent information.

The output MUST strictly follow this structure:

# SWOT Analysis for [Company/Project]
[A concise paragraph explaining the current situation and objective.]

## Analysis Matrix
| Strengths | Weaknesses | Opportunities | Threats |
|---|---|---|---|
| * [Bullet point 1] <br> * [Bullet point 2] | * [Bullet point 1] <br> * [Bullet point 2] | * [Bullet point 1] <br> * [Bullet point 2] | * [Bullet point 1] <br> * [Bullet point 2] |
| * [Bullet point 3] | * [Bullet point 3] | * [Bullet point 3] | * [Bullet point 3] |

The table must be the last element of the response before the suggestions block.`,
              
                'Competitor Benchmarking': `Perform a detailed competitive analysis for [input COMPANY A] against [input COMPETITOR B] and [input COMPETITOR C]. Focus on their market share, product features, pricing models, and online presence. 

The output MUST strictly follow this structure:

# Competitor Benchmarking Report
[A brief introduction defining the competitive scope.]

## Benchmarking Table
| Competitor | Market Share/Focus | Product Features | Pricing Model | Online Presence |
|---|---|---|---|---|
| **[Competitor B]** | [Share/Focus] | * [Feature 1] <br> * [Feature 2] | [Model description] | [Score/Metric] |
| **[Competitor C]** | [Share/Focus] | * [Feature 1] <br> * [Feature 2] | [Model description] | [Score/Metric] |

The table must be the last element of the response before the suggestions block.`,
              
                '5 Forces Analysis': `Conduct a 5 Forces Analysis for [input SPECIFIC INDUSTRY]. Analyze the threat of new entrants, the bargaining power of buyers, the bargaining power of suppliers, the threat of substitute products, and competitive rivalry.

The output MUST strictly follow this structure:

# Porter's Five Forces Analysis: [Industry]
[A concise introductory paragraph about the industry's profitability outlook.]

## Industry Structure Summary
| Force | Threat Level (High/Medium/Low) | Key Drivers/Evidence |
|---|---|---|
| **Threat of New Entrants** | [Level] | * [Driver 1] <br> * [Driver 2] |
| **Bargaining Power of Buyers** | [Level] | * [Driver 1] <br> * [Driver 2] |
| **Bargaining Power of Suppliers** | [Level] | * [Driver 1] <br> * [Driver 2] |
| **Threat of Substitutes** | [Level] | * [Driver 1] <br> * [Driver 2] |
| **Competitive Rivalry** | [Level] | * [Driver 1] <br> * [Driver 2] |

The table must be the last element of the response before the suggestions block.`,
              
                'PESTLE Analysis': `Perform a PESTLE analysis for [input SPECIFIC COMPANY / INDUSTRY]. Analyze the Political, Economic, Social, Technological, Legal, and Environmental factors.

The output MUST strictly follow this structure:

# PESTLE Analysis for [Company/Industry]
[A brief introduction explaining the purpose of the analysis.]

The remaining analysis MUST be presented in a specific two-column table format where the 'Key Findings' column contains bullet points separated by line breaks (<br>).

| Factor | Key Findings |
|---|---|
| **Political** | * [concise finding 1] <br> * [concise finding 2] |
| **Economic** | * [concise finding 1] <br> * [concise finding 2] |
| **Social** | * [concise finding 1] <br> * [concise finding 2] |
| **Technological** | * [concise finding 1] <br> * [concise finding 2] |
| **Legal** | * [concise finding 1] <br> * [concise finding 2] |
| **Environmental** | * [concise finding 1] <br> * [concise finding 2] |

The table must be the last element of the response before the suggestions block.`,

                'Hofstede Analysis': `Perform a Hofstede's Cultural Dimensions analysis for [input SPECIFIC COUNTRY/CULTURE] focusing on its implications for [input SPECIFIC BUSINESS SCENARIO, e.g., 'market entry strategy' or 'managing a remote team']. 
                
The output MUST strictly follow this structure:

# Hofstede's Cultural Analysis: [Country]
[A concise introductory paragraph explaining the purpose of the analysis.]

## Cultural Dimensions Summary
| Dimension | Score/Rating | Business Implication |
|---|---|---|
| **Power Distance (PDI)** | [Score/Rating] | * [Implication 1] <br> * [Implication 2] |
| **Individualism vs. Collectivism (IDV)** | [Score/Rating] | * [Implication 1] <br> * [Implication 2] |
| **Masculinity vs. Femininity (MAS)** | [Score/Rating] | * [Implication 1] <br> * [Implication 2] |
| **Uncertainty Avoidance (UAI)** | [Score/Rating] | * [Implication 1] <br> * [Implication 2] |
| **Long-Term vs. Short-Term Orientation (LTO)** | [Score/Rating] | * [Implication 1] <br> * [Implication 2] |
| **Indulgence vs. Restraint (IVR)** | [Score/Rating] | * [Implication 1] <br> * [Implication 2] |

The table must be the last element of the response before the suggestions block.`,
                
                // ========================
                // PHASE 3: SOLUTION DESIGN
                // ========================

                "Devil's Advocate Review": `I want you to stress-test my current strategy/solution. Switch personas to a skeptical "Red Team" or "Devil's Advocate."
                
The output MUST follow this structure:

# Strategic Stress Test
[Introductory critique of the proposed plan]

## Critical Flaws & Assumptions
| Assumption | Probability of Failure | Impact |
|---|---|---|
| [Assumption 1] | [High/Med/Low] | [High/Med/Low] |
| [Assumption 2] | [High/Med/Low] | [High/Med/Low] |

## The "Pre-Mortem" (Worst Case)
* [Scenario description if the plan fails strictly]

## Cognitive Bias Check
* [Identify biases like Sunk Cost, Confirmation Bias, etc.]`,

                'Business Plan Outline': `Draft a comprehensive business plan outline for a [input YOUR BUSINESS IDEA]. 

The output MUST strictly follow this structure:

# Business Plan Outline: [Your Business Idea]
[A concise introductory summary paragraph.]

## Executive Summary
* [Core Concept]
* [Target Market]
* [Financial Highlights]

## Company Description
* [Mission Statement]
* [Legal Structure]
* [Key Personnel]

## Market Analysis
* [Industry Trends]
* [Competitive Advantage]
* [Market Size]

## Organization and Management
* [Organizational Structure]
* [Key Management Team Roles]

## Service or Product Line
* [Product/Service Description]
* [Development Status]
* [Intellectual Property]

## Marketing and Sales Strategy
* [Marketing Channels]
* [Sales Strategy]
* [Key Partnerships]

## Financial Projections
* [Startup Costs Summary]
* [3-Year Revenue Forecast Highlight]
* [Funding Request]

## Appendix
* [Supporting Documents]

The Appendix section must be the last element of the response before the suggestions block.`,
              
                'Market Entry Strategy': `Develop a comprehensive market entry strategy for [input PRODUCT / SERVICE] entering the [input SPECIFIC COUNTRY / MARKET]. 

The output MUST strictly follow this structure:

# Market Entry Strategy: [Product] in [Market]
[A brief paragraph summarizing the primary recommendation.]

## Target Audience
* [Demographics]
* [Key Needs/Pain Points]

## Distribution Strategy
* [Primary Channel]
* [Logistics and Fulfillment]

## Pricing Model
* [Recommended Strategy (e.g., Penetration, Skimming)]
* [Key Cost Drivers]

## Market Entry Options Summary
| Method | Key Advantages | Key Disadvantages |
|---|---|---|
| [Method 1] | * [Advantage 1] <br> * [Advantage 2] | * [Disadvantage 1] <br> * [Disadvantage 2] |
| [Method 2] | * [Advantage 1] <br> * [Advantage 2] | * [Disadvantage 1] <br> * [Disadvantage 2] |
| [Method 3] | * [Advantage 1] <br> * [Advantage 2] | * [Disadvantage 1] <br> * [Disadvantage 2] |

The table must be the last element of the response before the suggestions block.`,

                'Go-to-market Strategy': `Develop a comprehensive Go-to-Market (GTM) Strategy for [input PRODUCT / SERVICE (e.g. a new B2B SaaS platform)] targeting [input SPECIFIC AUDIENCE / GEOGRAPHY (e.g. mid-market financial services)]. Focus on key messaging, channel strategy, and launch metrics.

The output MUST strictly follow this structure:

# Go-to-Market Strategy: [Product]
[A brief introductory paragraph summarizing the strategic approach and main goal.]

## Target Customer Profile (ICP)
* [Target Demographic/Firmographic]
* [Primary Pain Point Addressed]
* [Unique Value Proposition (UVP)]

## Channel and Tactics Plan
| Channel Category | Key Tactics/Activities | Owner/Timeline |
|---|---|---|
| **Marketing** | * [Tactic 1 (e.g., Content)] <br> * [Tactic 2 (e.g., SEO)] | [Owner/Timeline] |
| **Sales** | * [Tactic 1 (e.g., Outbound)] <br> * [Tactic 2 (e.g., Partnerships)] | [Owner/Timeline] |
| **Product/Success** | * [Tactic 1 (e.g., Onboarding)] <br> * [Tactic 2 (e.g., Documentation)] | [Owner/Timeline] |

## Pricing & Packaging
* [Recommended Pricing Model]
* [Launch Offer / Incentive]

## Launch Metrics (KPIs)
* [Metric 1: Definition of success]
* [Metric 2: Definition of success]
* [Metric 3: Definition of success]

The "Launch Metrics" section must be the last element of the response before the suggestions block.`,

                'Ansoff Matrix': `Apply the Ansoff Matrix (Product/Market Expansion Grid) to recommend growth strategies for [input COMPANY NAME / PRODUCT IDEA ]. Analyze Market Penetration, Product Development, Market Development, and Diversification.

The output MUST strictly follow this structure:

# Ansoff Matrix Growth Recommendations
[A concise introduction defining the company's current core product and market.]

## Growth Strategy Matrix
| Strategy | Product/Market Status | Key Action/Risk |
|---|---|---|
| **Market Penetration** | Existing Product / Existing Market | * [Action 1] <br> * [Action 2] |
| **Product Development** | New Product / Existing Market | * [Action 1] <br> * [Action 2] |
| **Market Development** | Existing Product / New Market | * [Action 1] <br> * [Action 2] |
| **Diversification** | New Product / New Market | * [Action 1] <br> * [Action 2] |

The table must be the last element of the response before the suggestions block.`,
              
                'Risk Analysis': `Conduct a risk analysis for [input SPECIFIC BUSINESS VENTURE / PROJECT]. Identify potential risks, assess their likelihood and impact, and propose mitigation strategies. 

The output MUST strictly follow this structure:

# High-Level Risk Analysis: [Venture/Project Name]
[A brief introductory statement on the scope of the risk assessment.]

## Risk Mitigation Table
| Risk Area | Likelihood (H/M/L) | Impact (H/M/L) | Mitigation Strategy |
|---|---|---|---|
| **[Risk Category 1]** | [Level] | [Level] | * [Strategy 1] <br> * [Strategy 2] |
| **[Risk Category 2]** | [Level] | [Level] | * [Strategy 1] <br> * [Strategy 2] |
| **[Risk Category 3]** | [Level] | [Level] | * [Strategy 1] <br> * [Strategy 2] |

The table must be the last element of the response before the suggestions block.`,
              
                // ========================
                // PHASE 4: EXECUTION
                // ========================

                'Monday Morning Protocol': `Convert our high-level strategy into a concrete "Monday Morning" Action Plan.

The output MUST strictly follow this structure:

# Monday Morning Action Protocol
[Statement of immediate intent]

## Immediate Actions (Next 7 Days)
| Role/Owner | Specific Task (The "What") | Deadline (The "When") | Definition of Done |
|---|---|---|---|
| [Role 1] | [Task] | [Date/Day] | [Outcome] |
| [Role 2] | [Task] | [Date/Day] | [Outcome] |

## 30-60-90 Day Outlook
* **30 Days:** [Milestone]
* **60 Days:** [Milestone]
* **90 Days:** [Milestone]`,

                'KPI Dashboard Mockup': `Design a **KPI Dashboard Mockup** structure for tracking the success of [input SPECIFIC BUSINESS GOAL / PROJECT, e.g., 'reducing customer churn' or 'launching a new product feature']. Define a minimum of five mandatory KPIs (Key Performance Indicators).

The output MUST strictly follow this structure:

# Key Performance Indicator (KPI) Dashboard Mockup
[A concise statement defining the overall goal of the dashboard.]

## Defined Metrics
| KPI Name | Definition/Formula | Target Value | Reporting Frequency |
|---|---|---|---|
| **[KPI 1: Financial]** | [Formula] | [Target #] | [Daily/Weekly/Monthly] |
| **[KPI 2: Customer/User]** | [Formula] | [Target #] | [Daily/Weekly/Monthly] |
| **[KPI 3: Operational]** | [Formula] | [Target #] | [Daily/Weekly/Monthly] |
| **[KPI 4: Quality]** | [Formula] | [Target #] | [Daily/Weekly/Monthly] |
| **[KPI 5: Strategic]** | [Formula] | [Target #] | [Daily/Weekly/Monthly] |

The table must be the last element of the response before the suggestions block.`,
              
                'Implementation Plan Outline': `Generate a high-level **Implementation Plan Outline** for [input PROJECT / STRATEGY, e.g., 'launching a new corporate training program']. Structure the plan into clear phases.

The output MUST strictly follow this structure:

# High-Level Implementation Plan: [Project Title]
[A brief introductory paragraph summarizing the plan's execution approach.]

## Implementation Phases
| Phase | Key Milestones | Required Resources | Estimated Duration |
|---|---|---|---|
| **Phase 1: Setup** | * [Milestone 1] <br> * [Milestone 2] | [Team/Budget/Tools] | [Duration] |
| **Phase 2: Development** | * [Milestone 1] <br> * [Milestone 2] | [Team/Budget/Tools] | [Duration] |
| **Phase 3: Deployment** | * [Milestone 1] <br> * [Milestone 2] | [Team/Budget/Tools] | [Duration] |
| **Phase 4: Stabilization** | * [Milestone 1] <br> * [Milestone 2] | [Team/Budget/Tools] | [Duration] |

The table must be the last element of the response before the suggestions block.`,
            };

            // ============================================
            // 4. UI HELPERS (Menus, Resizing, Hero)
            // ============================================

            function toggleMenu(menuElement) {
                // Close all other menus first
                [initialSetupMenu, analysisMenu, solutionDesignMenu, executionMenu, myPromptsMenu, workflowMenu].forEach(m => {
                    if (m !== menuElement) m.classList.add('hidden');
                });
                menuElement.classList.toggle('hidden');
            }

            // Close menus on click outside
            document.addEventListener('click', (e) => {
                const isBtn = e.target.closest('button');
                const isMenu = e.target.closest('.sidebar-menu') || e.target.closest('#myPromptsMenu') || e.target.closest('#workflowMenu');
                
                // Allow clicking inside menus or on their buttons
                if (isBtn && (isBtn.id.includes('Dropdown') || isBtn.id === 'workflowBtn')) return;
                if (isMenu) return;

                // Close all
                [initialSetupMenu, analysisMenu, solutionDesignMenu, executionMenu, myPromptsMenu, workflowMenu].forEach(m => m.classList.add('hidden'));
            });

            // Attach listeners to dropdwns
            initialSetupDropdownBtn.onclick = () => toggleMenu(initialSetupMenu);
            analysisDropdownBtn.onclick = () => toggleMenu(analysisMenu);
            solutionDesignDropdownBtn.onclick = () => toggleMenu(solutionDesignMenu);
            executionDropdownBtn.onclick = () => toggleMenu(executionMenu);
            myPromptsDropdownBtn.onclick = () => toggleMenu(myPromptsMenu);
            workflowBtn.onclick = () => toggleMenu(workflowMenu);

            // Auto-resize input
            userInput.style.height = 'auto';
            MIN_HEIGHT = userInput.scrollHeight;
            function autoResizeTextarea(textarea) {
                textarea.style.height = 'auto';
                let newHeight = textarea.scrollHeight;
                if (newHeight < MIN_HEIGHT) newHeight = MIN_HEIGHT;
                if (newHeight > 150) {
                    newHeight = 150;
                    textarea.style.overflowY = 'auto';
                } else {
                    textarea.style.overflowY = 'hidden';
                }
                textarea.style.height = `${newHeight}px`;
            }
            userInput.addEventListener('input', () => autoResizeTextarea(userInput));

            // Populate Menus from Prompt Map
            const populateMenu = (menuId, items) => {
                const menu = document.getElementById(menuId);
                menu.innerHTML = '';
                items.forEach(item => {
                    const btn = document.createElement('button');
                    btn.className = 'sub-menu-btn';
                    btn.textContent = item;
                    btn.onclick = () => {
                        // Use the FULL prompt from the map
                        userInput.value = PROMPT_MAP[item] || item;
                        autoResizeTextarea(userInput);
                        userInput.focus();
                        toggleMenu(menu); // Close menu after click
                    };
                    menu.appendChild(btn);
                });
            };

            // 1. Initial Setup + The "Interviewer"
            populateMenu('initialSetupMenu', [
                'Guided Diagnostic (Interviewer Mode)', // NEW
                'Industry Trends Snapshot', 
                'Initial Project Charter Draft', 
                'Problem Statement Draft'
            ]);

            // 2. Analysis + The "MECE Validator"
            populateMenu('analysisMenu', [
                'MECE Logic Check', // NEW
                'Market Analysis', 
                'SWOT Analysis', 
                'Competitor Benchmarking', 
                '5 Forces Analysis', 
                'PESTLE Analysis', 
                'Hofstede Analysis'
            ]);

            // 3. Solution + "Devil's Advocate"
            populateMenu('solutionDesignMenu', [
                "Devil's Advocate Review", // NEW
                'Business Plan Outline', 
                'Market Entry Strategy', 
                'Go-to-market Strategy', 
                'Ansoff Matrix', 
                'Risk Analysis'
            ]);

            // 4. Execution + "Monday Morning Protocol"
            populateMenu('executionMenu', [
                'Monday Morning Protocol', // NEW
                'KPI Dashboard Mockup', 
                'Implementation Plan Outline'
            ]);

            // ============================================
            // 2. CORE LOGIC (Send, File, API)
            // ============================================

            // FILE UPLOAD
            attachBtn.addEventListener('click', () => hiddenFileInput.click());
            hiddenFileInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const onFileLoaded = (content, name) => {
                    attachedFileContent = content;
                    attachedFileName = name;
                    attachBtn.classList.remove('text-gray-400', 'text-yellow-400');
                    attachBtn.classList.add('text-emerald-500');
                    attachBtn.title = `Attached: ${name}`;
                    userInput.focus();
                };

                if (file.type === 'application/pdf') {
                    try {
                        attachBtn.classList.add('text-yellow-400');
                        const arrayBuffer = await file.arrayBuffer();
                        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                        let fullText = "";
                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const textContent = await page.getTextContent();
                            const pageText = textContent.items.map(item => item.str).join(' ');
                            fullText += `\n--- PDF Page ${i} ---\n${pageText}`;
                        }
                        onFileLoaded(fullText, file.name);
                    } catch (error) {
                        console.error(error);
                        alert("Error reading PDF.");
                        hiddenFileInput.value = ""; attachBtn.classList.remove('text-yellow-400');
                    }
                } else {
                    const reader = new FileReader();
                    reader.onload = (e) => onFileLoaded(e.target.result, file.name);
                    reader.readAsText(file);
                }
            });

            // SEND MESSAGE
            async function sendMessage() {
                let prompt = userInput.value.trim();
                let hasFile = attachedFileContent !== null;
                
                if (!prompt && !hasFile) return;

                // 1. UI: Hide Hero Text
                heroText.style.display = 'none';

                // 2. Construct Payload
                let fullPayloadPrompt = prompt;
                if (hasFile) {
                    const filePrompt = `\n\n[USER ATTACHED FILE: ${attachedFileName}]\n\`\`\`\n${attachedFileContent}\n\`\`\`\n`;
                    if (prompt === "") {
                        prompt = `Analyze the attached file: ${attachedFileName}`;
                        fullPayloadPrompt = prompt + filePrompt;
                    } else {
                        fullPayloadPrompt = prompt + filePrompt;
                    }
                }

                // 3. Update UI Bubbles (User Side)
                if (hasFile) {
                    createMessageBubble(` **Uploaded:** ${attachedFileName}`, 'user');
                    // Reset File Variables immediately
                    attachedFileContent = null;
                    attachedFileName = null;
                    hiddenFileInput.value = "";
                    attachBtn.classList.remove('text-emerald-500', 'text-yellow-400');
                    attachBtn.classList.add('text-gray-400');
                }

                const userVisibleText = userInput.value.trim();
                if (userVisibleText) {
                    createMessageBubble(userVisibleText, 'user');
                }
                
                chatHistory.push({ role: "user", parts: [{ text: fullPayloadPrompt }] });

                // 4. Reset Input State
                userInput.value = '';
                autoResizeTextarea(userInput);
                userInput.disabled = true;
                sendButton.disabled = true;

                // 5. Loading Indicator
                const loadingBubble = document.createElement('div');
                loadingBubble.classList.add('flex', 'justify-start');
                loadingBubble.innerHTML = `<div class="bg-gray-700 text-gray-300 rounded-xl rounded-bl-none p-3 max-w-sm shadow-md"><div class="flex items-center">Thinking...</div></div>`;
                chatArea.appendChild(loadingBubble);
                chatArea.scrollTop = chatArea.scrollHeight;

                // 6. API Call
                try {
                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            systemInstruction: { 
                                parts: [{ text: `You are Bob, a professional consulting assistant. 
                                
                                RULES FOR CITATIONS:
                                1. Use the Google Search Tool for facts/data.
                                2. EVERY time you use a source, you MUST add a Markdown link immediately after the fact.
                                3. Format: [Source Name](URL)
                                4. Example: "The market grew by 5% [Gartner](https://gartner.com)."
                                5. Do NOT use footnotes like [1]. Do NOT put a list at the end. Use inline markdown links ONLY.
                                
                                Format the rest of your response using professional Markdown.` }] 
                            },
                            messages: chatHistory
                        })
                    });

                    const result = await response.json();
                    
                    // Remove loading bubble
                    if(chatArea.contains(loadingBubble)) chatArea.removeChild(loadingBubble);

                    // 7. Error Handling & Response Display
                    if (result.error) {
                        console.error("API Error:", result.error);
                        createMessageBubble(` **System Error:** ${result.error.message || "Unknown API Error"}`, "model");
                    } else {
                        const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (text) {
                            chatHistory.push({ role: "model", parts: [{ text: text }] });
                            createMessageBubble(text, "model");
                        } else {
                            createMessageBubble(" Bob returned an empty response. Try asking a specific question.", "model");
                        }
                    }
                } catch (error) {
                    if(chatArea.contains(loadingBubble)) chatArea.removeChild(loadingBubble);
                    createMessageBubble(` **Connection Error:** ${error.message}`, "model");
                }

                // 8. Re-enable Controls
                userInput.disabled = false;
                sendButton.disabled = false;
                userInput.focus();
            }

            // Keyboard and Button Listeners for Send
            sendButton.addEventListener('click', sendMessage);
            userInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // ============================================
            // 3. UTILITIES (Bubbles, Prompts, Clear, Etc)
            // ============================================

            // --- CITATION HELPER FUNCTIONS ---
            function processCitations(rawText) {
                // Regex to find STANDARD Markdown links: [Name](URL)
                // We look for http in the URL to ensure it's a real link
                const regex = /\[([^\]]+)\]\((http[^)]+)\)/g;
                let sources = [];
                let match;
    
                
                // 1. Extract sources
                while ((match = regex.exec(rawText)) !== null) {
                    sources.push({ name: match[1], url: match[2] });
                }

                // 2. Replace with Pin Icon
                let processedText = rawText.replace(regex, (match, name, url) => {
                    return `<a href="${url}" target="_blank" class="citation-link" title="Source: ${name}"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244" /></svg></a>`;
                });

                return { html: processedText, sources: sources };
            }

            function createSourcesFooter(sources) {
                if (!sources || sources.length === 0) return '';
                
                const listItems = sources.map((s, i) => {
                    // SAFETY CHECK: Try to parse hostname, fallback if invalid URL
                    let faviconUrl = '';
                    try {
                        const urlObj = new URL(s.url);
                        faviconUrl = `https://www.google.com/s2/favicons?domain=${urlObj.hostname}`;
                    } catch (e) {
                        // If URL is invalid (e.g. missing https), use a generic icon
                        faviconUrl = 'https://www.google.com/s2/favicons?domain=google.com'; 
                    }

                    return `
                    <a href="${s.url}" target="_blank" class="source-item">
                        <span class="text-gray-500 font-mono text-xs">[${i+1}]</span>
                        <img src="${faviconUrl}" class="source-favicon" onerror="this.style.display='none'">
                        ${s.name}
                    </a>
                    `;
                }).join('');

                const listId = `sources-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;

                return `
                    <div class="sources-section">
                        <button class="sources-toggle-btn" onclick="document.getElementById('${listId}').classList.toggle('hidden')">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244" /></svg>
                            Sources
                        </button>
                        <div id="${listId}" class="sources-list hidden">${listItems}</div>
                    </div>
                `;
            }
            // ----------------------------------

            function createMessageBubble(text, sender) {
                const wrapper = document.createElement('div');
                // Added 'message-wrapper' class for hover effects
                wrapper.classList.add('flex', 'message-wrapper', 'mb-4', sender === 'user' ? 'justify-end' : 'justify-start');
                
                const bubble = document.createElement('div');
                bubble.classList.add(
                    'rounded-xl', 'p-4', 'max-w-2xl', 'shadow-md',
                    sender === 'user' ? 'bg-emerald-600' : 'bg-gray-800',
                    'text-gray-100'
                );

                // --- LOGIC FOR AI MESSAGES ---
                if (sender === 'model') {
                    const { html: textWithIcons, sources } = processCitations(text);

                    const contentDiv = document.createElement('div');
                    contentDiv.classList.add('ai-response-content', 'mb-2');
                    contentDiv.innerHTML = marked.parse(textWithIcons);

                    if (sources.length > 0) {
                        const footerDiv = document.createElement('div');
                        footerDiv.innerHTML = createSourcesFooter(sources);
                        contentDiv.appendChild(footerDiv);
                    }

                    const copyBtn = document.createElement('button');
                    copyBtn.className = 'text-xs text-gray-400 hover:text-white mt-2 block ml-auto';
                    copyBtn.textContent = 'Copy';
                    copyBtn.onclick = () => {
                        navigator.clipboard.writeText(text);
                        copyBtn.textContent = 'Copied!';
                        setTimeout(() => copyBtn.textContent = 'Copy', 1500);
                    };

                    bubble.appendChild(contentDiv);
                    bubble.appendChild(copyBtn);
                    wrapper.appendChild(bubble);
                } 
                // --- LOGIC FOR USER MESSAGES (Edit & Copy) ---
                else {
                    bubble.textContent = text;

                    // Container for the icons (Edit / Copy)
                    const actionsDiv = document.createElement('div');
                    actionsDiv.className = 'user-action-container';

                    // Edit Button (Pencil Icon)
                    const editBtn = document.createElement('button');
                    editBtn.className = 'action-icon-btn';
                    editBtn.title = "Edit prompt";
                    editBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L6.832 19.82a4.5 4.5 0 01-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 011.13-1.897L16.863 4.487zm0 0L19.5 7.125" /></svg>`;
                    editBtn.onclick = () => {
                        userInput.value = text; // Put text back in box
                        autoResizeTextarea(userInput);
                        userInput.focus();
                    };

                    // Copy Button (Clipboard Icon)
                    const copyBtnUser = document.createElement('button');
                    copyBtnUser.className = 'action-icon-btn';
                    copyBtnUser.title = "Copy text";
                    copyBtnUser.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v2.25A2.25 2.25 0 0113.5 22.5h-8.25a2.25 2.25 0 01-2.25-2.25v-8.25a2.25 2.25 0 012.25-2.25H5.25a2.25 2.25 0 012.25-2.25h1.5a.75.75 0 010 1.5H6a.75.75 0 00-.75.75v8.25c0 .414.336.75.75.75H13.5a.75.75 0 00.75-.75V11.25H18a.75.75 0 01.75.75v4.5a.75.75 0 00.75.75h1.5A2.25 2.25 0 0122.5 17.25v2.25a.75.75 0 001.5 0V17.25A2.25 2.25 0 0021.75 15h-1.5a.75.75 0 01-.75-.75V9.75a2.25 2.25 0 00-2.25-2.25H15z" /><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 7.125h-10.5a2.25 2.25 0 00-2.25 2.25v10.5" /></svg>`;
                    copyBtnUser.onclick = () => {
                        navigator.clipboard.writeText(text);
                        copyBtnUser.style.color = '#34d399'; // Flash green
                        setTimeout(() => copyBtnUser.style.color = '', 500);
                    };

                    actionsDiv.appendChild(editBtn);
                    actionsDiv.appendChild(copyBtnUser);

                    // Add actions BEFORE bubble so they appear to the left
                    wrapper.appendChild(actionsDiv);
                    wrapper.appendChild(bubble);
                }

                chatArea.appendChild(wrapper);
                chatArea.scrollTop = chatArea.scrollHeight;
            }

            // Clear Chat
            clearChatBtn.onclick = () => {
                chatArea.innerHTML = '';
                chatHistory.length = 0;
                heroText.style.display = 'flex'; // Bring back the hero text
            };

            // My Prompts Logic
            function loadCustomPrompts() {
                myPromptsMenu.innerHTML = '';
                const saveBtn = document.createElement('button');
                saveBtn.className = 'sub-menu-btn text-emerald-400 font-bold';
                saveBtn.textContent = '+ Save Current Input';
                saveBtn.onclick = () => {
                    const txt = userInput.value.trim();
                    if(!txt) return alert("Type something to save.");
                    const name = prompt("Prompt Name:");
                    if(name) {
                        localStorage.setItem('customPrompt:'+name, txt);
                        loadCustomPrompts();
                    }
                };
                myPromptsMenu.appendChild(saveBtn);

                Object.keys(localStorage).forEach(key => {
                    if(key.startsWith('customPrompt:')) {
                        const name = key.replace('customPrompt:', '');
                        const btn = document.createElement('button');
                        btn.className = 'sub-menu-btn';
                        btn.textContent = name;
                        btn.onclick = () => {
                            userInput.value = localStorage.getItem(key);
                            autoResizeTextarea(userInput);
                            toggleMenu(myPromptsMenu);
                        };
                        myPromptsMenu.appendChild(btn);
                    }
                });
            }
            loadCustomPrompts();

            // Export Chat
            exportBtn.onclick = () => {
                let txt = 'BOB CHAT EXPORT\n\n';
                chatHistory.forEach(msg => {
                    txt += `[${msg.role.toUpperCase()}]\n${msg.parts[0].text}\n\n----------------\n\n`;
                });
                const blob = new Blob([txt], {type:'text/plain'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = 'bob-chat.txt';
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
            };

        })();
    </script>
</body>
</html>
