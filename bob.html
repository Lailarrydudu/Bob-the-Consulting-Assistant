<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Clerk Auth Protection -->
    <script
      async
      crossorigin="anonymous"
      data-clerk-publishable-key="pk_test_c2VsZWN0LWd1cHB5LTQwLmNsZXJrLmFjY291bnRzLmRldiQ"
      src="https://cdn.jsdelivr.net/npm/@clerk/clerk-js@latest/dist/clerk.browser.js"
      type="text/javascript"
    ></script>
    <script>
        window.addEventListener("load", async function () {
            await Clerk.load();
            if (!Clerk.user) {
                // Not logged in? Kick them out.
                window.location.href = "login.html";
            } else {
                // Logged in? Update UI with user info (Optional)
                console.log("User:", Clerk.user.firstName);
            }
        });
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Duvallo | AI Strategy Engine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PDF.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- NEW: PowerPoint Generator -->
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Georgia:wght@400;700&family=Roboto+Slab:wght=700&display=swap');
        
        body {
            font-family: 'Georgia', sans-serif;
            background-color: #111827; /* Gray 900 */
            color: #f3f4f6;
            height: 100vh;
            overflow: hidden; /* Prevent body scroll, handle inside containers */
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        /* Typography for AI Responses */
        .ai-response-content {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
            font-size: 1rem;
            line-height: 1.75;
            color: #ececf1; /* Off-White */
        }

        /* Headings: Clean, Bold, White, Left-Aligned */
        .ai-response-content h1 {
            font-size: 1.5rem; /* ~24px */
            font-weight: 700;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            color: #ffffff;
            text-align: left; /* Removed center align */
            border-bottom: 1px solid #374151; /* Subtle divider for main titles */
            padding-bottom: 0.5rem;
        }

        .ai-response-content h2 {
            font-size: 1.25rem; /* ~20px */
            font-weight: 600;
            margin-top: 2rem; /* More breathing room before sections */
            margin-bottom: 0.75rem;
            color: #ffffff;
        }

        .ai-response-content h3 {
            font-size: 1.1rem; /* ~16px */
            font-weight: 600;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            color: #ffffff;
        }

        /* Paragraphs & Text */
        .ai-response-content p {
            margin-bottom: 1rem;
        }

        .ai-response-content strong {
            font-weight: 700;
            color: #ffffff; /* Bright white for emphasis, no yellow */
        }

        /* Lists: Indentation & Bullets */
        .ai-response-content ul {
            list-style-type: disc;
            padding-left: 1.2rem;
            margin-bottom: 1rem;
        }

        /* Ordered Lists (1, 2, 3) - Styling for Main Points */
        .ai-response-content ol {
            list-style-type: none; /* We will use custom counters for better control */
            counter-reset: item;
            padding-left: 0;
            margin-bottom: 1.5rem;
        }

        .ai-response-content ol > li {
            counter-increment: item;
            margin-bottom: 1.5rem; /* Space between big points */
            position: relative;
            padding-left: 2rem; /* Make room for the number */
        }

        /* The Number (1., 2.) */
        .ai-response-content ol > li::before {
            content: counter(item) ".";
            position: absolute;
            left: 0;
            top: 0;
            font-weight: 700;
            color: #d1d5db; /* Light gray number */
        }

        /* Force Bold Titles in ANY List (Ordered or Unordered) to be their own line */
        .ai-response-content li strong {
            display: block; /* This moves the bold title to its own line */
            width: 100%;    /* Takes full width */
            font-size: 1.1rem;
            color: #ffffff; /* Bright white title */
            margin-bottom: 0.5rem; /* Space between Title and Explanation */
            margin-top: 0.5rem; /* Breathing room from previous text */
        }

        .ai-response-content li {
            margin-bottom: 0.5rem;
        }

        /* Tables: Neutral Grays (No more Green borders) */
        .ai-response-content table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid #4b5563;
        }

        .ai-response-content th, .ai-response-content td {
            border: 1px solid #4b5563;
            padding: 0.75rem;
            text-align: left;
        }

        .ai-response-content th {
            background-color: #374151; /* Dark Gray Header */
            color: #ffffff;
            font-weight: 600;
        }

        .ai-response-content td {
            background-color: transparent; /* Seamless background */
        }

        /* --- PHASE-GATE UI STYLES --- */
        
        /* 1. Top Phase Bar */
        .phase-step {
            background-color: #1f2937; color: #9ca3af; padding: 0.5rem 1.5rem;
            border-radius: 0.5rem; font-size: 0.85rem; font-weight: 700;
            border: 1px solid #374151; transition: all 0.3s ease; cursor: pointer;
        }
        .phase-separator {
            height: 2px; width: 24px; background: #374151; margin: 0 4px;
        }
        .phase-step.active {
            border-color: #10b981; color: #ecfdf5;
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.4);
        }

        /* 2. Center Workspace (The Artifact) */
        #workspaceArea {
            background-color: #111827;
            background-image: radial-gradient(#1f2937 1px, transparent 1px);
            background-size: 24px 24px; /* Dot Grid Pattern */
        }
        #workspaceContent {
            background: #1f2937; border: 1px solid #374151; min-height: 800px;
            padding: 40px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            outline: none; color: #e5e7eb; font-family: 'Georgia', serif; line-height: 1.6;
        }

        /* 3. Chat Drawer */
        #chatDrawer {
            transition: height 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #chatDrawer.drawer-collapsed { height: 44px; }
        #chatDrawer.drawer-expanded { height: 350px; }
        #chatDrawer.drawer-maximized { height: 80vh; }

        /* 4. Green Pins (Preserved from Old Version) */
        .citation-link {
            display: inline-flex; align-items: center; justify-content: center;
            vertical-align: middle; margin-left: 5px; background-color: #065f46;
            border: 1px solid #34d399; border-radius: 50%; width: 18px; height: 18px;
            cursor: pointer; position: relative; top: -2px; transition: transform 0.2s;
        }
        .citation-link:hover { transform: scale(1.1); background-color: #10b981; }
        .citation-link svg { width: 10px; height: 10px; color: #ffffff; }

        /* 5. Utility Classes */
        .utility-btn {
            width: 100%; padding: 0.5rem; background-color: #374151; color: white;
            border-radius: 0.375rem; font-size: 0.8rem; font-weight: 600;
            margin-bottom: 0.5rem; text-align: center; transition: all 0.2s;
        }
        .utility-btn:hover { background-color: #4b5563; }
        
        /* Dropdown */
        #projectDropdown { transform-origin: top right; transition: all 0.1s; }
        #projectDropdown.hidden { display: none; opacity: 0; }
    </style>
</head>
<body class="flex flex-col h-screen w-full bg-gray-900 text-gray-100 overflow-hidden">

    <!-- 1. TOP NAVIGATION -->
    <header class="h-16 bg-gray-800 border-b border-gray-700 flex items-center px-6 justify-between flex-shrink-0 z-30 shadow-lg">
        <!-- Logo -->
        <div class="flex items-center gap-3 w-64">
            <div class="p-1.5 bg-white rounded-full border-2 border-green-700">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" width="20" height="20">
                    <circle cx="50" cy="50" r="8" fill="none" stroke="#4a5d3e" stroke-width="5"/>
                    <g stroke="#4a5d3e" stroke-width="4" fill="none">
                        <line x1="50" y1="50" x2="50" y2="20"/><line x1="50" y1="50" x2="75" y2="30"/>
                        <line x1="50" y1="50" x2="75" y2="70"/><line x1="50" y1="50" x2="50" y2="80"/>
                        <line x1="50" y1="50" x2="25" y2="70"/><line x1="50" y1="50" x2="25" y2="30"/>
                    </g>
                </svg>
            </div>
            <h1 class="font-bold text-lg tracking-wide text-white font-serif">Duvallo</h1>
        </div>

        <!-- Phase Bar -->
        <div class="flex items-center space-x-2" id="phaseNav">
            <button class="phase-step active" onclick="switchPhase(1)">Diagnosis</button>
            <div class="phase-separator"></div>
            <button class="phase-step" onclick="switchPhase(2)">Research</button>
            <div class="phase-separator"></div>
            <button class="phase-step" onclick="switchPhase(3)">Strategy</button>
            <div class="phase-separator"></div>
            <button class="phase-step" onclick="switchPhase(4)">Execution</button>
            <div class="phase-separator"></div>
            <button class="phase-step" onclick="switchPhase(5)">Maintain</button>
        </div>

        <!-- Project Dropdown -->
        <div class="w-64 flex justify-end relative">
            <button onclick="document.getElementById('projectDropdown').classList.toggle('hidden')" class="flex items-center gap-2 text-xs bg-gray-800 hover:bg-gray-700 border border-gray-600 px-3 py-1.5 rounded text-gray-200">
                Menu <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
            </button>
            <div id="projectDropdown" class="hidden absolute top-full right-0 mt-2 w-48 bg-gray-800 border border-gray-600 rounded shadow-xl z-50">
                <button id="newProjectBtn" class="w-full text-left px-4 py-2 text-sm hover:bg-gray-700 text-white">+ New Project</button>
                <button id="loadProjectBtn" class="w-full text-left px-4 py-2 text-sm hover:bg-gray-700 text-gray-300">Load Project</button>
                <button id="deleteProjectBtn" class="w-full text-left px-4 py-2 text-sm hover:bg-red-900/50 text-red-400">Delete Project</button>
            </div>
        </div>
    </header>

    <!-- 2. MAIN LAYOUT -->
    <div class="flex flex-1 overflow-hidden relative">
        
        <!-- LEFT SIDEBAR (Context) -->
        <aside class="w-72 bg-gray-800 border-r border-gray-700 flex flex-col p-4 z-20">
            <div class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-4">Context</div>
            <div class="space-y-4 mb-6">
                <div>
                    <label class="text-[10px] text-gray-400 block mb-1">PROJECT NAME</label>
                    <div id="currentProjectNameDisplay" class="text-sm font-bold text-white truncate">Select Project</div>
                </div>
                <div>
                    <label class="text-[10px] text-gray-400 block mb-1">OBJECTIVE (Editable)</label>
                    <textarea id="projectObjective" class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-xs text-gray-200 focus:border-emerald-500 outline-none" rows="4" placeholder="Type your goal here..."></textarea>
                </div>
            </div>
            <!-- Assets -->
            <div class="border-t border-gray-700 pt-4 flex-1">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-xs font-bold text-gray-500 uppercase">Assets</span>
                    <input type="file" id="vaultFileInput" style="display: none;" accept=".pdf,.txt,.csv">
                    <button id="addVaultFileBtn" class="text-xs text-emerald-400 hover:text-white">+ Add</button>
                </div>
                <div id="vaultList" class="space-y-1"><div id="emptyVaultMsg" class="text-xs text-gray-600 italic">No assets loaded.</div></div>
            </div>
            <!-- Exports -->
            <div class="border-t border-gray-700 pt-4 space-y-2">
                <button id="exportReportBtn" class="utility-btn">Export Report (PDF)</button>
            </div>
        </aside>

        <!-- RIGHT COLUMN -->
        <div class="flex-1 flex flex-col relative min-w-0 bg-gray-900">
            
            <!-- CENTER WORKSPACE (The Artifact) -->
            <div id="workspaceArea" class="flex-1 overflow-y-auto p-12 flex justify-center">
                <!-- The Live Editable Document -->
                <div id="workspaceContent" class="w-full max-w-4xl" contenteditable="true">
                    <div class="text-center opacity-50 mt-20">
                        <h2 class="text-3xl font-bold text-gray-300">Phase 1: Diagnosis</h2>
                        <p class="text-gray-400 mt-4">Use the Chat Drawer below to start the diagnosis interview.<br>Click "Send to Workspace" on chat messages to build your report here.</p>
                    </div>
                </div>
            </div>

            <!-- BOTTOM CHAT DRAWER -->
            <div id="chatDrawer" class="drawer-expanded bg-gray-800 border-t border-gray-700 flex flex-col shadow-[0_-4px_20px_rgba(0,0,0,0.5)] z-40">
                <!-- Header / Toggle -->
                <div class="h-10 bg-gray-800 border-b border-gray-700 flex items-center justify-between px-4 cursor-pointer hover:bg-gray-750" onclick="toggleDrawer()">
                    <div class="flex items-center gap-2">
                        <span class="text-xs font-bold text-emerald-400 uppercase tracking-wider">Consultant Chat</span>
                        <span class="text-[10px] text-gray-500">(Click to Toggle)</span>
                    </div>
                    <!-- Resize Buttons -->
                    <div class="flex gap-2" onclick="event.stopPropagation()">
                         <button onclick="resizeDrawer('max')" class="text-gray-500 hover:text-white" title="Maximize">‚ñ≤</button>
                         <button onclick="resizeDrawer('norm')" class="text-gray-500 hover:text-white" title="Normal">‚óè</button>
                         <button onclick="resizeDrawer('min')" class="text-gray-500 hover:text-white" title="Minimize">‚ñº</button>
                    </div>
                </div>
                <!-- Chat Area -->
                <div id="chatArea" class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-900/50"></div>
                <!-- Input -->
                <div class="p-3 bg-gray-800 border-t border-gray-700">
                    <div class="max-w-4xl mx-auto relative flex items-end gap-2 bg-[#2f2f2f] p-2 rounded-[2rem] border border-gray-600 focus-within:border-emerald-500 transition-all">
                        <input type="file" id="hiddenFileInput" style="display: none;">
                        <button id="attachBtn" class="p-2 text-gray-400 hover:text-white rounded-full hover:bg-gray-700 mb-0.5"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M18.375 12.739l-7.693 7.693a4.5 4.5 0 01-6.364-6.364l10.94-10.94A3 3 0 1119.5 7.372L8.552 18.32m.009-.01l-.01.01m5.699-9.941l-7.81 7.81a1.5 1.5 0 002.112 2.13" /></svg></button>
                        <!-- Hidden toggles for logic compatibility -->
                        <button id="modeBriefBtn" class="hidden"></button><button id="modeDeepBtn" class="hidden"></button>
                        <div class="flex-1">
                            <div id="filePreviewArea" class="hidden mb-1 px-1"></div>
                            <textarea id="userInput" placeholder="Ask Duvallo..." rows="1" class="w-full bg-transparent text-gray-100 placeholder-gray-500 border-none focus:ring-0 resize-none py-2 text-sm max-h-32" style="min-height: 40px;"></textarea>
                        </div>
                        <button id="sendButton" class="p-2 bg-emerald-600 text-white rounded-full hover:bg-emerald-500 mb-0.5 shadow"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 10.5L12 3m0 0l7.5 7.5M12 3v18" /></svg></button>
                    </div>
                </div>
            </div>

            <!-- SIDE PANEL (Hidden by default) -->
            <aside id="rightSourcePanel" class="absolute top-0 right-0 h-full bg-gray-900 border-l border-gray-700 z-50 transform translate-x-full transition-transform duration-300 w-80 shadow-2xl">
                <div class="p-4 border-b border-gray-700 flex justify-between items-center bg-gray-800">
                    <span class="text-xs font-bold uppercase text-gray-400">Sources</span>
                    <button onclick="closeSourcePanel()" class="text-gray-400 hover:text-white"><svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
                </div>
                <div id="sourcePanelContent" class="p-4 space-y-3 overflow-y-auto h-full pb-20"></div>
            </aside>
        </div>
    </div>

    <!-- --- MASTER SCRIPT: LOGIC, UI, AND BRAIN --- -->
    <script>
        // ==========================================
        // 1. GLOBAL UI HELPERS (Drawer, Panels, Layout)
        // ==========================================
        
        // Chat Drawer Logic
        function toggleDrawer() {
            const drawer = document.getElementById('chatDrawer');
            const chevron = document.getElementById('drawerChevron');
            // If expanded or maximized, collapse it. If collapsed, expand it.
            if (drawer.classList.contains('drawer-expanded') || drawer.classList.contains('drawer-maximized')) {
                resizeDrawer('min');
                if(chevron) chevron.style.transform = 'rotate(180deg)';
            } else {
                resizeDrawer('norm');
                if(chevron) chevron.style.transform = 'rotate(0deg)';
            }
        }

        function resizeDrawer(size) {
            const drawer = document.getElementById('chatDrawer');
            drawer.classList.remove('drawer-collapsed', 'drawer-expanded', 'drawer-maximized');
            if(size === 'min') drawer.classList.add('drawer-collapsed');
            if(size === 'norm') drawer.classList.add('drawer-expanded');
            if(size === 'max') drawer.classList.add('drawer-maximized');
        }

        // Phase Switcher (Top Bar Logic)
        function switchPhase(n) {
            // 1. Update Buttons
            document.querySelectorAll('.phase-step').forEach((btn, i) => {
                if(i + 1 === n) btn.classList.add('active');
                else btn.classList.remove('active');
            });
            document.querySelectorAll('.phase-separator').forEach((sep, i) => {
                if(i + 1 < n) sep.classList.add('active');
                else sep.classList.remove('active');
            });

            // 2. Update Workspace Content
            const titles = ["Diagnosis", "Research", "Strategy", "Execution", "Maintain"];
            const workspace = document.getElementById('workspaceContent');
            const phaseTitle = titles[n-1];
            
            // Only overwrite if it's the "Hero Text" placeholder or empty
            const currentText = workspace.innerText.trim();
            if(currentText.includes("Phase") || currentText === "") {
                workspace.innerHTML = `
                    <div class="text-center opacity-50 mt-20 fade-in">
                        <h2 class="text-3xl font-bold text-gray-300">Phase ${n}: ${phaseTitle}</h2>
                        <p class="text-gray-400 mt-4">The workspace is ready.<br>Use the chat below to generate a ${phaseTitle} report.</p>
                    </div>`;
            }
        }

        // Artifact Router (The "Send to Workspace" feature)
        window.sendToWorkspace = function(htmlContent) {
            const workspace = document.getElementById('workspaceContent');
            const decoded = decodeURIComponent(htmlContent);
            
            // Clear placeholder if present
            if(workspace.innerText.includes("The workspace is ready")) workspace.innerHTML = "";

            const block = document.createElement('div');
            block.className = "mb-8 pb-8 border-b border-gray-700 animate-fade-in";
            block.innerHTML = decoded;
            
            // Add a "Remove" button to the block
            const removeBtn = document.createElement('button');
            removeBtn.className = "text-xs text-red-400 hover:text-red-300 float-right mt-2";
            removeBtn.innerText = "Remove Block";
            removeBtn.onclick = () => block.remove();
            block.appendChild(removeBtn);

            workspace.appendChild(block);
        };

        // Source Panel Logic
        window.cleanUrl = function(rawUrl) {
            if (!rawUrl) return "#";
            try {
                if (!rawUrl.includes("google.com/url")) return rawUrl;
                const urlObj = new URL(rawUrl);
                return urlObj.searchParams.get("q") || rawUrl;
            } catch (e) { return rawUrl; }
        };

        window.openSourcePanel = function(sourcesJson) {
            const content = document.getElementById('sourcePanelContent');
            let sources = [];
            try { sources = JSON.parse(decodeURIComponent(sourcesJson)); } catch(e){}
            
            content.innerHTML = '';
            if(!sources || sources.length === 0) {
                 content.innerHTML = '<div class="text-gray-500 text-sm italic">No sources found.</div>';
            } else {
                sources.forEach(src => {
                    const safeLink = window.cleanUrl(src.url);
                    let domain = "External Link";
                    try { domain = new URL(safeLink).hostname.replace('www.',''); } catch(e){}

                    const item = document.createElement('a');
                    item.href = safeLink; item.target = "_blank";
                    item.className = "block bg-gray-800 p-3 rounded mb-2 hover:bg-gray-700 border border-gray-700 text-xs text-gray-300 transition";
                    item.innerHTML = `
                        <div class="flex items-center gap-2 mb-1">
                            <img src="https://www.google.com/s2/favicons?domain=${domain}" class="w-4 h-4 rounded-sm" onerror="this.style.display='none'">
                            <span class="font-bold text-emerald-400 truncate">${src.name}</span>
                        </div>
                        <div class="truncate opacity-50">${safeLink}</div>
                    `;
                    content.appendChild(item);
                });
            }
            document.getElementById('rightSourcePanel').classList.add('panel-open');
        };

        window.closeSourcePanel = () => document.getElementById('rightSourcePanel').classList.remove('panel-open');


        // ==========================================
        // 2. MAIN APPLICATION LOGIC (IIFE)
        // ==========================================
        (function() {
            // Elements
            const sendButton = document.getElementById('sendButton');
            const userInput = document.getElementById('userInput');
            const chatArea = document.getElementById('chatArea');
            
            // Project Utils
            const newProjectBtn = document.getElementById('newProjectBtn');
            const loadProjectBtn = document.getElementById('loadProjectBtn');
            const deleteProjectBtn = document.getElementById('deleteProjectBtn');
            const exportReportBtn = document.getElementById('exportReportBtn'); // Sidebar Export
            const exportBtn = document.getElementById('exportBtn'); // Dropdown Export (if exists)

            // State
            let chatHistory = [];
            let currentProjectId = null;
            let attachedFileContent = null;
            let attachedFileName = null;

            // --- PROJECT MANAGEMENT ---
            function getProjects() { return JSON.parse(localStorage.getItem('duvallo_projects_index') || '[]'); }
            
            function loadProject(id, name) {
                currentProjectId = id;
                document.getElementById('currentProjectNameDisplay').innerText = name;
                document.getElementById('projectDropdown').classList.add('hidden');
                
                // Clear and Load Chat
                chatArea.innerHTML = '';
                chatHistory.length = 0;
                const saved = JSON.parse(localStorage.getItem(`duvallo_project_${id}_chat`) || '[]');
                
                if(saved.length > 0) {
                    saved.forEach(msg => {
                        chatHistory.push(msg);
                        createMessageBubble(msg.parts[0].text, msg.role, false);
                    });
                } else {
                    // Start fresh
                    toggleDrawer(); // Open drawer for new project
                }
            }

            // Button Events
            if(newProjectBtn) newProjectBtn.onclick = () => {
                const name = prompt("Project Name:");
                if(!name) return;
                const id = Date.now().toString();
                const projects = getProjects();
                projects.push({id, name});
                localStorage.setItem('duvallo_projects_index', JSON.stringify(projects));
                loadProject(id, name);
            };

            if(loadProjectBtn) loadProjectBtn.onclick = () => {
                const projects = getProjects();
                if(projects.length===0) return alert("No projects found.");
                let list = "Select Project:\n"; projects.forEach((p,i)=> list += `${i+1}. ${p.name}\n`);
                const choice = prompt(list);
                if(choice && projects[choice-1]) loadProject(projects[choice-1].id, projects[choice-1].name);
            };

            if(deleteProjectBtn) deleteProjectBtn.onclick = () => {
                const projects = getProjects();
                if(projects.length===0) return alert("No projects.");
                let list = "DELETE Project:\n"; projects.forEach((p,i)=> list += `${i+1}. ${p.name}\n`);
                const choice = prompt(list);
                if(choice && projects[choice-1]) {
                    localStorage.removeItem(`duvallo_project_${projects[choice-1].id}_chat`);
                    const updated = projects.filter(p => p.id !== projects[choice-1].id);
                    localStorage.setItem('duvallo_projects_index', JSON.stringify(updated));
                    alert("Deleted.");
                    location.reload();
                }
            };

            // --- FILE ATTACHMENT ---
            const attachBtn = document.getElementById('attachBtn');
            const hiddenFileInput = document.getElementById('hiddenFileInput');
            const filePreviewArea = document.getElementById('filePreviewArea');

            if(attachBtn) attachBtn.onclick = () => hiddenFileInput.click();
            if(hiddenFileInput) hiddenFileInput.onchange = async (e) => {
                const file = e.target.files[0];
                if(!file) return;
                attachedFileName = file.name;
                
                // Simple Reader for Text/CSV
                const reader = new FileReader();
                reader.onload = (e) => {
                    attachedFileContent = e.target.result;
                    filePreviewArea.innerHTML = `<span class="text-xs bg-gray-700 text-white px-2 py-1 rounded">üìé ${file.name}</span>`;
                    filePreviewArea.classList.remove('hidden');
                };
                reader.readAsText(file);
            };


            // --- CHAT LOGIC ---

            // Citation Processor (Regex)
            function processCitations(rawText) {
                const regex = /\[([^\]]+)\]\((https?:\/\/[^)\s]+)\)/g;
                let sources = [];
                const textWithTokens = rawText.replace(regex, (match, name, url) => {
                    let clean = url.replace(/[.,;!]+$/, "");
                    sources.push({name, url: clean});
                    return `%%CIT_${sources.length-1}%%`;
                });
                return { textWithTokens, sources };
            }

            // Bubble Creator
            function createMessageBubble(text, sender, animate=true) {
                const wrapper = document.createElement('div');
                wrapper.className = `flex mb-4 ${sender==='user'?'justify-end':'justify-start'}`;
                const bubble = document.createElement('div');
                bubble.className = `rounded-xl p-4 max-w-2xl shadow-md ${sender==='user'?'bg-emerald-600':'bg-gray-700'} text-gray-100 text-sm`;
                
                if(sender === 'model') {
                    const { textWithTokens, sources } = processCitations(text);
                    const div = document.createElement('div');
                    div.className = "ai-response-content"; // Styling hook
                    
                    let html = marked.parse(textWithTokens);
                    const srcJson = encodeURIComponent(JSON.stringify(sources));
                    
                    // Replace Tokens with Green Pins
                    sources.forEach((s, i) => {
                        const icon = `<span class="citation-link" onclick="window.openSourcePanel('${srcJson}')" title="${s.name}"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244" /></svg></span>`;
                        html = html.split(`%%CIT_${i}%%`).join(icon);
                    });
                    
                    div.innerHTML = html;
                    bubble.appendChild(div);

                    // FOOTER: Sources + Workspace Button
                    const footer = document.createElement('div');
                    footer.className = "mt-3 pt-3 border-t border-gray-600 flex items-center justify-between";
                    
                    let leftButtons = "";
                    if(sources.length > 0) {
                        leftButtons = `<button onclick="window.openSourcePanel('${srcJson}')" class="text-xs text-emerald-400 hover:text-white flex items-center gap-1"><svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/></svg> ${sources.length} Sources</button>`;
                    }

                    // SEND TO WORKSPACE BUTTON
                    const safeHtml = encodeURIComponent(html);
                    const rightButtons = `<button onclick="window.sendToWorkspace('${safeHtml}')" class="text-xs bg-gray-800 hover:bg-gray-900 border border-gray-600 px-2 py-1 rounded text-blue-300 font-bold flex items-center gap-1"><span>‚á±</span> Add to Workspace</button>`;

                    footer.innerHTML = `${leftButtons} ${rightButtons}`;
                    bubble.appendChild(footer);

                } else {
                    bubble.innerText = text;
                }
                wrapper.appendChild(bubble);
                chatArea.appendChild(wrapper);
                chatArea.scrollTop = chatArea.scrollHeight;
            }

            // Send Logic
            async function sendMessage() {
                let txt = userInput.value.trim();
                if(!txt && !attachedFileContent) return;
                
                // Construct Payload
                let finalPrompt = txt;
                if(attachedFileContent) {
                    finalPrompt += `\n\n[FILE: ${attachedFileName}]\n${attachedFileContent}`;
                    createMessageBubble(`üìÇ Uploaded: ${attachedFileName}`, 'user');
                    attachedFileContent = null; 
                    filePreviewArea.classList.add('hidden');
                }
                
                if(txt) createMessageBubble(txt, 'user');
                
                chatHistory.push({role:'user', parts:[{text: finalPrompt}]});
                userInput.value = '';
                
                // Save Chat
                if(currentProjectId) localStorage.setItem(`duvallo_project_${currentProjectId}_chat`, JSON.stringify(chatHistory));

                // Loading
                const loading = document.createElement('div');
                loading.id = "loadingIndicator";
                loading.className = "flex items-center gap-2 text-gray-500 text-xs ml-4 my-2";
                loading.innerHTML = `<svg class="animate-spin h-4 w-4 text-emerald-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Duvallo is thinking...`;
                chatArea.appendChild(loading);
                chatArea.scrollTop = chatArea.scrollHeight;

                try {
                    // Check Auth
                    if(!window.Clerk || !window.Clerk.session) {
                        if(loading) loading.remove();
                        return alert("Security: Please log in.");
                    }
                    const token = await window.Clerk.session.getToken();

                    const res = await fetch('/api/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify({
                            systemInstruction: { 
                                parts: [{ text: "You are Duvallo. CRITICAL RULES: 1. Use Google Search for facts. 2. CITATIONS ARE MANDATORY. Format: [Source Name](URL). 3. Use Markdown. 4. If creating a Table/Strategy, format it cleanly so it can be exported." }] 
                            },
                            messages: chatHistory
                        })
                    });
                    
                    const data = await res.json();
                    if(loading) loading.remove();

                    if(data.error) throw new Error(data.error.message);

                    const aiText = data.candidates[0].content.parts[0].text;
                    chatHistory.push({role:'model', parts:[{text: aiText}]});
                    createMessageBubble(aiText, 'model');
                    
                    // Save Chat Again
                    if(currentProjectId) localStorage.setItem(`duvallo_project_${currentProjectId}_chat`, JSON.stringify(chatHistory));

                } catch(e) {
                    if(loading) loading.remove();
                    createMessageBubble("‚ö†Ô∏è Error: " + e.message, 'model');
                }
            }

            // Bind Events
            if(sendButton) sendButton.onclick = sendMessage;
            if(userInput) userInput.onkeydown = (e) => { 
                if(e.key==='Enter' && !e.shiftKey) { 
                    e.preventDefault(); 
                    sendMessage(); 
                }
            };
            
            // Auto Resize Input
            if(userInput) userInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });

            // --- EXPORT LOGIC ---

            // 1. PDF Export (From Workspace)
            // Note: In your HTML sidebar, the button ID is 'exportBtn'
            if(exportBtn) exportBtn.onclick = () => {
                const element = document.getElementById('workspaceContent');
                // Temporarily remove border/shadow for clean print
                const originalStyle = element.style.cssText;
                element.style.border = "none";
                element.style.boxShadow = "none";
                
                html2pdf().set({
                    margin: 0.5,
                    filename: `Duvallo_Strategy_${Date.now()}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, useCORS: true },
                    jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
                }).from(element).save().then(() => {
                    element.style.cssText = originalStyle; // Restore style
                });
            };

            // 2. PPTX Export (From Chat History - Generates Slides)
            const exportPptxBtn = document.getElementById('exportPptxBtn');
            if(exportPptxBtn) exportPptxBtn.onclick = () => {
                if(chatHistory.length === 0) return alert("No content to export.");
                
                let pptx = new PptxGenJS();
                pptx.layout = 'LAYOUT_16x9';
                pptx.author = 'Duvallo Strategy Engine';
                
                // Title Slide
                let slide = pptx.addSlide();
                slide.background = { color: '111827' };
                slide.addText("Strategy Deck", { x:0.5, y:2.5, w:'90%', fontSize:36, color:'ffffff', align:'center', bold:true });
                slide.addText(`Generated on ${new Date().toLocaleDateString()}`, { x:0.5, y:3.5, w:'90%', fontSize:14, color:'34d399', align:'center' });

                // Content Slides
                chatHistory.forEach(msg => {
                    if(msg.role === 'model') {
                        let text = msg.parts[0].text;
                        // Clean up internal tags
                        text = text.replace(/---SUGGESTIONS---[\s\S]*$/, '').replace(/<<<.*?>>>/g, '');
                        
                        // Create a new slide for every major section
                        let slide = pptx.addSlide();
                        slide.background = { color: 'ffffff' };
                        slide.addText("Consultant Analysis", { x:0.5, y:0.5, w:'90%', fontSize:18, color:'064e3b', bold:true });
                        slide.addText(text.substring(0, 1000), { x:0.5, y:1.5, w:'90%', h:'70%', fontSize:12, color:'1f2937', wrap:true });
                    }
                });
                pptx.writeFile({ fileName: "Duvallo_Deck.pptx" });
            };

            // 3. CSV Export (Extracts Tables)
            const exportCsvBtn = document.getElementById('exportCsvBtn');
            if(exportCsvBtn) exportCsvBtn.onclick = () => {
                let csvContent = "";
                let tablesFound = 0;
                
                chatHistory.forEach((msg, i) => {
                    if(msg.role === 'model') {
                        // Find Markdown Tables
                        const tableRegex = /(\|.*\|\n\|[-:| ]+\|\n(?:\|.*\|\n?)+)/g;
                        let match;
                        while ((match = tableRegex.exec(msg.parts[0].text)) !== null) {
                            tablesFound++;
                            csvContent += `TABLE ${tablesFound} (Message ${i+1})\n`;
                            let rows = match[0].trim().split('\n');
                            rows.forEach(row => {
                                if(row.includes('---')) return; // Skip separator
                                let cells = row.split('|').filter((c, idx, arr) => idx > 0 && idx < arr.length-1);
                                let cleanCells = cells.map(c => `"${c.trim().replace(/"/g, '""')}"`);
                                csvContent += cleanCells.join(",") + "\n";
                            });
                            csvContent += "\n";
                        }
                    }
                });

                if(tablesFound === 0) return alert("No tables found to export.");
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.setAttribute("href", url);
                link.setAttribute("download", "Duvallo_Data.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            // Initialize Phase 1
            switchPhase(1);

        })();
    </script>
</body>
</html>
