<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulting Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PDF.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Georgia:wght@400;700&family=Roboto+Slab:wght=700&display=swap');
        
        body {
            font-family: 'Georgia', sans-serif;
            background-color: #111827; /* Gray 900 */
            color: #f3f4f6;
            height: 100vh;
            overflow: hidden; /* Prevent body scroll, handle inside containers */
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        /* Typography for AI Responses */
        .ai-response-content h1 { font-size: 1.5rem; font-weight: 700; margin-bottom: 0.75rem; color: #bef264; }
        .ai-response-content h2 { font-size: 1.25rem; font-weight: 700; margin-top: 1rem; margin-bottom: 0.5rem; color: #bef264; }
        .ai-response-content h3 { font-size: 1.1rem; font-weight: 700; margin-top: 0.75rem; color: #facc15; }
        .ai-response-content ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 0.75rem; }
        .ai-response-content li { margin-bottom: 0.25rem; }
        .ai-response-content strong { color: #facc15; }
        
        /* Table Styling */
        .ai-response-content table { width: 100%; border-collapse: collapse; margin-top: 0.5rem; font-size: 0.9rem; }
        .ai-response-content th, .ai-response-content td { border: 1px solid #4b5563; padding: 0.5rem; text-align: left; }
        .ai-response-content th { background-color: #374151; color: #f3f4f6; }
        .ai-response-content td { background-color: #1f2937; }

        /* Sidebar Buttons */
        .sidebar-btn {
            font-family: 'Roboto Slab', serif;
            width: 100%;
            text-align: left;
            padding: 0.75rem 1rem;
            background-color: #1f2937; /* Gray 800 */
            border: 1px solid #374151;
            border-radius: 0.5rem;
            color: #e5e7eb;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .sidebar-btn:hover { background-color: #374151; border-color: #10b981; }
        
        /* Submenu styling in sidebar */
        .sidebar-menu {
            background-color: #111827;
            border: 1px solid #374151;
            border-radius: 0.5rem;
            margin-top: 0.25rem;
            overflow: hidden;
        }
        .sub-menu-btn {
            display: block;
            width: 100%;
            text-align: left;
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
            color: #9ca3af;
            transition: color 0.2s, background-color 0.2s;
        }
        .sub-menu-btn:hover { color: #10b981; background-color: #1f2937; }

        /* Utility Buttons (Right Side) - Updated */
        .utility-btn {
            width: 100%;
            height: 42px; /* Fixed height for uniformity */
            padding: 0 1rem;
            background-color: #4b5563;
            color: white;
            border-radius: 0.5rem;
            font-weight: bold;
            font-size: 0.85rem;
            margin-bottom: 0.75rem;
            transition: all 0.2s;
            /* Centering Logic */
            display: flex; 
            justify-content: center; 
            align-items: center;
            position: relative; 
        }
        .utility-btn:hover { background-color: #6b7280; }
        
        /* Force the arrow icon to the far right so text stays centered */
        .utility-btn svg {
            position: absolute;
            right: 12px;
        }

        /* User Message Actions (Copy/Edit) */
        .message-wrapper:hover .user-action-container {
            opacity: 1;
        }
        
        .user-action-container {
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
            display: flex;
            gap: 0.5rem;
            align-items: center;
            margin-right: 0.75rem;
        }
        
        .action-icon-btn {
            padding: 6px;
            border-radius: 50%;
            color: #9ca3af; /* Gray-400 */
            background-color: #1f2937; /* Dark background */
            border: 1px solid #374151;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .action-icon-btn:hover {
            color: #f3f4f6;
            background-color: #374151;
            border-color: #10b981; /* Emerald border */
        }
        
        /* Input Area Styling */
        #userInput {
            line-height: 1.5;
            resize: none; 
            max-height: 150px;
        }
    /* === CITATION STYLES === */
        .citation-link {
            display: inline-block;
            vertical-align: middle;
            margin-left: 2px;
            background-color: #374151;
            border-radius: 50%;
            padding: 2px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .citation-link:hover { background-color: #4b5563; }
        .citation-link svg { width: 14px; height: 14px; color: #9ca3af; }

        .sources-section {
            margin-top: 1rem;
            border-top: 1px solid #374151;
            padding-top: 0.75rem;
        }

        .sources-toggle-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background-color: transparent;
            border: 1px solid #6b7280;
            color: #d1d5db;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            transition: all 0.2s;
        }
        .sources-toggle-btn:hover { background-color: #374151; border-color: #9ca3af; }

        .sources-list {
            margin-top: 0.75rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .source-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
            color: #93c5fd;
            text-decoration: none;
            padding: 0.25rem;
            border-radius: 0.25rem;
        }
        .source-item:hover { background-color: #1f2937; text-decoration: underline; }
        .source-favicon { width: 16px; height: 16px; background-color: #fff; border-radius: 2px; }
    </style>
</head>
<body class="flex h-screen w-full bg-gray-900">

    <!-- LEFT SIDEBAR (Phases) -->
    <aside class="w-64 bg-gray-800 border-r border-gray-700 flex flex-col flex-shrink-0 z-20">
       <!-- Logo Area -->
        <div class="p-6 border-b border-gray-700 flex items-center gap-3">
            <div class="p-1.5 bg-white rounded-full border-2 border-green-700 flex-shrink-0">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" width="28" height="28">
                    <circle cx="50" cy="50" r="8" fill="none" stroke="#4a5d3e" stroke-width="4"/>
                    <g stroke="#4a5d3e" stroke-width="3" fill="none">
                        <line x1="50" y1="50" x2="50" y2="20"/><circle cx="50" cy="20" r="6"/>
                        <line x1="50" y1="50" x2="75" y2="30"/><circle cx="75" cy="30" r="6"/>
                        <line x1="50" y1="50" x2="75" y2="70"/><circle cx="75" cy="70" r="6"/>
                        <line x1="50" y1="50" x2="50" y2="80"/><circle cx="50" cy="80" r="6"/>
                        <line x1="50" y1="50" x2="25" y2="70"/><circle cx="25" cy="70" r="6"/>
                        <line x1="50" y1="50" x2="25" y2="30"/><circle cx="25" cy="30" r="6"/>
                    </g>
                </svg>
            </div>
            <h1 class="font-bold text-lg text-white tracking-wide">Bob Assistant</h1>
        </div>

        <!-- PROJECT CONTROLS (Always Visible) -->
        <div class="p-4 border-b border-gray-700 space-y-2">
            <button id="newProjectBtn" class="w-full py-2 px-3 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg font-bold text-sm transition flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                New Project
            </button>
            <button id="loadProjectBtn" class="w-full py-2 px-3 bg-gray-700 hover:bg-gray-600 text-gray-200 rounded-lg font-bold text-sm transition flex items-center justify-center gap-2 border border-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.75V12A2.25 2.25 0 014.5 9.75h15A2.25 2.25 0 0121.75 12v.75m-8.69-6.44l-2.12-2.12a1.5 1.5 0 00-1.061-.44H4.5A2.25 2.25 0 002.25 6v12a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9a2.25 2.25 0 00-2.25-2.25h-5.379a1.5 1.5 0 01-1.06-.44z" /></svg>
                Load Project
            </button>
            <button id="deleteProjectBtn" class="w-full py-2 px-3 bg-red-900/30 hover:bg-red-800 text-red-200 rounded-lg font-bold text-sm transition flex items-center justify-center gap-2 border border-red-800">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg>
                Delete Project
            </button>
        </div>

        <!-- PHASE MENUS (Hidden by default) -->
        <div id="phaseMenuContainer" class="hidden flex-1 overflow-y-auto p-4 space-y-4 opacity-50 transition-opacity duration-500">
            
            <div class="text-xs text-gray-500 font-bold uppercase tracking-widest mb-2">Project Phases</div>

            <!-- Phase 1 -->
            <div>
                <button id="initialSetupDropdownBtn" class="sidebar-btn">
                    Initial Setup
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>
                <div id="initialSetupMenu" class="sidebar-menu hidden"></div>
            </div>

            <!-- Phase 2 -->
            <div>
                <button id="analysisDropdownBtn" class="sidebar-btn">
                    Analysis
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>
                <div id="analysisMenu" class="sidebar-menu hidden"></div>
            </div>

            <!-- Phase 3 -->
            <div>
                <button id="solutionDesignDropdownBtn" class="sidebar-btn">
                    Solution Design
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>
                <div id="solutionDesignMenu" class="sidebar-menu hidden"></div>
            </div>

            <!-- Phase 4 -->
            <div>
                <button id="executionDropdownBtn" class="sidebar-btn">
                    Execution
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>
                <div id="executionMenu" class="sidebar-menu hidden"></div>
            </div>
            
            <!-- Current Project Indicator -->
            <div id="currentProjectBadge" class="mt-6 p-3 bg-gray-900 rounded border border-gray-700 text-center hidden">
                <div class="text-xs text-gray-500">Active Project</div>
                <div id="currentProjectNameDisplay" class="text-sm font-bold text-emerald-400 truncate"></div>
            </div>

        </div>
    </aside>

    <!-- CENTER CHAT AREA -->
    <main class="flex-1 flex flex-col relative bg-gray-900">
        
        <!-- Chat History Container (The "Grey Box") -->
        <div id="chatArea" class="flex-1 overflow-y-auto p-8 space-y-6">
            <!-- Messages will be injected here -->
        </div>

        <!-- HERO TEXT (Initially Visible, Hides on Chat) -->
        <div id="heroText" class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none z-0">
            <h2 class="text-4xl font-bold text-gray-200 tracking-tight drop-shadow-lg">Should we start building?</h2>
            <p class="text-gray-500 mt-2">Select a project from the left or type below.</p>
        </div>

        <!-- Input Area (Fixed Bottom) -->
        <div class="p-6 bg-gray-900 z-10">
            <!-- Unified Input Capsule (Gemini Style) -->
            <div class="max-w-4xl mx-auto relative flex items-end gap-2 bg-[#2f2f2f] p-2 rounded-[2rem] border border-gray-700 shadow-xl focus-within:border-emerald-500 focus-within:ring-1 focus-within:ring-emerald-500 transition-all">
                
                <!-- Hidden File Input -->
                <input type="file" id="hiddenFileInput" style="display: none;" accept=".txt,.md,.csv,.json,.js,.html,.css,.xml,.pdf">
                
                <!-- Attachment Button (Left) -->
                <button id="attachBtn" class="p-3 text-gray-400 hover:text-white transition-colors rounded-full hover:bg-gray-700 flex-shrink-0 mb-0.5" title="Attach file">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M18.375 12.739l-7.693 7.693a4.5 4.5 0 01-6.364-6.364l10.94-10.94A3 3 0 1119.5 7.372L8.552 18.32m.009-.01l-.01.01m5.699-9.941l-7.81 7.81a1.5 1.5 0 002.112 2.13" />
                    </svg>
                </button>

                <!-- Middle Column: File Preview + Text Input -->
                <div class="flex-1 flex flex-col justify-end min-w-0">
                    
                    <!-- File Preview Card (Hidden by default) -->
                    <div id="filePreviewArea" class="hidden mb-2 px-1">
                        <!-- Javascript will inject the card here -->
                    </div>

                    <!-- Text Input -->
                    <textarea id="userInput" 
                        placeholder="Ask a question..." 
                        rows="1" 
                        class="w-full bg-transparent text-gray-100 placeholder-gray-500 border-none focus:ring-0 resize-none overflow-y-hidden py-3 text-base leading-relaxed max-h-32"
                        style="min-height: 48px;"></textarea>
                </div>

                <!-- Send Button (Right) -->
                <button id="sendButton" class="p-3 bg-emerald-600 text-white rounded-full hover:bg-emerald-500 transition-transform transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed shadow-lg flex-shrink-0 mb-0.5">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 10.5L12 3m0 0l7.5 7.5M12 3v18" />
                    </svg>
                </button>
            </div>
            <p class="text-center text-xs text-gray-500 mt-2">Bob can make mistakes. Verify important information.</p>
        </div>
    </main>

    <!-- RIGHT SIDEBAR (Utilities) -->
    <aside class="w-64 bg-gray-800 border-l border-gray-700 flex flex-col flex-shrink-0 z-20 p-4">
        
        <!-- WRAPPER FOR TOGGLING VISIBILITY -->
        <div id="toolsMenuContainer" class="hidden w-full h-full flex flex-col">
            
            <h3 class="text-gray-400 text-xs font-bold uppercase tracking-wider mb-4 text-center">Tools</h3>
            
            <!-- My Prompts -->
            <div class="relative mb-0"> 
                <button id="myPromptsDropdownBtn" class="utility-btn">
                    My Prompts
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>
                <div id="myPromptsMenu" class="absolute hidden top-full left-0 w-full bg-gray-700 rounded-lg shadow-xl z-30 border border-gray-600 p-2 mt-1"></div>
            </div>

            <!-- Takeaways -->
            <button id="generateTakeawaysBtn" class="utility-btn">Generate Takeaways</button>

            <!-- Workflow -->
            <div class="relative mb-0">
                <button id="workflowBtn" class="utility-btn">
                    Run Workflow
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>
                <div id="workflowMenu" class="absolute hidden top-full right-0 w-64 bg-gray-700 rounded-lg shadow-xl z-30 border border-gray-600 p-2 mt-1">
                    <button class="workflow-option w-full text-left px-3 py-2 text-sm text-gray-200 hover:bg-gray-600 rounded" data-workflow="market-entry-strategy">Market Entry Strategy</button>
                    <button class="workflow-option w-full text-left px-3 py-2 text-sm text-gray-200 hover:bg-gray-600 rounded" data-workflow="business-health-check">Business Health Check</button>
                    <button class="workflow-option w-full text-left px-3 py-2 text-sm text-gray-200 hover:bg-gray-600 rounded" data-workflow="competitive-analysis">Competitive Analysis</button>
                </div>
            </div>

            <!-- Export -->
            <button id="exportBtn" class="utility-btn">Export Chat</button>

            <div class="flex-grow"></div> <!-- Spacer -->

            <!-- Clear Chat -->
            <button id="clearChatBtn" class="w-full px-4 py-2 border border-red-500 text-red-400 rounded-lg hover:bg-red-900/20 transition text-sm font-bold flex justify-center items-center">
                Clear Chat
            </button>
        </div>
        
        <!-- Placeholder when no project selected -->
        <div id="noProjectToolState" class="flex-1 flex items-center justify-center text-center text-gray-600 text-sm p-4">
            Select a project to access tools
        </div>

    </aside>
    <script>
        (function() {
            // ELEMENT REFERENCES
            const sendButton = document.getElementById('sendButton');
            const userInput = document.getElementById('userInput');
            const chatArea = document.getElementById('chatArea');
            const heroText = document.getElementById('heroText'); // The "Should we start..." text
            const clearChatBtn = document.getElementById('clearChatBtn');
            const generateTakeawaysBtn = document.getElementById('generateTakeawaysBtn');
            const attachBtn = document.getElementById('attachBtn');
            const hiddenFileInput = document.getElementById('hiddenFileInput');

            // DROPDOWN ELEMENTS
            const initialSetupDropdownBtn = document.getElementById('initialSetupDropdownBtn');
            const initialSetupMenu = document.getElementById('initialSetupMenu');
            const analysisDropdownBtn = document.getElementById('analysisDropdownBtn');
            const analysisMenu = document.getElementById('analysisMenu');
            const solutionDesignDropdownBtn = document.getElementById('solutionDesignDropdownBtn');
            const solutionDesignMenu = document.getElementById('solutionDesignMenu');
            const executionDropdownBtn = document.getElementById('executionDropdownBtn');
            const executionMenu = document.getElementById('executionMenu');
            const myPromptsDropdownBtn = document.getElementById('myPromptsDropdownBtn');
            const myPromptsMenu = document.getElementById('myPromptsMenu');
            const workflowBtn = document.getElementById('workflowBtn');
            const workflowMenu = document.getElementById('workflowMenu');
            const exportBtn = document.getElementById('exportBtn');

            let MIN_HEIGHT = 0; 
            const chatHistory = [];
            let awaitingPlanResponse = false;
            let attachedFileContent = null;
            let attachedFileName = null;

            // ============================================
            // 0. PROJECT MANAGEMENT SYSTEM
            // ============================================
            let currentProjectId = null;
            const phaseMenuContainer = document.getElementById('phaseMenuContainer');
            const toolsMenuContainer = document.getElementById('toolsMenuContainer');
            const noProjectToolState = document.getElementById('noProjectToolState');
            const currentProjectBadge = document.getElementById('currentProjectBadge');
            const currentProjectNameDisplay = document.getElementById('currentProjectNameDisplay');

            // Load Project List from LocalStorage
            function getProjects() {
                return JSON.parse(localStorage.getItem('bob_projects_index') || '[]');
            }

            // Save Chat to Current Project
            function saveCurrentProjectChat() {
                if (!currentProjectId) return;
                localStorage.setItem(`bob_project_${currentProjectId}_chat`, JSON.stringify(chatHistory));
            }

            // Switch to a specific project
            function activateProject(id, name) {
                currentProjectId = id;
                
                // 1. Update UI Visibility
                phaseMenuContainer.classList.remove('hidden', 'opacity-50');
                phaseMenuContainer.classList.add('opacity-100');
                toolsMenuContainer.classList.remove('hidden');
                noProjectToolState.classList.add('hidden');
                
                // 2. Update Hero Text
                heroText.style.display = 'none';
                
                // 3. Update Badge
                currentProjectBadge.classList.remove('hidden');
                currentProjectNameDisplay.textContent = name;

                // 4. Load Chat History
                chatArea.innerHTML = ''; // Clear screen
                chatHistory.length = 0; // Clear memory array
                
                const savedChat = JSON.parse(localStorage.getItem(`bob_project_${id}_chat`) || '[]');
                
                if (savedChat.length > 0) {
                    savedChat.forEach(msg => {
                        // 1. Restore to memory
                        chatHistory.push(msg); 
                        
                        // 2. Restore to UI 
                        // We use the main bubble function so citations, charts, and tables render correctly!
                        createMessageBubble(msg.parts[0].text, msg.role);
                    });
                    
                    // Scroll to bottom
                    setTimeout(() => chatArea.scrollTop = chatArea.scrollHeight, 100);
                } else {
                    // New Project: Show Hero Text
                     heroText.style.display = 'flex';
                }
            }

            // EVENT: New Project
            document.getElementById('newProjectBtn').onclick = () => {
                const name = prompt("Enter Project Name (e.g., 'Q3 Sales Strategy'):");
                if (!name) return;

                const id = Date.now().toString();
                const projects = getProjects();
                projects.push({ id, name, date: new Date().toISOString() });
                localStorage.setItem('bob_projects_index', JSON.stringify(projects));
                
                activateProject(id, name);
            };

            // EVENT: Load Project
            document.getElementById('loadProjectBtn').onclick = () => {
                const projects = getProjects();
                if (projects.length === 0) return alert("No saved projects found.");

                // Simple prompt selection (can be upgraded to modal later)
                let list = "Select a project by number:\n";
                projects.forEach((p, i) => list += `${i + 1}. ${p.name}\n`);
                
                const choice = prompt(list);
                if (choice && projects[choice - 1]) {
                    activateProject(projects[choice - 1].id, projects[choice - 1].name);
                }
            };

            // EVENT: Delete Project
            document.getElementById('deleteProjectBtn').onclick = () => {
                const projects = getProjects();
                if (projects.length === 0) return alert("No saved projects to delete.");

                // List projects
                let list = "Type the number of the project to DELETE:\n";
                projects.forEach((p, i) => list += `${i + 1}. ${p.name}\n`);
                
                const choice = prompt(list);
                const projectToDelete = projects[choice - 1];

                if (choice && projectToDelete) {
                    // CONFIRMATION POPUP
                    const confirmDelete = confirm(`⚠️ ARE YOU SURE?\n\nYou are about to delete "${projectToDelete.name}".\nThis action cannot be undone.`);
                    
                    if (confirmDelete) {
                        // 1. Remove the chat history data
                        localStorage.removeItem(`bob_project_${projectToDelete.id}_chat`);
                        
                        // 2. Remove from the index array
                        const updatedProjects = projects.filter(p => p.id !== projectToDelete.id);
                        localStorage.setItem('bob_projects_index', JSON.stringify(updatedProjects));
                        
                        // 3. Feedback and Reset
                        alert(`Project "${projectToDelete.name}" has been deleted.`);
                        
                        // Reload page to reset UI and prevent using deleted data
                        location.reload();
                    }
                } else if (choice) {
                    alert("Invalid selection.");
                }
            };

            // ============================================
            // 1. PROMPT MAP (STRUCTURED & CITATION ENFORCED)
            // ============================================
            const PROMPT_MAP = {
                
                // ========================
                // PHASE 1: INITIAL SETUP
                // ========================
                
                'Guided Diagnostic (Interviewer Mode)': `Act as a Senior Partner Consultant conducting a root-cause diagnostic interview. I have a business problem: [input BRIEF PROBLEM DESCRIPTION].

Do NOT provide a solution yet. Instead, generate a structured interview protocol.

The output MUST follow this structure:

# Guided Diagnostic: [Problem Name]
## Objective
[Concise statement of the diagnostic goal]

## Diagnostic Questions
1. **[Topic A - Root Cause]:** [Probing question using the "5 Whys" technique]
2. **[Topic B - Constraints]:** [Question regarding budget, timeline, or resources]
3. **[Topic C - Success Metrics]:** [Question defining what "good" looks like quantitatively]
4. **[Topic D - Stakeholders]:** [Question about decision-makers and blockers]

## Next Steps
Please answer these questions so I can formulate a hypothesis.`,

                'Industry Trends Snapshot': `Act as a Market Researcher. Use Google Search to find **real-time, quantified data** regarding [input SPECIFIED INDUSTRY]. 

**CRITICAL REQUIREMENT:** Cite every data point using inline markdown: [Source Name](URL).

The output MUST strictly follow this high-readability structure:

# [Industry] Trends Snapshot
[Concise executive summary of the current industry landscape]

## Key Trend 1: [Trend Name]
* [Specific data point/statistic with citation]
* [Impact on business models]
* [Future projection]

## Key Trend 2: [Trend Name]
* [Specific data point/statistic with citation]
* [Impact on business models]
* [Future projection]
... (3 to 5 trends total)

## Summary Table
(Ensure there is an empty line before the table)

| Trend | Primary Impact |
|---|---|
| [Trend 1 Name] | * [Impact bullet 1] <br> * [Impact bullet 2] |
| [Trend 2 Name] | * [Impact bullet 1] <br> * [Impact bullet 2] |
| [Trend 3 Name] | * [Impact bullet 1] <br> * [Impact bullet 2] |

The table must be the last element of the response before the suggestions block.`,
              
                'Initial Project Charter Draft': `Act as a Project Manager. Generate a formal Project Charter for [input SPECIFIC PROJECT TYPE]. 

The output MUST strictly follow this professional structure:

# Project Charter: [Project Title]
[Short executive summary of the project's strategic value]

## Project Details
(Ensure there is an empty line before the table)

| Field | Value |
|---|---|
| Project Sponsor | [Recommended Title] |
| Project Manager | [Recommended Title] |
| Target Completion | [Estimated Quarter/Year] |

## Scope Overview
[1-2 paragraphs clearly defining what is included (In-Scope) and explicitly what is excluded (Out-of-Scope).]

## Key Objectives
* [SMART Objective 1]
* [SMART Objective 2]
* [SMART Objective 3]

## Success Metrics (KPIs)
* [Metric 1: Quantitative definition of success]
* [Metric 2: Quantitative definition of success]
* [Metric 3: Quantitative definition of success]

## High-Level Timeline
* Phase 1: Initiation and Planning ([Estimated Duration])
* Phase 2: Execution and Development ([Estimated Duration])
* Phase 3: Deployment and Stabilization ([Estimated Duration])

The timeline must be the last element of the response before the suggestions block.`,
              
                'Problem Statement Draft': `Act as a Strategy Consultant. Draft a precise Problem Statement for [input SPECIFIC ISSUE]. 

The output MUST strictly follow this structure:

# Preliminary Problem Statement
[A single, punchy sentence stating the core business issue.]

## 1. Current State (The Symptom)
[A concise paragraph describing the current measurable negative symptoms.]

## 2. Desired State (The Goal)
[A concise paragraph describing the measurable target outcome.]

## 3. Impact of Solving (The Value)
[A concise paragraph describing the financial or strategic value derived by the business upon successful resolution.]

The "Impact of Solving" section must be the last element of the response before the suggestions block.`,
              
                // ========================
                // PHASE 2: ANALYSIS
                // ========================

                'MECE Logic Check': `Act as a Logic Auditor. Perform a MECE (Mutually Exclusive, Collectively Exhaustive) audit on: [input PASTE ANALYSIS].

The output MUST follow this structure:

# MECE Logic Audit
[Assessment: Is this breakdown logic tight or leaky?]

## Logic Gaps (Missing Elements)
* [Gap 1]
* [Gap 2]

## Overlaps (Redundancies)
* [Overlap 1]

## Proposed MECE Framework
Reorganize the analysis into distinct, non-overlapping buckets:
1. **[Bucket 1]**
   * [Point A]
2. **[Bucket 2]**
   * [Point B]`,

                'Market Analysis': `Act as a Market Analyst. Conduct a rigorous analysis for [input SPECIFIC MARKET / INDUSTRY]. 

**CRITICAL REQUIREMENT:** Use Google Search for data (TAM/CAGR). Cite sources using [Source Name](URL).

The output MUST strictly follow this structure:

# [Analysis Title]
[Executive summary of the market health and maturity]

## Key Trends
* [Trend 1: Data-backed trend with citation]
* [Trend 2: Data-backed trend with citation]
...

## Competitive Landscape
(Ensure there is an empty line before the table)

| Competitor | Market Share/Focus | Key Strengths/Weaknesses |
|---|---|---|
| [Name 1] | [Focus] | * [Strength 1] <br> * [Weakness 1] |
| [Name 2] | [Focus] | * [Strength 1] <br> * [Weakness 1] |

## Future Outlook
* [Projected Growth Rate (CAGR) with citation]
* [Disruptive technologies or regulations]
...

The table must be the last element before the suggestions block.`,
              
                'SWOT Analysis': `Act as a Strategic Planner. Perform a SWOT analysis for [input SPECIFIC COMPANY / PROJECT]. 

**CRITICAL REQUIREMENT:** Use Google Search for External factors. Cite sources using [Source Name](URL).

The output MUST strictly follow this structure:

# SWOT Analysis for [Company/Project]
[A concise paragraph explaining the strategic position.]

## Analysis Matrix
(Ensure there is an empty line before the table)

| Strengths (Internal) | Weaknesses (Internal) | Opportunities (External) | Threats (External) |
|---|---|---|---|
| * [Core Competency 1] | * [Internal Gap 1] | * [Market Trend 1 (Cited)] | * [Competitor Move 1 (Cited)] |
| * [Core Competency 2] | * [Internal Gap 2] | * [Market Trend 2 (Cited)] | * [Regulation 1 (Cited)] |

The table must be the last element of the response before the suggestions block.`,
              
                'Competitor Benchmarking': `Act as a Competitive Intelligence Analyst. Perform a detailed benchmarking analysis for [input COMPANY A] against [input COMPETITOR B] and [input COMPETITOR C]. 

**CRITICAL REQUIREMENT:** Use Google Search for pricing/features. Cite sources using [Source Name](URL).

The output MUST strictly follow this structure:

# Competitor Benchmarking Report
[A brief introduction defining the competitive scope.]

## Benchmarking Table
(Ensure there is an empty line before the table)

| Competitor | Market Share | Product Features | Pricing Model | Sentiment |
|---|---|---|---|---|
| **[Competitor B]** | [Est. Share] | * [Feature 1] <br> * [Feature 2] | [Pricing] | [Rating] |
| **[Competitor C]** | [Est. Share] | * [Feature 1] <br> * [Feature 2] | [Pricing] | [Rating] |

The table must be the last element of the response before the suggestions block.`,
              
                '5 Forces Analysis': `Act as an Industry Analyst. Conduct a Porter's 5 Forces Analysis for [input SPECIFIC INDUSTRY]. 

**CRITICAL REQUIREMENT:** Use Google Search for evidence. Cite sources using [Source Name](URL).

The output MUST strictly follow this structure:

# Porter's Five Forces Analysis: [Industry]
[A concise paragraph summarizing the overall industry attractiveness.]

## Industry Structure Summary
(Ensure there is an empty line before the table)

| Force | Threat Level | Key Drivers/Evidence |
|---|---|---|
| **Threat of New Entrants** | [High/Med/Low] | * [Barriers details (Cited)] |
| **Bargaining Power of Buyers** | [High/Med/Low] | * [Buyer concentration] |
| **Bargaining Power of Suppliers** | [High/Med/Low] | * [Supplier concentration] |
| **Threat of Substitutes** | [High/Med/Low] | * [Price/performance trade-off] |
| **Competitive Rivalry** | [High/Med/Low] | * [Industry growth rate] |

The table must be the last element of the response before the suggestions block.`,
              
                'PESTLE Analysis': `Act as a Macro-Economic Analyst. Perform a PESTLE analysis for [input SPECIFIC COMPANY / INDUSTRY]. 

**CRITICAL REQUIREMENT:** Use Google Search for Regulations/Economics. Cite sources using [Source Name](URL).

The output MUST strictly follow this structure:

# PESTLE Analysis for [Company/Industry]
[A brief introduction explaining the most critical macro-factors.]

The remaining analysis MUST be presented in a specific two-column table format:
(Ensure there is an empty line before the table)

| Factor | Key Findings |
|---|---|
| **Political** | * [Trade/Stability (Cited)] <br> * [Taxation] |
| **Economic** | * [Inflation/Rates (Cited)] <br> * [Growth] |
| **Social** | * [Demographics] <br> * [Lifestyle] |
| **Technological** | * [Innovation] <br> * [Disruption] |
| **Legal** | * [Employment law] <br> * [Regulations (Cited)] |
| **Environmental** | * [Carbon footprint] <br> * [Sustainability] |

The table must be the last element of the response before the suggestions block.`,

                'Hofstede Analysis': `Act as a Cross-Cultural Consultant. Perform a Hofstede's Cultural Dimensions analysis for [input SPECIFIC COUNTRY/CULTURE] regarding [input BUSINESS SCENARIO]. 
                
**CRITICAL REQUIREMENT:** Use Google Search for actual scores. Cite sources using [Source Name](URL).

The output MUST strictly follow this structure:

# Hofstede's Cultural Analysis: [Country]
[A concise introductory paragraph.]

## Cultural Dimensions Summary
(Ensure there is an empty line before the table)

| Dimension | Score/Rating | Business Implication |
|---|---|---|
| **Power Distance (PDI)** | [Score] | * [Implication 1] <br> * [Implication 2] |
| **Individualism (IDV)** | [Score] | * [Implication 1] <br> * [Implication 2] |
| **Masculinity (MAS)** | [Score] | * [Implication 1] <br> * [Implication 2] |
| **Uncertainty Avoidance (UAI)** | [Score] | * [Implication 1] <br> * [Implication 2] |
| **Long-Term Orientation (LTO)** | [Score] | * [Implication 1] <br> * [Implication 2] |
| **Indulgence (IVR)** | [Score] | * [Implication 1] <br> * [Implication 2] |

The table must be the last element of the response before the suggestions block.`,
                
                // ========================
                // PHASE 3: SOLUTION DESIGN
                // ========================

                "Devil's Advocate Review": `Act as a "Red Team" Lead. Stress-test my current strategy. Switch personas to a skeptical opponent.
                
The output MUST follow this structure:

# Strategic Stress Test
[Introductory critique - be direct]

## Critical Flaws & Assumptions
(Ensure there is an empty line before the table)

| Assumption | Probability | Impact |
|---|---|---|
| [Assumption 1] | [High/Med/Low] | [High/Med/Low] |
| [Assumption 2] | [High/Med/Low] | [High/Med/Low] |

## The "Pre-Mortem" (Worst Case)
* [Detailed scenario description if the plan fails strictly]

## Cognitive Bias Check
* [Identify biases: Sunk Cost, Confirmation Bias, etc.]`,

                'Business Plan Outline': `Act as a Business Strategy Consultant. Draft a comprehensive business plan outline for a [input YOUR BUSINESS IDEA].

The output MUST strictly follow this structure:

# Business Plan Outline: [Your Business Idea]
[A concise introductory summary.]

## Executive Summary
* [Value Proposition]
* [Target Market]
* [Revenue Model]

## Company Description
* [Mission]
* [Legal Structure]
* [Team]

## Market Analysis
* [Trends]
* [Competitive Advantage]
* [Market Size]

## Organization & Management
* [Structure]
* [Roles]

## Service/Product Line
* [Description]
* [Development Status]
* [IP]

## Marketing & Sales
* [Channels]
* [Strategy]

## Financial Projections
* [Startup Costs]
* [Revenue Forecast]
* [Funding Request]

## Appendix
* [Supporting Documents]

The Appendix section must be the last element of the response before the suggestions block.`,
              
                'Market Entry Strategy': `Act as a Global Expansion Consultant. Develop a market entry strategy for [input PRODUCT / SERVICE] entering [input SPECIFIC COUNTRY / MARKET]. 

**CRITICAL REQUIREMENT:** Use Google Search for local data. Cite sources using [Source Name](URL).

The output MUST strictly follow this structure:

# Market Entry Strategy: [Product] in [Market]
[A brief paragraph summarizing the recommended approach.]

## Target Audience
* [Demographics]
* [Local Needs]

## Distribution Strategy
* [Channels]
* [Logistics]

## Pricing Model
* [Strategy]
* [Currency Considerations]

## Market Entry Options Summary
(Ensure there is an empty line before the table)

| Method | Key Advantages | Key Disadvantages |
|---|---|---|
| [Method 1] | * [Advantage 1] <br> * [Advantage 2] | * [Disadvantage 1] <br> * [Disadvantage 2] |
| [Method 2] | * [Advantage 1] <br> * [Advantage 2] | * [Disadvantage 1] <br> * [Disadvantage 2] |
| [Method 3] | * [Advantage 1] <br> * [Advantage 2] | * [Disadvantage 1] <br> * [Disadvantage 2] |

The table must be the last element of the response before the suggestions block.`,

                'Go-to-market Strategy': `Act as a CMO. Develop a GTM Strategy for [input PRODUCT / SERVICE] targeting [input SPECIFIC AUDIENCE]. 

The output MUST strictly follow this structure:

# Go-to-Market Strategy: [Product]
[A brief introductory paragraph.]

## Target Customer Profile (ICP)
* [Demographic/Firmographic]
* [Pain Points]
* [UVP]

## Channel and Tactics Plan
(Ensure there is an empty line before the table)

| Channel | Tactics | Timeline |
|---|---|---|
| **Marketing** | * [Tactic 1] <br> * [Tactic 2] | [Timeline] |
| **Sales** | * [Tactic 1] <br> * [Tactic 2] | [Timeline] |
| **Retention** | * [Tactic 1] <br> * [Tactic 2] | [Timeline] |

## Pricing & Packaging
* [Model]
* [Offers]

## Launch Metrics (KPIs)
* [Metric 1]
* [Metric 2]
* [Metric 3]

The "Launch Metrics" section must be the last element of the response before the suggestions block.`,

                'Ansoff Matrix': `Act as a Growth Strategist. Apply the Ansoff Matrix to recommend growth strategies for [input COMPANY NAME / PRODUCT IDEA ]. 

The output MUST strictly follow this structure:

# Ansoff Matrix Growth Recommendations
[A concise introduction.]

## Growth Strategy Matrix
(Ensure there is an empty line before the table)

| Strategy | Product/Market Status | Key Action/Risk |
|---|---|---|
| **Market Penetration** | Existing Product / Existing Market | * [Action 1] <br> * [Action 2] |
| **Product Development** | New Product / Existing Market | * [Action 1] <br> * [Action 2] |
| **Market Development** | Existing Product / New Market | * [Action 1] <br> * [Action 2] |
| **Diversification** | New Product / New Market | * [Action 1] <br> * [Action 2] |

The table must be the last element of the response before the suggestions block.`,
              
                'Risk Analysis': `Act as a Risk Manager. Conduct a risk analysis for [input SPECIFIC BUSINESS VENTURE]. 

The output MUST strictly follow this structure:

# High-Level Risk Analysis: [Venture Name]
[A brief introductory statement.]

## Risk Mitigation Table
(Ensure there is an empty line before the table)

| Risk Area | Likelihood | Impact | Mitigation Strategy |
|---|---|---|---|
| **[Risk 1]** | [H/M/L] | [H/M/L] | * [Strategy 1] <br> * [Strategy 2] |
| **[Risk 2]** | [H/M/L] | [H/M/L] | * [Strategy 1] <br> * [Strategy 2] |
| **[Risk 3]** | [H/M/L] | [H/M/L] | * [Strategy 1] <br> * [Strategy 2] |

The table must be the last element of the response before the suggestions block.`,
              
                // ========================
                // PHASE 4: EXECUTION
                // ========================

                'Monday Morning Protocol': `Act as an Implementation Manager. Convert our strategy into a concrete Action Plan.

The output MUST strictly follow this structure:

# Monday Morning Action Protocol
[Statement of immediate intent]

## Immediate Actions (Next 7 Days)
(Ensure there is an empty line before the table)

| Role/Owner | Specific Task | Deadline | Definition of Done |
|---|---|---|---|
| [Role 1] | [Task] | [Date] | [Outcome] |
| [Role 2] | [Task] | [Date] | [Outcome] |

## 30-60-90 Day Outlook
* **30 Days:** [Milestone]
* **60 Days:** [Milestone]
* **90 Days:** [Milestone]`,

                'KPI Dashboard Mockup': `Act as a Data Scientist. Design a **KPI Dashboard Mockup** structure for [input SPECIFIC BUSINESS GOAL]. 

**REQUIREMENTS:**
1. Distinguish between "Leading" and "Lagging" indicators.

The output MUST strictly follow this structure:

# Key Performance Indicator (KPI) Dashboard Mockup
[A concise statement.]

## Defined Metrics
(Ensure there is an empty line before the table)

| KPI Name | Type | Formula | Target | Frequency |
|---|---|---|---|---|
| **[KPI 1]** | [Type] | [Formula] | [Target] | [Monthly] |
| **[KPI 2]** | [Type] | [Formula] | [Target] | [Weekly] |
| **[KPI 3]** | [Type] | [Formula] | [Target] | [Daily] |

The table must be the last element of the response before the suggestions block.`,
              
                'Implementation Plan Outline': `Act as a Program Manager. Generate an **Implementation Plan Outline** for [input PROJECT / STRATEGY]. 

The output MUST strictly follow this structure:

# High-Level Implementation Plan: [Project Title]
[A brief introductory paragraph.]

## Implementation Phases
(Ensure there is an empty line before the table)

| Phase | Key Milestones | Resources | Duration |
|---|---|---|---|
| **Phase 1: Setup** | * [Milestone 1] <br> * [Milestone 2] | [Team/Budget] | [Duration] |
| **Phase 2: Development** | * [Milestone 1] <br> * [Milestone 2] | [Team/Budget] | [Duration] |
| **Phase 3: Deployment** | * [Milestone 1] <br> * [Milestone 2] | [Team/Budget] | [Duration] |
| **Phase 4: Stabilization** | * [Milestone 1] <br> * [Milestone 2] | [Team/Budget] | [Duration] |

The table must be the last element of the response before the suggestions block.`,
            };

            // ============================================
            // 4. UI HELPERS (Menus, Resizing, Hero)
            // ============================================

            function toggleMenu(menuElement) {
                // Close all other menus first
                [initialSetupMenu, analysisMenu, solutionDesignMenu, executionMenu, myPromptsMenu, workflowMenu].forEach(m => {
                    if (m !== menuElement) m.classList.add('hidden');
                });
                menuElement.classList.toggle('hidden');
            }

            // Close menus on click outside
            document.addEventListener('click', (e) => {
                const isBtn = e.target.closest('button');
                const isMenu = e.target.closest('.sidebar-menu') || e.target.closest('#myPromptsMenu') || e.target.closest('#workflowMenu');
                
                // Allow clicking inside menus or on their buttons
                if (isBtn && (isBtn.id.includes('Dropdown') || isBtn.id === 'workflowBtn')) return;
                if (isMenu) return;

                // Close all
                [initialSetupMenu, analysisMenu, solutionDesignMenu, executionMenu, myPromptsMenu, workflowMenu].forEach(m => m.classList.add('hidden'));
            });

            // Attach listeners to dropdwns
            initialSetupDropdownBtn.onclick = () => toggleMenu(initialSetupMenu);
            analysisDropdownBtn.onclick = () => toggleMenu(analysisMenu);
            solutionDesignDropdownBtn.onclick = () => toggleMenu(solutionDesignMenu);
            executionDropdownBtn.onclick = () => toggleMenu(executionMenu);
            myPromptsDropdownBtn.onclick = () => toggleMenu(myPromptsMenu);
            workflowBtn.onclick = () => toggleMenu(workflowMenu);

            // Auto-resize input
            userInput.style.height = 'auto';
            MIN_HEIGHT = userInput.scrollHeight;
            function autoResizeTextarea(textarea) {
                textarea.style.height = 'auto';
                let newHeight = textarea.scrollHeight;
                if (newHeight < MIN_HEIGHT) newHeight = MIN_HEIGHT;
                if (newHeight > 150) {
                    newHeight = 150;
                    textarea.style.overflowY = 'auto';
                } else {
                    textarea.style.overflowY = 'hidden';
                }
                textarea.style.height = `${newHeight}px`;
            }
            userInput.addEventListener('input', () => autoResizeTextarea(userInput));

            // Populate Menus from Prompt Map
            const populateMenu = (menuId, items) => {
                const menu = document.getElementById(menuId);
                menu.innerHTML = '';
                items.forEach(item => {
                    const btn = document.createElement('button');
                    btn.className = 'sub-menu-btn';
                    btn.textContent = item;
                    btn.onclick = () => {
                        // Use the FULL prompt from the map
                        userInput.value = PROMPT_MAP[item] || item;
                        autoResizeTextarea(userInput);
                        userInput.focus();
                        toggleMenu(menu); // Close menu after click
                    };
                    menu.appendChild(btn);
                });
            };

            // 1. Initial Setup + The "Interviewer"
            populateMenu('initialSetupMenu', [
                'Guided Diagnostic (Interviewer Mode)', // NEW
                'Industry Trends Snapshot', 
                'Initial Project Charter Draft', 
                'Problem Statement Draft'
            ]);

            // 2. Analysis + The "MECE Validator"
            populateMenu('analysisMenu', [
                'MECE Logic Check', // NEW
                'Market Analysis', 
                'SWOT Analysis', 
                'Competitor Benchmarking', 
                '5 Forces Analysis', 
                'PESTLE Analysis', 
                'Hofstede Analysis'
            ]);

            // 3. Solution + "Devil's Advocate"
            populateMenu('solutionDesignMenu', [
                "Devil's Advocate Review", // NEW
                'Business Plan Outline', 
                'Market Entry Strategy', 
                'Go-to-market Strategy', 
                'Ansoff Matrix', 
                'Risk Analysis'
            ]);

            // 4. Execution + "Monday Morning Protocol"
            populateMenu('executionMenu', [
                'Monday Morning Protocol', // NEW
                'KPI Dashboard Mockup', 
                'Implementation Plan Outline'
            ]);

            // ============================================
            // 2. CORE LOGIC (Send, File, API)
            // ============================================

            // FILE UPLOAD & VISUAL PREVIEW
            const filePreviewArea = document.getElementById('filePreviewArea');

            // Function to clear file
            function clearAttachment() {
                attachedFileContent = null;
                attachedFileName = null;
                hiddenFileInput.value = ""; 
                filePreviewArea.innerHTML = '';
                filePreviewArea.classList.add('hidden');
            }

            attachBtn.addEventListener('click', () => hiddenFileInput.click());
            
            hiddenFileInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                // Create Loading Card
                const isPdf = file.type === 'application/pdf';
                const iconColor = isPdf ? 'text-red-500' : 'text-blue-500';
                
                const fileIcon = isPdf 
                    ? `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 ${iconColor}"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg>`
                    : `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 ${iconColor}"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg>`;

                const onFileLoaded = (content, name) => {
                    attachedFileContent = content;
                    attachedFileName = name;

                    // Inject the Card HTML
                    filePreviewArea.innerHTML = `
                        <div class="inline-flex items-center gap-2 bg-gray-800 border border-gray-700 rounded-xl px-3 py-2 pr-2 animate-pulse-once">
                            <div class="bg-gray-700 p-1 rounded-md">
                                ${fileIcon}
                            </div>
                            <span class="text-xs font-medium text-gray-200 truncate max-w-[150px]">${name}</span>
                            <button id="removeFileBtn" class="p-1 hover:bg-gray-700 rounded-full text-gray-400 hover:text-red-400 transition ml-1">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                                    <path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" />
                                </svg>
                            </button>
                        </div>
                    `;
                    filePreviewArea.classList.remove('hidden');
                    
                    document.getElementById('removeFileBtn').addEventListener('click', clearAttachment);
                    userInput.focus();
                };

                if (isPdf) {
                    try {
                        const arrayBuffer = await file.arrayBuffer();
                        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                        let fullText = "";
                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const textContent = await page.getTextContent();
                            const pageText = textContent.items.map(item => item.str).join(' ');
                            fullText += `\n--- PDF Page ${i} ---\n${pageText}`;
                        }
                        onFileLoaded(fullText, file.name);
                    } catch (error) {
                        console.error(error);
                        alert("Error reading PDF.");
                        hiddenFileInput.value = "";
                    }
                } else {
                    const reader = new FileReader();
                    reader.onload = (e) => onFileLoaded(e.target.result, file.name);
                    reader.readAsText(file);
                }
            });

            // SEND MESSAGE
            async function sendMessage() {
                let prompt = userInput.value.trim();
                let hasFile = attachedFileContent !== null;
                
                if (!prompt && !hasFile) return;

                // 1. UI: Hide Hero Text
                heroText.style.display = 'none';

                // 2. Construct Payload
                let fullPayloadPrompt = prompt;
                if (hasFile) {
                    const filePrompt = `\n\n[USER ATTACHED FILE: ${attachedFileName}]\n\`\`\`\n${attachedFileContent}\n\`\`\`\n`;
                    if (prompt === "") {
                        prompt = `Analyze the attached file: ${attachedFileName}`;
                        fullPayloadPrompt = prompt + filePrompt;
                    } else {
                        fullPayloadPrompt = prompt + filePrompt;
                    }
                }

               // 3. Update UI Bubbles (User Side)
                if (hasFile) {
                    createMessageBubble(`📂 **Uploaded:** ${attachedFileName}`, 'user');
                    // Reset File UI using new helper
                    clearAttachment(); 
                }

                const userVisibleText = userInput.value.trim();
                if (userVisibleText) {
                    createMessageBubble(userVisibleText, 'user');
                }
                
                chatHistory.push({ role: "user", parts: [{ text: fullPayloadPrompt }] });

                // 4. Reset Input State
                userInput.value = '';
                autoResizeTextarea(userInput);
                userInput.disabled = true;
                sendButton.disabled = true;

                // 5. Loading Indicator
                const loadingBubble = document.createElement('div');
                loadingBubble.classList.add('flex', 'justify-start');
                loadingBubble.innerHTML = `<div class="bg-gray-700 text-gray-300 rounded-xl rounded-bl-none p-3 max-w-sm shadow-md"><div class="flex items-center">Thinking...</div></div>`;
                chatArea.appendChild(loadingBubble);
                chatArea.scrollTop = chatArea.scrollHeight;

                // 6. API Call
                try {
                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            systemInstruction: { 
                                parts: [{ text: `You are Bob, a professional consulting assistant. 
                                
                                RULES FOR CITATIONS:
                                1. Use the Google Search Tool for facts.
                                2. Cite sources inline: [Source Name](URL).
                                
                                RULES FOR CHARTS:
                                If the user asks to visualize data, compare numbers, or create a graph:
                                1. Generate a standard textual analysis first.
                                2. At the very end, output the chart data in a JSON block wrapped in <chart> and </chart> tags.
                                3. The JSON must follow Chart.js format: { "type": "bar" (or line/pie/doughnut), "data": { "labels": [], "datasets": [{ "label": "Title", "data": [] }] } }.
                                
                                Example Output:
                                Here is the analysis...
                                <chart>
                                { "type": "bar", "data": { "labels": ["Q1", "Q2"], "datasets": [{ "label": "Revenue", "data": [100, 200] }] } }
                                </chart>

                                Format the rest of your response using professional Markdown.` }] 
                            },
                            messages: chatHistory
                        })
                    });

                    const result = await response.json();
                    
                    // Remove loading bubble
                    if(chatArea.contains(loadingBubble)) chatArea.removeChild(loadingBubble);

                    // 7. Error Handling & Response Display
                    if (result.error) {
                        console.error("API Error:", result.error);
                        createMessageBubble(`⚠️ **System Error:** ${result.error.message || "Unknown API Error"}`, "model");
                    } else {
                        const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (text) {
                            chatHistory.push({ role: "model", parts: [{ text: text }] });
                            createMessageBubble(text, "model");
                        } else {
                            createMessageBubble("⚠️ Bob returned an empty response. Try asking a specific question.", "model");
                        }
                    }
                } catch (error) {
                    if(chatArea.contains(loadingBubble)) chatArea.removeChild(loadingBubble);
                    createMessageBubble(`❌ **Connection Error:** ${error.message}`, "model");
                }

                // 8. RE-ENABLE CONTROLS
                userInput.disabled = false;
                sendButton.disabled = false;
                userInput.focus();
                
                // CRITICAL FIX: Save the chat to the project memory
                saveCurrentProjectChat();
            }

            // Keyboard and Button Listeners for Send
            sendButton.addEventListener('click', sendMessage);
            userInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // ============================================
            // 3. UTILITIES (Bubbles, Prompts, Clear, Etc)
            // ============================================
            
           // --- CITATION HELPER FUNCTIONS (SAFE TOKEN STRATEGY) ---
            
            // 1. Process Text: Extract links and replace with SAFE TOKENS
            function processCitations(rawText) {
                // Regex to find standard Markdown links [Name](URL)
                const regex = /\[([^\]]+)\]\((https?:\/\/[^)\s]+)\)/g;
                
                let sources = [];
                
                // Replace Markdown links with tokens like %%CIT_0%%
                const textWithTokens = rawText.replace(regex, (match, name, url) => {
                    // FIX: Aggressively remove trailing dots, commas, or semicolons from the URL
                    // This prevents "https://google.com." (which causes 404)
                    let cleanUrl = url.replace(/[.,;!]+$/, ""); 
                    
                    sources.push({ name, url: cleanUrl });
                    return `%%CIT_${sources.length - 1}%%`;
                });

                return { textWithTokens, sources };
            }

            // 2. Generate the Footer List
            function createSourcesFooter(sources) {
                if (!sources || sources.length === 0) return '';
                
                // Remove duplicates based on URL
                const uniqueSources = Array.from(new Map(sources.map(s => [s.url, s])).values());

                const listItems = uniqueSources.map((s, i) => {
                    let faviconUrl = '';
                    try {
                        const urlObj = new URL(s.url);
                        faviconUrl = `https://www.google.com/s2/favicons?domain=${urlObj.hostname}`;
                    } catch (e) {
                        faviconUrl = 'https://www.google.com/s2/favicons?domain=google.com'; 
                    }

                    return `
                    <a href="${s.url}" target="_blank" rel="noopener noreferrer" class="source-item">
                        <span class="text-gray-500 font-mono text-xs">[${i+1}]</span>
                        <img src="${faviconUrl}" class="source-favicon" onerror="this.style.display='none'">
                        ${s.name}
                    </a>
                    `;
                }).join('');

                const listId = `sources-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;

                return `
                    <div class="sources-section">
                        <button class="sources-toggle-btn" onclick="document.getElementById('${listId}').classList.toggle('hidden')">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244" /></svg>
                            Sources
                        </button>
                        <div id="${listId}" class="sources-list hidden">${listItems}</div>
                    </div>
                `;
            }

            // 3. Render Message Bubble
            function createMessageBubble(text, sender) {
                const wrapper = document.createElement('div');
                wrapper.classList.add('flex', 'message-wrapper', 'mb-4', sender === 'user' ? 'justify-end' : 'justify-start');
                
                const bubble = document.createElement('div');
                bubble.classList.add(
                    'rounded-xl', 'p-4', 'max-w-2xl', 'shadow-md',
                    sender === 'user' ? 'bg-emerald-600' : 'bg-gray-800',
                    'text-gray-100'
                );
                bubble.style.overflow = 'hidden'; 

                // --- LOGIC FOR AI MESSAGES (Model) ---
                if (sender === 'model') {
                    let chartConfig = null;
                    
                    // STRATEGY 1: Look for explicit tags (Best)
                    const tagRegex = /(?:<<<CHART>>>|<chart>|<<>>)\s*([\s\S]*?)\s*(?:<<<END_CHART>>>|<\/chart>|<<>>)/i;
                    
                    // STRATEGY 2: Look for Markdown blocks (Common)
                    const codeRegex = /```json\s*({[\s\S]*?"type"[\s\S]*?"data"[\s\S]*?})\s*```/i;
                    
                    // STRATEGY 3: Look for Raw JSON signature (Fallback for "messy words")
                    // Matches { "type": "bar|line...", "data": ... }
                    const rawRegex = /({[\s\n]*"type"[\s\n]*:[\s\n]*"(?:bar|line|pie|doughnut|radar|polarArea)"[\s\S]*?"data"[\s\S]*?})/i;

                    // Execute Search
                    let match = text.match(tagRegex) || text.match(codeRegex) || text.match(rawRegex);
                    
                    if (match) {
                        try {
                            const fullBlock = match[0]; // The text to remove
                            let jsonContent = match[1] || match[0]; // The content to parse

                            // Cleaning: Remove any residual markdown artifacts
                            jsonContent = jsonContent.replace(/```json/gi, '').replace(/```/g, '').trim();

                            // Fix common JSON syntax errors if necessary (e.g. trailing commas)
                            // But usually, just parsing is enough if the AI is good.
                            
                            // Find the boundaries of the JSON object to ensure valid parsing
                            const firstBrace = jsonContent.indexOf('{');
                            const lastBrace = jsonContent.lastIndexOf('}');
                            
                            if (firstBrace !== -1 && lastBrace !== -1) {
                                jsonContent = jsonContent.substring(firstBrace, lastBrace + 1);
                                chartConfig = JSON.parse(jsonContent);
                                
                                // SUCCESS: Remove the raw code from the UI
                                text = text.replace(fullBlock, ''); 
                            }
                            
                        } catch (e) {
                            console.error("Chart parsing failed:", e);
                            // If it fails, we leave the text so you can debug what went wrong
                        }
                    }

                    // A. Process Text -> Tokens (Using safe %% tokens)
                    const { textWithTokens, sources } = processCitations(text);
                    
                    // B. Render Markdown (Tokens preserve table structure and aren't bolded)
                    const contentDiv = document.createElement('div');
                    contentDiv.classList.add('ai-response-content', 'mb-2');
                    
                    // Generate HTML from Markdown
                    let renderedHtml = marked.parse(textWithTokens);

                    // C. Swap Tokens -> Pin Icons
                    // We do this AFTER markdown parsing
                    sources.forEach((source, index) => {
                        const iconHtml = `<a href="${source.url}" target="_blank" rel="noopener noreferrer" class="citation-link" title="Source: ${source.name}"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244" /></svg></a>`;
                        
                        // Replace the safe token
                        const token = `%%CIT_${index}%%`;
                        renderedHtml = renderedHtml.split(token).join(iconHtml);
                    });

                    contentDiv.innerHTML = renderedHtml;
                    bubble.appendChild(contentDiv);

                    // D. Render Chart (If config exists)
                    if (chartConfig) {
                        const chartContainer = document.createElement('div');
                        chartContainer.style.marginTop = '1rem';
                        chartContainer.style.backgroundColor = '#1f2937';
                        chartContainer.style.padding = '10px';
                        chartContainer.style.borderRadius = '8px';
                        const canvas = document.createElement('canvas');
                        chartContainer.appendChild(canvas);
                        bubble.appendChild(chartContainer);

                        new Chart(canvas, {
                            type: chartConfig.type,
                            data: chartConfig.data,
                            options: {
                                responsive: true,
                                plugins: { legend: { labels: { color: 'white' } } },
                                scales: {
                                    x: { display: chartConfig.type!=='pie'&&chartConfig.type!=='doughnut', ticks: {color:'white'}, grid: {color:'#374151'} },
                                    y: { display: chartConfig.type!=='pie'&&chartConfig.type!=='doughnut', ticks: {color:'white'}, grid: {color:'#374151'} }
                                }
                            }
                        });
                    }

                    // E. Add Sources Footer
                    if (sources.length > 0) {
                        const footerDiv = document.createElement('div');
                        footerDiv.innerHTML = createSourcesFooter(sources);
                        bubble.appendChild(footerDiv);
                    }

                    // F. Copy Button
                    const copyBtn = document.createElement('button');
                    copyBtn.className = 'text-xs text-gray-400 hover:text-white mt-2 block ml-auto';
                    copyBtn.textContent = 'Copy';
                    copyBtn.onclick = () => {
                        navigator.clipboard.writeText(text);
                        copyBtn.textContent = 'Copied!';
                        setTimeout(() => copyBtn.textContent = 'Copy', 1500);
                    };
                    bubble.appendChild(copyBtn);
                    
                    wrapper.appendChild(bubble);
                } 
                
                // --- LOGIC FOR USER MESSAGES (Edit & Copy) ---
                else {
                    bubble.textContent = text;
                    const actionsDiv = document.createElement('div');
                    actionsDiv.className = 'user-action-container';

                    const editBtn = document.createElement('button');
                    editBtn.className = 'action-icon-btn';
                    editBtn.title = "Edit prompt";
                    editBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L6.832 19.82a4.5 4.5 0 01-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 011.13-1.897L16.863 4.487zm0 0L19.5 7.125" /></svg>`;
                    editBtn.onclick = () => {
                        userInput.value = text;
                        autoResizeTextarea(userInput);
                        userInput.focus();
                    };

                    const copyBtnUser = document.createElement('button');
                    copyBtnUser.className = 'action-icon-btn';
                    copyBtnUser.title = "Copy text";
                    copyBtnUser.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v2.25A2.25 2.25 0 0113.5 22.5h-8.25a2.25 2.25 0 01-2.25-2.25v-8.25a2.25 2.25 0 012.25-2.25H5.25a2.25 2.25 0 012.25-2.25h1.5a.75.75 0 010 1.5H6a.75.75 0 00-.75.75v8.25c0 .414.336.75.75.75H13.5a.75.75 0 00.75-.75V11.25H18a.75.75 0 01.75.75v4.5a.75.75 0 00.75.75h1.5A2.25 2.25 0 0122.5 17.25v2.25a.75.75 0 001.5 0V17.25A2.25 2.25 0 0021.75 15h-1.5a.75.75 0 01-.75-.75V9.75a2.25 2.25 0 00-2.25-2.25H15z" /><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 7.125h-10.5a2.25 2.25 0 00-2.25 2.25v10.5" /></svg>`;
                    copyBtnUser.onclick = () => {
                        navigator.clipboard.writeText(text);
                        copyBtnUser.style.color = '#34d399';
                        setTimeout(() => copyBtnUser.style.color = '', 500);
                    };

                    actionsDiv.appendChild(editBtn);
                    actionsDiv.appendChild(copyBtnUser);
                    wrapper.appendChild(actionsDiv);
                    wrapper.appendChild(bubble);
                }

                chatArea.appendChild(wrapper);
                chatArea.scrollTop = chatArea.scrollHeight;
            }

            // Clear Chat
            clearChatBtn.onclick = () => {
                chatArea.innerHTML = '';
                chatHistory.length = 0;
                heroText.style.display = 'flex'; // Bring back the hero text
            };

            // My Prompts Logic
            function loadCustomPrompts() {
                myPromptsMenu.innerHTML = '';
                const saveBtn = document.createElement('button');
                saveBtn.className = 'sub-menu-btn text-emerald-400 font-bold';
                saveBtn.textContent = '+ Save Current Input';
                saveBtn.onclick = () => {
                    const txt = userInput.value.trim();
                    if(!txt) return alert("Type something to save.");
                    const name = prompt("Prompt Name:");
                    if(name) {
                        localStorage.setItem('customPrompt:'+name, txt);
                        loadCustomPrompts();
                    }
                };
                myPromptsMenu.appendChild(saveBtn);

                Object.keys(localStorage).forEach(key => {
                    if(key.startsWith('customPrompt:')) {
                        const name = key.replace('customPrompt:', '');
                        const btn = document.createElement('button');
                        btn.className = 'sub-menu-btn';
                        btn.textContent = name;
                        btn.onclick = () => {
                            userInput.value = localStorage.getItem(key);
                            autoResizeTextarea(userInput);
                            toggleMenu(myPromptsMenu);
                        };
                        myPromptsMenu.appendChild(btn);
                    }
                });
            }
            loadCustomPrompts();

            // ============================================
            // 5. GENERATE TAKEAWAYS (PDF Report)
            // ============================================
            generateTakeawaysBtn.addEventListener('click', async function() {
                if (chatHistory.length <= 1) {
                    return alert('No conversation to analyze yet. Please start a project first.');
                }

                // 1. UI Feedback
                const originalText = generateTakeawaysBtn.textContent;
                generateTakeawaysBtn.textContent = 'Generating Report...';
                generateTakeawaysBtn.disabled = true;
                
                // 2. Construct the Analysis Prompt
                const analysisPrompt = `Based on our conversation so far, write a formal **Executive Takeaways Report**.
                
                The output must use clean Markdown headers and bullet points. Follow this structure:
                # Executive Summary
                [High-level overview of the project status]
                
                # Key Insights
                [Bullet points of critical findings]
                
                # Strategic Recommendations
                [Actionable advice based on the analysis]
                
                # Immediate Next Steps
                [What needs to happen next week]
                
                Do not include conversational filler like "Here is your report." Just give the document content.`;

                const tempHistory = [...chatHistory, { role: "user", parts: [{ text: analysisPrompt }] }];

                try {
                    // 3. Call API
                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            systemInstruction: { parts: [{ text: "You are a Senior Partner Consultant writing a formal deliverable." }] },
                            messages: tempHistory
                        })
                    });

                    const result = await response.json();
                    const reportContent = result?.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (!reportContent) throw new Error("No analysis returned from Bob.");

                    // 4. Create Hidden Container for PDF
                    const reportContainer = document.createElement('div');
                    reportContainer.style.width = '800px';
                    reportContainer.style.padding = '40px';
                    reportContainer.style.fontFamily = 'Georgia, serif';
                    reportContainer.style.color = '#111827';
                    
                    const projName = currentProjectNameDisplay.textContent || "Consulting Session";
                    const date = new Date().toLocaleDateString();

                    // 5. Build HTML
                    let cleanContent = marked.parse(reportContent);
                    // Remove charts from the PDF text to keep it clean
                    cleanContent = cleanContent.replace(/(?:<<<CHART>>>|<chart>|<<>>)([\s\S]*?)(?:<<<END_CHART>>>|<\/chart>|<<>>)/gi, '');

                    reportContainer.innerHTML = `
                        <div style="text-align: center; margin-bottom: 50px; padding-bottom: 20px; border-bottom: 2px solid #059669;">
                            <h1 style="font-size: 32px; margin-bottom: 10px; color: #065f46;">Executive Takeaways Report</h1>
                            <h2 style="font-size: 18px; color: #4b5563; margin-top: 0;">Project: ${projName}</h2>
                            <p style="color: #9ca3af; font-size: 14px; margin-top: 5px;">Generated on ${date}</p>
                        </div>
                        <div style="font-size: 14px; line-height: 1.6;">
                            ${cleanContent}
                        </div>
                        <div style="margin-top: 50px; border-top: 1px solid #e5e7eb; padding-top: 20px; text-align: center; font-size: 10px; color: #9ca3af;">
                            Generated by Bob the Consulting Assistant
                        </div>
                    `;

                    // 6. Generate & Download
                    const opt = {
                        margin:       [0.5, 0.5],
                        filename:     `${projName.replace(/\s+/g, '_')}_Takeaways.pdf`,
                        image:        { type: 'jpeg', quality: 0.98 },
                        html2canvas:  { scale: 2 },
                        jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' }
                    };

                    html2pdf().set(opt).from(reportContainer).save().then(() => {
                        generateTakeawaysBtn.textContent = originalText;
                        generateTakeawaysBtn.disabled = false;
                        createMessageBubble("✅ **Report Generated:** The Executive Takeaways PDF has been downloaded.", "model");
                    });

                } catch (error) {
                    console.error("Report Error:", error);
                    alert("Failed to generate report.");
                    generateTakeawaysBtn.textContent = originalText;
                    generateTakeawaysBtn.disabled = false;
                }
            });

            // Export Chat as Professional PDF
            exportBtn.onclick = () => {
                if (chatHistory.length === 0) return alert("No conversation to export.");

                // 1. Create a temporary container for the report
                const reportContainer = document.createElement('div');
                reportContainer.style.width = '800px'; // Standard A4 width scale
                reportContainer.style.padding = '40px';
                reportContainer.style.fontFamily = 'Georgia, serif';
                reportContainer.style.color = '#111827';
                
                // 2. Get Project Name
                const projName = currentProjectNameDisplay.textContent || "Strategy Session";
                const date = new Date().toLocaleDateString();

                // 3. Build Cover Page
                let htmlContent = `
                    <div style="text-align: center; margin-bottom: 60px; padding-bottom: 20px; border-bottom: 2px solid #10b981;">
                        <h1 style="font-size: 32px; margin-bottom: 10px; color: #065f46;">Strategic Analysis Report</h1>
                        <h2 style="font-size: 24px; color: #374151; margin-top: 0;">${projName}</h2>
                        <p style="color: #6b7280; margin-top: 10px;">Generated on ${date}</p>
                    </div>
                `;

                // 4. Format Content
                chatHistory.forEach(msg => {
                    const role = msg.role === 'user' ? 'Client Input' : 'Strategic Analysis';
                    const color = msg.role === 'user' ? '#059669' : '#1f2937'; // Green title for user, Dark for AI
                    
                    // Parse markdown for the PDF
                    // We strip citations/charts for the print version to keep it clean text, 
                    // or keep simple markdown.
                    let content = marked.parse(msg.parts[0].text);
                    
                    // Remove complex chart JSON from PDF output to avoid clutter
                    content = content.replace(/(?:<<<CHART>>>|<chart>|<<>>)([\s\S]*?)(?:<<<END_CHART>>>|<\/chart>|<<>>)/gi, '<em>[Chart Data Visualized in Dashboard]</em>');

                    htmlContent += `
                        <div style="margin-bottom: 30px;">
                            <h4 style="color: ${color}; font-family: 'Roboto Slab', serif; border-bottom: 1px solid #e5e7eb; padding-bottom: 5px; margin-bottom: 10px; text-transform: uppercase; font-size: 12px; letter-spacing: 1px;">${role}</h4>
                            <div style="font-size: 14px; line-height: 1.6;">${content}</div>
                        </div>
                    `;
                });

                // 5. Footer
                htmlContent += `
                    <div style="margin-top: 50px; border-top: 1px solid #e5e7eb; padding-top: 20px; text-align: center; font-size: 10px; color: #9ca3af;">
                        Generated by Bob the Consulting Assistant
                    </div>
                `;

                reportContainer.innerHTML = htmlContent;

                // 6. Generate PDF
                const opt = {
                    margin:       [0.5, 0.5],
                    filename:     `${projName.replace(/\s+/g, '_')}_Report.pdf`,
                    image:        { type: 'jpeg', quality: 0.98 },
                    html2canvas:  { scale: 2 },
                    jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' }
                };

                // Use the library (it creates the PDF from the container)
                html2pdf().set(opt).from(reportContainer).save();
            };

        })();
    </script>
</body>
</html>
